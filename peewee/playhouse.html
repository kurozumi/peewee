

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Playhouse。Peeweeへの拡張 &mdash; peewee 2.10.2 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/modified_theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="検索" href="../search.html"/>
    <link rel="top" title="peewee 2.10.2 ドキュメント" href="../index.html"/>
        <link rel="next" title="APIリファレンス" href="api.html"/>
        <link rel="prev" title="トランザクション" href="transactions.html"/>
<meta name="google-site-verification" content="weS-iT6zr4B9g-sBuM2nD1EZBt55FPAZZbS1K5mkC0g" />


  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> peewee
          

          
          </a>

          
            
            
              <div class="version">
                2.10.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">インストールとテスト</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">クイックスタート</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html">サンプル・アプリケーション</a></li>
<li class="toctree-l1"><a class="reference internal" href="more-resources.html">その他のリソース</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">貢献する</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">データベースの管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">モデルとフィールド</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html">クエリ</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html#query-operators">クエリ演算子</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html#foreign-keys">外部キー</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html#performance-techniques">パフォーマンステクニック</a></li>
<li class="toctree-l1"><a class="reference internal" href="transactions.html">トランザクション</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Playhouse。Peeweeへの拡張</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sqlite-extensions">Sqlite拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sqlite-ext-api-notes">sqlite_ext API notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sqliteq">SqliteQ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#transactions">トランザクション</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-sample">Code sample</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sqlite-user-defined-functions">Sqliteユーザー定義関数</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#functions-listed-by-collection-name">Functions, listed by collection name</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#apsw-an-advanced-sqlite-driver">apsw、高度なsqliteドライバ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-use-the-apswdatabase">How to use the APSWDatabase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#apsw-ext-api-notes">apsw_ext API notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#berkeleydb-backend">BerkeleyDBバックエンド</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sqlcipher-backend">Sqlcipherバックエンド</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sqlcipher-ext-api-notes">sqlcipher_ext API notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#postgresql-extensions">PostgreSQLの拡張機能</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hstore-support">hstore support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-hstore">Using hstore</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interval-support">Interval support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#json-support">JSON Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#server-side-cursors">Server-side cursors</a></li>
<li class="toctree-l3"><a class="reference internal" href="#full-text-search">Full-text search</a></li>
<li class="toctree-l3"><a class="reference internal" href="#postgres-ext-api-notes">postgres_ext API notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dataset">データセット</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#getting-started">Getting started</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storing-data">データの保存</a></li>
<li class="toctree-l3"><a class="reference internal" href="#importing-data">Importing data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-transactions">Using transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inspecting-the-database">Inspecting the database</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-data">Reading data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exporting-data">Exporting data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#django-integration">Djangoの統合</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#foreign-keys-and-many-to-many-relationships">Foreign keys and Many-to-many relationships</a></li>
<li class="toctree-l3"><a class="reference internal" href="#djpeewee-api">djpeewee API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fields">フィールド</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generic-foreign-keys">一般的な外部キー</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-use-gfks">How to use GFKs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gfk-api">GFK API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#hybrid-attributes">ハイブリッド属性</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hybrid-api">Hybrid API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#key-value-store">キーバリューストア</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#keystore-api">KeyStore API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#shortcuts">ショートカット</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signal-support">シグナルサポート</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#connecting-handlers">Connecting handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#signal-api">Signal API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pwiz-a-model-generator">pwiz、モデルジェネレータ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#schema-migrations">スキーママイグレーション</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-usage">Example usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supported-operations">Supported Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migrations-api">Migrations API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#reflection">リフレクション</a></li>
<li class="toctree-l2"><a class="reference internal" href="#database-url">データベースのURL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#csv-utils">CSV Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#csv-loader-api">CSV Loader API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dumping-csv">Dumping CSV</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#connection-pool">コネクションプール</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pool-apis">Pool APIs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#read-slaves">スレーブを読み込む</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-utils">Test Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pskel">pskel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#flask-utils">Flask Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#database-wrapper">Database Wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-with-application-factory">Database with Application Factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-utilities">Query utilities</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">APIリファレンス</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacks.html">Hacks</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">peewee</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Playhouse。Peeweeへの拡張</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div class="note" style="text-align:center">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kurozumi.github.io/peewee/ 336*280 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:336px;height:280px"
     data-ad-client="ca-pub-6843356127740583"
     data-ad-slot="2268187197"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<div class="section" id="playhouse-extensions-to-peewee">
<span id="playhouse"></span><h1>Playhouse。Peeweeへの拡張<a class="headerlink" href="#playhouse-extensions-to-peewee" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>Peewee comes with numerous extension modules which are collected under the <code class="docutils literal"><span class="pre">playhouse</span></code> namespace. Despite the silly name, there are some very useful extensions, particularly those that expose vendor-specific database features like the <a class="reference internal" href="#sqlite-ext"><span class="std std-ref">Sqlite拡張</span></a> and <a class="reference internal" href="#postgres-ext"><span class="std std-ref">PostgreSQLの拡張機能</span></a> extensions.</p>
<p>Below you will find a loosely organized listing of the various modules that make up the <code class="docutils literal"><span class="pre">playhouse</span></code>.</p>
<p><strong>Database drivers / vendor-specific database functionality</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#sqlite-ext"><span class="std std-ref">Sqlite拡張</span></a></li>
<li><a class="reference internal" href="#sqliteq"><span class="std std-ref">SqliteQ</span></a></li>
<li><a class="reference internal" href="#sqlite-udf"><span class="std std-ref">Sqliteユーザー定義関数</span></a></li>
<li><a class="reference internal" href="#apsw"><span class="std std-ref">apsw、高度なsqliteドライバ</span></a></li>
<li><a class="reference internal" href="#berkeleydb"><span class="std std-ref">BerkeleyDBバックエンド</span></a></li>
<li><a class="reference internal" href="#sqlcipher-ext"><span class="std std-ref">Sqlcipherバックエンド</span></a></li>
<li><a class="reference internal" href="#postgres-ext"><span class="std std-ref">PostgreSQLの拡張機能</span></a></li>
</ul>
<p><strong>High-level features</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#extra-fields"><span class="std std-ref">フィールド</span></a></li>
<li><a class="reference internal" href="#shortcuts"><span class="std std-ref">ショートカット</span></a></li>
<li><a class="reference internal" href="#hybrid"><span class="std std-ref">ハイブリッド属性</span></a></li>
<li><a class="reference internal" href="#signals"><span class="std std-ref">シグナルサポート</span></a></li>
<li><a class="reference internal" href="#dataset"><span class="std std-ref">データセット</span></a></li>
<li><a class="reference internal" href="#kv"><span class="std std-ref">キーバリューストア</span></a></li>
<li><a class="reference internal" href="#gfk"><span class="std std-ref">一般的な外部キー</span></a></li>
<li><a class="reference internal" href="#csv-utils"><span class="std std-ref">CSV Utils</span></a></li>
</ul>
<p><strong>Database management and framework integration</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#pwiz"><span class="std std-ref">pwiz、モデルジェネレータ</span></a></li>
<li><a class="reference internal" href="#migrate"><span class="std std-ref">スキーママイグレーション</span></a></li>
<li><a class="reference internal" href="#pool"><span class="std std-ref">コネクションプール</span></a></li>
<li><a class="reference internal" href="#reflection"><span class="std std-ref">リフレクション</span></a></li>
<li><a class="reference internal" href="#db-url"><span class="std std-ref">データベースのURL</span></a></li>
<li><a class="reference internal" href="#read-slaves"><span class="std std-ref">スレーブを読み込む</span></a></li>
<li><a class="reference internal" href="#test-utils"><span class="std std-ref">Test Utils</span></a></li>
<li><a class="reference internal" href="#pskel"><span class="std std-ref">pskel</span></a></li>
<li><a class="reference internal" href="#flask-utils"><span class="std std-ref">Flask Utils</span></a></li>
<li><a class="reference internal" href="#djpeewee"><span class="std std-ref">Djangoの統合</span></a></li>
</ul>
<div class="section" id="sqlite-extensions">
<span id="sqlite-ext"></span><h2>Sqlite拡張<a class="headerlink" href="#sqlite-extensions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The SQLite extensions module provides support for some interesting sqlite-only
features:</p>
<ul class="simple">
<li>Define custom aggregates, collations and functions.</li>
<li>Support for FTS3/4 (sqlite full-text search) with <a class="reference internal" href="#sqlite-bm25"><span class="std std-ref">BM25 ranking</span></a>.</li>
<li>C extension providing fast implementations of ranking and other utility functions.</li>
<li>Support for the new FTS5 search extension.</li>
<li>Specify isolation level in transactions.</li>
<li>Support for virtual tables and SQLite C extensions.</li>
<li>Support for the <a class="reference external" href="http://charlesleifer.com/blog/querying-tree-structures-in-sqlite-using-python-and-the-transitive-closure-extension/">closure table</a> extension, which allows efficient querying of heirarchical tables.</li>
</ul>
<div class="section" id="sqlite-ext-api-notes">
<h3>sqlite_ext API notes<a class="headerlink" href="#sqlite-ext-api-notes" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="SqliteExtDatabase">
<em class="property">class </em><code class="descname">SqliteExtDatabase</code><span class="sig-paren">(</span><em>database</em>, <em>pragmas=()</em>, <em>c_extensions=True</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#SqliteExtDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>pragmas</strong> – A list or tuple of 2-tuples containing <code class="docutils literal"><span class="pre">PRAGMA</span></code> settings to configure on a per-connection basis.</li>
<li><strong>c_extensions</strong> (<em>bool</em>) – Boolean flag indicating whether to use the fast implementations of various SQLite user-defined functions. If Cython was installed when you built <code class="docutils literal"><span class="pre">peewee</span></code>, then these functions should be available. If not, Peewee will fall back to using the slower pure-Python functions.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Subclass of the <a class="reference internal" href="api.html#SqliteDatabase" title="SqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteDatabase</span></code></a> that provides some advanced features only offered by Sqlite.</p>
<ul class="simple">
<li>Register custom aggregates, collations and functions</li>
<li>Support for SQLite virtual tables and C extensions</li>
<li>Specify a row factory</li>
<li>Advanced transactions (specify isolation level)</li>
</ul>
<dl class="method">
<dt id="SqliteExtDatabase.aggregate">
<code class="descname">aggregate</code><span class="sig-paren">(</span><span class="optional">[</span><em>name=None</em><span class="optional">[</span>, <em>num_params=-1</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#SqliteExtDatabase.aggregate" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Class-decorator for registering custom aggregation functions.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>name</strong> – string name for the aggregate, defaults to the name of the class.</li>
<li><strong>num_params</strong> – integer representing number of parameters the aggregate function accepts. The default value, <code class="docutils literal"><span class="pre">-1</span></code>, indicates the aggregate can accept any number of parameters.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@db.aggregate</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like sum, except calculate the product of a series of numbers.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">*=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">product</span>

<span class="c1"># To use this aggregate:</span>
<span class="n">product</span> <span class="o">=</span> <span class="p">(</span><span class="n">Score</span>
           <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">Score</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
           <span class="o">.</span><span class="n">scalar</span><span class="p">())</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">unregister_aggregate(name):</code></dt>
<dd><p>Unregister the given aggregate function.</p>
</dd></dl>

<dl class="method">
<dt id="SqliteExtDatabase.collation">
<code class="descname">collation</code><span class="sig-paren">(</span><span class="optional">[</span><em>name</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#SqliteExtDatabase.collation" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Function decorator for registering a custom collation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>name</strong> – string name to use for this collation.</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@db.collation</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">collate_reverse</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="nb">cmp</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>

<span class="c1"># To use this collation:</span>
<span class="n">Book</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">collate_reverse</span><span class="o">.</span><span class="n">collation</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>
</pre></div>
</div>
<p>As you might have noticed, the original <code class="docutils literal"><span class="pre">collate_reverse</span></code> function
has a special attribute called <code class="docutils literal"><span class="pre">collation</span></code> attached to it.  This extra
attribute provides a shorthand way to generate the SQL necessary to use
our custom collation.</p>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">unregister_collation(name):</code></dt>
<dd><p>Unregister the given collation function.</p>
</dd></dl>

<dl class="method">
<dt id="SqliteExtDatabase.func">
<code class="descname">func</code><span class="sig-paren">(</span><span class="optional">[</span><em>name</em><span class="optional">[</span>, <em>num_params</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#SqliteExtDatabase.func" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Function decorator for registering user-defined functions.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>name</strong> – name to use for this function.</li>
<li><strong>num_params</strong> – number of parameters this function accepts.  If not
provided, peewee will introspect the function for you.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@db.func</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">title_case</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

<span class="c1"># Use in the select clause...</span>
<span class="n">titled_books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">title_case</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">title</span><span class="p">))</span>

<span class="nd">@db.func</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sha1</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c1"># Use in the where clause...</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="o">==</span> <span class="n">password_hash</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">unregister_function(name):</code></dt>
<dd><p>Unregister the given user-defiend function.</p>
</dd></dl>

<dl class="method">
<dt id="SqliteExtDatabase.load_extension">
<code class="descname">load_extension</code><span class="sig-paren">(</span><em>extension</em><span class="sig-paren">)</span><a class="headerlink" href="#SqliteExtDatabase.load_extension" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Load the given C extension. If a connection is currently open in the calling thread, then the extension will be loaded for that connection as well as all subsequent connections.</p>
<p>For example, if you’ve compiled the closure table extension and wish to use it in your application, you might write:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_app.db&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="s1">&#39;closure&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">unload_extension(name):</code></dt>
<dd><p>Unload the given SQLite extension.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="VirtualModel">
<em class="property">class </em><code class="descname">VirtualModel</code><a class="headerlink" href="#VirtualModel" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> that signifies the model operates using a
virtual table provided by a sqlite extension.</p>
<p>Creating a virtual model is easy, simply subclass <code class="docutils literal"><span class="pre">VirtualModel</span></code> and specify the extension module and any options:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyVirtualModel</span><span class="p">(</span><span class="n">VirtualModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>
        <span class="n">extension_module</span> <span class="o">=</span> <span class="s1">&#39;nextchar&#39;</span>
        <span class="n">extension_options</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
<dl class="attribute">
<dt>
<code class="descname">Meta.extension_module = 'name of sqlite extension'</code></dt>
<dd></dd></dl>

<dl class="attribute">
<dt>
<code class="descname">Meta.extension_options = {'tokenize': 'porter', etc}</code></dt>
<dd><p>SQLite virtual tables often support configuration via arbitrary key/value options which are included in the <code class="docutils literal"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> statement. To configure a virtual table, you can specify options like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SearchIndex</span><span class="p">(</span><span class="n">FTSModel</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">SearchField</span><span class="p">()</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">SearchField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">my_db</span>
        <span class="n">extension_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="s1">&#39;tokenize&#39;</span><span class="p">:</span> <span class="s1">&#39;porter&#39;</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<span class="target" id="sqlite-fts"></span><dl class="class">
<dt id="FTSModel">
<em class="property">class </em><code class="descname">FTSModel</code><a class="headerlink" href="#FTSModel" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Model class that provides support for Sqlite’s full-text search extension.
Models should be defined normally, however there are a couple caveats:</p>
<ul class="simple">
<li>Unique constraints, not null constraints, check constraints and foreign keys are not supported.</li>
<li>Indexes on fields and multi-column indexes are ignored completely</li>
<li>Sqlite will treat all column types as <code class="docutils literal"><span class="pre">TEXT</span></code> (although you
can store other data types, Sqlite will treat them as text).</li>
<li>FTS models contain a <code class="docutils literal"><span class="pre">docid</span></code> field which is automatically created and managed by SQLite (unless you choose to explicitly set it during model creation). Lookups on this column <strong>are performant</strong>.</li>
</ul>
<p><code class="docutils literal"><span class="pre">sqlite_ext</span></code> provides a <a class="reference internal" href="#SearchField" title="SearchField"><code class="xref py py-class docutils literal"><span class="pre">SearchField</span></code></a> field class which should be used on <code class="docutils literal"><span class="pre">FTSModel</span></code> implementations instead of the regular peewee field types. This will help prevent you accidentally creating invalid column constraints.</p>
<p>Because of the lack of secondary indexes, it usually makes sense to use the <code class="docutils literal"><span class="pre">docid</span></code> primary key as a pointer to a row in a regular table. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Document</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;documents&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>


<span class="k">class</span> <span class="nc">DocumentIndex</span><span class="p">(</span><span class="n">FTSModel</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">SearchField</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">SearchField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>
        <span class="c1"># Use the porter stemming algorithm to tokenize content.</span>
        <span class="n">extension_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tokenize&#39;</span><span class="p">:</span> <span class="s1">&#39;porter&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>To store a document in the document index, we will <code class="docutils literal"><span class="pre">INSERT</span></code> a row into the <code class="docutils literal"><span class="pre">DocumentIndex</span></code> table, manually setting the <code class="docutils literal"><span class="pre">docid</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">store_document</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
    <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">insert</span><span class="p">({</span>
        <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">docid</span><span class="p">:</span> <span class="n">document</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">title</span><span class="p">:</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">content</span><span class="p">:</span> <span class="n">document</span><span class="o">.</span><span class="n">content</span><span class="p">})</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>To perform a search and return ranked results, we can query the <code class="docutils literal"><span class="pre">Document</span></code> table and join on the <code class="docutils literal"><span class="pre">DocumentIndex</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">phrase</span><span class="p">):</span>
    <span class="c1"># Query the search index and join the corresponding Document</span>
    <span class="c1"># object on each search result.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Document</span>
            <span class="o">.</span><span class="n">select</span><span class="p">()</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">DocumentIndex</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Document</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">docid</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">phrase</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">bm25</span><span class="p">()))</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">All SQL queries on <code class="docutils literal"><span class="pre">FTSModel</span></code> classes will be slow <strong>except</strong> full-text searches and <code class="docutils literal"><span class="pre">docid</span></code> lookups.</p>
</div>
<p>Continued examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Use the &quot;match&quot; operation for FTS queries.</span>
<span class="n">matching_docs</span> <span class="o">=</span> <span class="p">(</span><span class="n">DocumentIndex</span>
                 <span class="o">.</span><span class="n">select</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;some query&#39;</span><span class="p">)))</span>

<span class="c1"># To sort by best match, use the custom &quot;rank&quot; function.</span>
<span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">DocumentIndex</span>
        <span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;some query&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">rank</span><span class="p">()))</span>

<span class="c1"># Or use the shortcut method:</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;some phrase&#39;</span><span class="p">)</span>

<span class="c1"># Peewee allows you to specify weights for columns.</span>
<span class="c1"># Matches in the title will be 2x more valuable than matches</span>
<span class="c1"># in the content field:</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="s1">&#39;some phrase&#39;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Examples using the BM25 ranking algorithm:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># you can also use the BM25 algorithm to rank documents:</span>
<span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">DocumentIndex</span>
        <span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;some query&#39;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">bm25</span><span class="p">()))</span>

<span class="c1"># There is a shortcut method for bm25 as well:</span>
<span class="n">best_bm25</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search_bm25</span><span class="p">(</span><span class="s1">&#39;some phrase&#39;</span><span class="p">)</span>

<span class="c1"># BM25 allows you to specify weights for columns.</span>
<span class="c1"># Matches in the title will be 2x more valuable than matches</span>
<span class="c1"># in the content field:</span>
<span class="n">best_bm25</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search_bm25</span><span class="p">(</span>
    <span class="s1">&#39;some phrase&#39;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the primary source of the content you are indexing exists in a separate table, you can save some disk space by instructing SQLite to not store an additional copy of the search index content. SQLite will still create the metadata and data-structures needed to perform searches on the content, but the content itself will not be stored in the search index.</p>
<p>To accomplish this, you can specify a table or column using the <code class="docutils literal"><span class="pre">content</span></code> option. The <a class="reference external" href="http://sqlite.org/fts3.html#section_6_2">FTS4 documentation</a> has more information.</p>
<p>Here is a short code snippet illustrating how to implement this with peewee:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>  <span class="c1"># we want to search this.</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">BlogIndex</span><span class="p">(</span><span class="n">FTSModel</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">SearchField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>
        <span class="n">extension_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">Blog</span><span class="o">.</span><span class="n">content</span><span class="p">}</span>

<span class="n">db</span><span class="o">.</span><span class="n">create_tables</span><span class="p">([</span><span class="n">Blog</span><span class="p">,</span> <span class="n">BlogIndex</span><span class="p">])</span>

<span class="c1"># Now, we can manage content in the FTSBlog.  To populate it with</span>
<span class="c1"># content:</span>
<span class="n">BlogIndex</span><span class="o">.</span><span class="n">rebuild</span><span class="p">()</span>

<span class="c1"># Optimize the index.</span>
<span class="n">BlogIndex</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">content</span></code> option accepts either a single <code class="xref py py-class docutils literal"><span class="pre">Field</span></code> or a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a>
and can reduce the amount of storage used.  However, content will need to be
manually moved to/from the associated <code class="docutils literal"><span class="pre">FTSModel</span></code>.</p>
<p><strong>FTSModel API methods:</strong></p>
<dl class="classmethod">
<dt id="FTSModel.create_table">
<em class="property">classmethod </em><code class="descname">create_table</code><span class="sig-paren">(</span><span class="optional">[</span><em>fail_silently=False</em><span class="optional">[</span>, <em>**options</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.create_table" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>fail_silently</strong> (<em>boolean</em>) – do not re-create if table already exists.</li>
<li><strong>options</strong> – options passed along when creating the table, e.g. <code class="docutils literal"><span class="pre">content</span></code>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="classmethod">
<dt id="FTSModel.match">
<em class="property">classmethod </em><code class="descname">match</code><span class="sig-paren">(</span><em>term</em><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.match" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Shorthand for generating a <code class="docutils literal"><span class="pre">MATCH</span></code> expression for the given term(s).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">DocumentIndex</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;search phrase&#39;</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="s1">&#39;match: &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">title</span>
</pre></div>
</div>
</dd></dl>

<dl class="classmethod">
<dt id="FTSModel.search">
<em class="property">classmethod </em><code class="descname">search</code><span class="sig-paren">(</span><em>term</em><span class="optional">[</span>, <em>weights=None</em><span class="optional">[</span>, <em>with_score=False</em><span class="optional">[</span>, <em>score_alias='score'</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.search" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Shorthand way of searching for a term and sorting results by the
quality of the match. This is equivalent to the <a class="reference internal" href="#FTSModel.rank" title="FTSModel.rank"><code class="xref py py-meth docutils literal"><span class="pre">rank()</span></code></a>
example code presented below.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>term</strong> (<em>str</em>) – Search term to use.</li>
<li><strong>weights</strong> – A list of weights for the columns, ordered with respect to the column’s position in the table. <strong>Or</strong>, a dictionary keyed by the field or field name and mapped to a value.</li>
<li><strong>with_score</strong> – Whether the score should be returned as part of the <code class="docutils literal"><span class="pre">SELECT</span></code> statement.</li>
<li><strong>score_alias</strong> (<em>str</em>) – Alias to use for the calculated rank score. This is the attribute you will use to access the score if <code class="docutils literal"><span class="pre">with_score=True</span></code>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Simple search.</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;search term&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span>

<span class="c1"># More complete example.</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="s1">&#39;search term&#39;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
    <span class="n">with_score</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">score_alias</span><span class="o">=</span><span class="s1">&#39;search_score&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">search_score</span>
</pre></div>
</div>
</dd></dl>

<dl class="classmethod">
<dt id="FTSModel.rank">
<em class="property">classmethod </em><code class="descname">rank</code><span class="sig-paren">(</span><span class="optional">[</span><em>col1_weight</em>, <em>col2_weight...coln_weight</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.rank" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Generate an expression that will calculate and return the quality of the search match. This <code class="docutils literal"><span class="pre">rank</span></code> can be used to sort the search results. The lower the <code class="docutils literal"><span class="pre">rank</span></code>, the better the match.</p>
<p>The <code class="docutils literal"><span class="pre">rank</span></code> function accepts optional parameters that allow you to specify weights for the various columns. If no weights are specified, all columns are considered of equal importance.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">DocumentIndex</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span>
             <span class="n">DocumentIndex</span><span class="p">,</span>
             <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;search phrase&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">rank</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">search_result</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">search_result</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">search_result</span><span class="o">.</span><span class="n">score</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="sqlite-bm25"></span><dl class="classmethod">
<dt id="FTSModel.search_bm25">
<em class="property">classmethod </em><code class="descname">search_bm25</code><span class="sig-paren">(</span><em>term</em><span class="optional">[</span>, <em>weights=None</em><span class="optional">[</span>, <em>with_score=False</em><span class="optional">[</span>, <em>score_alias='score'</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.search_bm25" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Shorthand way of searching for a term and sorting results by the
quality of the match, as determined by the BM25 algorithm. This is
equivalent to the <a class="reference internal" href="#FTSModel.bm25" title="FTSModel.bm25"><code class="xref py py-meth docutils literal"><span class="pre">bm25()</span></code></a> example code presented below.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>term</strong> (<em>str</em>) – Search term to use.</li>
<li><strong>weights</strong> – A list of weights for the columns, ordered with respect to the column’s position in the table. <strong>Or</strong>, a dictionary keyed by the field or field name and mapped to a value.</li>
<li><strong>with_score</strong> – Whether the score should be returned as part of the <code class="docutils literal"><span class="pre">SELECT</span></code> statement.</li>
<li><strong>score_alias</strong> (<em>str</em>) – Alias to use for the calculated rank score. This is the attribute you will use to access the score if <code class="docutils literal"><span class="pre">with_score=True</span></code>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Simple search.</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;search term&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span>

<span class="c1"># More complete example.</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="s1">&#39;search term&#39;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
    <span class="n">with_score</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">score_alias</span><span class="o">=</span><span class="s1">&#39;search_score&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">search_score</span>
</pre></div>
</div>
</dd></dl>

<dl class="classmethod">
<dt id="FTSModel.bm25">
<em class="property">classmethod </em><code class="descname">bm25</code><span class="sig-paren">(</span><span class="optional">[</span><em>col1_weight</em>, <em>col2_weight...coln_weight</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.bm25" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Generate an expression that will calculate and return the quality of the search match using the <a class="reference external" href="https://en.wikipedia.org/wiki/Okapi_BM25">BM25 algorithm</a>. This value can be used to sort the search results, and the lower the value the better the match.</p>
<p>The <code class="docutils literal"><span class="pre">bm25</span></code> function accepts optional parameters that allow you to specify weights for the various columns. If no weights are specified, all columns are considered of equal importance.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">DocumentIndex</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span>
             <span class="n">DocumentIndex</span><span class="p">,</span>
             <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">bm25</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;search phrase&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DocumentIndex</span><span class="o">.</span><span class="n">bm25</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">search_result</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">search_result</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">search_result</span><span class="o">.</span><span class="n">score</span>
</pre></div>
</div>
</dd></dl>

<dl class="classmethod">
<dt id="FTSModel.rebuild">
<em class="property">classmethod </em><code class="descname">rebuild</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.rebuild" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Rebuild the search index – this only works when the <code class="docutils literal"><span class="pre">content</span></code> option
was specified during table creation.</p>
</dd></dl>

<dl class="classmethod">
<dt id="FTSModel.optimize">
<em class="property">classmethod </em><code class="descname">optimize</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#FTSModel.optimize" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Optimize the search index.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="SearchField">
<em class="property">class </em><code class="descname">SearchField</code><span class="sig-paren">(</span><span class="optional">[</span><em>unindexed=False</em><span class="optional">[</span>, <em>db_column=None</em><span class="optional">[</span>, <em>coerce=None</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#SearchField" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>unindexed</strong> – Whether the contents of this field should be excluded from the full-text search index.</li>
<li><strong>db_column</strong> – Name of the underlying database column.</li>
<li><strong>coerce</strong> – Function used to convert the value from the database into the appropriate Python format.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="JSONField">
<em class="property">class </em><code class="descname">JSONField</code><a class="headerlink" href="#JSONField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Field class suitable for working with JSON stored and manipulated using the <a class="reference external" href="https://www.sqlite.org/json1.html">JSON1 extension</a>.</p>
<p>Most functions that operate on JSON fields take a <code class="docutils literal"><span class="pre">path</span></code> argument. The JSON documents specify that the path should begin with <code class="docutils literal"><span class="pre">'$'</span></code> followed by zero or more instances of <code class="docutils literal"><span class="pre">'.objectlabel'</span></code> or <code class="docutils literal"><span class="pre">'[arrayindex]'</span></code>. Peewee simplifies this by allowing you to omit the <code class="docutils literal"><span class="pre">'$'</span></code> character and just specify the path you need or <code class="docutils literal"><span class="pre">None</span></code> for an empty path:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">path=''</span></code> –&gt; <code class="docutils literal"><span class="pre">'$'</span></code></li>
<li><code class="docutils literal"><span class="pre">path='tags'</span></code> –&gt; <code class="docutils literal"><span class="pre">'$.tags'</span></code></li>
<li><code class="docutils literal"><span class="pre">path='[0][1].bar'</span></code> –&gt; <code class="docutils literal"><span class="pre">'$[0][1].bar'</span></code></li>
<li><code class="docutils literal"><span class="pre">path='metadata[0]'</span></code> –&gt; <code class="docutils literal"><span class="pre">'$.metadata[0]'</span></code></li>
<li><code class="docutils literal"><span class="pre">path='user.data.email'</span></code> –&gt; <code class="docutils literal"><span class="pre">'$.user.data.email'</span></code></li>
</ul>
<dl class="method">
<dt id="JSONField.length">
<code class="descname">length</code><span class="sig-paren">(</span><span class="optional">[</span><em>path=None</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.length" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return the number of items in a JSON array at the given path. If the path is omitted, then return the number of items in the top-level array.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jarraylen">SQLite documentation</a>.</p>
</dd></dl>

<dl class="method">
<dt id="JSONField.extract">
<code class="descname">extract</code><span class="sig-paren">(</span><em>path</em><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.extract" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return the value at the given path. If the value is a JSON object or array, it will be decoded into a <code class="docutils literal"><span class="pre">dict</span></code> or <code class="docutils literal"><span class="pre">list</span></code>. If the value is a scalar type, string or <code class="docutils literal"><span class="pre">null</span></code> then it will be returned as the appropriate Python type.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jex">SQLite documentation</a>.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># data looks like {&#39;post&#39;: {&#39;title&#39;: &#39;post 1&#39;, &#39;body&#39;: &#39;...&#39;}, ...}</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Post</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">json_extract</span><span class="p">(</span><span class="s1">&#39;post.title&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">tuples</span><span class="p">())</span>

<span class="c1"># Only the `title` value is extracted from the JSON data.</span>
<span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">title</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="JSONField.set">
<code class="descname">set</code><span class="sig-paren">(</span><em>path</em>, <em>value</em><span class="optional">[</span>, <em>path2</em>, <em>value2...</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.set" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Set values stored in the input JSON string using the given path/value pairs. The <code class="docutils literal"><span class="pre">set</span></code> function returns a <strong>new</strong> JSON string formed by updating the input JSON with the given path/value pairs.</p>
<p>If the path does not exist, it <strong>will</strong> be created.</p>
<p>Similarly, if the path does exist, it <strong>will</strong> be overwritten.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jset">SQLite documentation</a>.</p>
<p id="updating-json">例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">PostAlias</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="n">set_query</span> <span class="o">=</span> <span class="p">(</span><span class="n">PostAlias</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">PostAlias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                 <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;New title&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">],</span>
                 <span class="s1">&#39;totally.new.field&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="s1">&#39;status.published&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
             <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PostAlias</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Post</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

<span class="c1"># Update multiple fields at one time on the Post</span>
<span class="c1"># with the title &quot;Old title&quot;.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Post</span>
         <span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">set_query</span><span class="p">)</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Old title&#39;</span><span class="p">))</span>
<span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="n">post</span> <span class="o">=</span> <span class="p">(</span><span class="n">Post</span>
        <span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;New title&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">get</span><span class="p">())</span>

<span class="c1"># Our new data has been added, even nested objects that did not</span>
<span class="c1"># exist before. Any pre-existing data has also been preserved,</span>
<span class="c1"># provided it was not over-written.</span>
<span class="k">assert</span> <span class="n">post</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;New title&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">],</span>
    <span class="s1">&#39;totally&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;new&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;field: 3}},</span>
    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;published&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;draft&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
    <span class="s1">&#39;other-field&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;was&#39;</span><span class="p">,</span> <span class="s1">&#39;here&#39;</span><span class="p">,</span> <span class="s1">&#39;before&#39;</span><span class="p">],</span>
    <span class="s1">&#39;another-old-field&#39;</span><span class="p">:</span> <span class="s1">&#39;etc, etc&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="JSONField.insert">
<code class="descname">insert</code><span class="sig-paren">(</span><em>path</em>, <em>value</em><span class="optional">[</span>, <em>path2</em>, <em>value2...</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.insert" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Insert the given path/value pairs into the JSON string stored in the field. The <code class="docutils literal"><span class="pre">insert</span></code> function returns a <strong>new</strong> JSON string formed by updating the input JSON with the given path/value pairs.</p>
<p>If the path already exists, it will <strong>not</strong> be overwritten.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jins">SQLite documentation</a>.</p>
</dd></dl>

<dl class="method">
<dt id="JSONField.replace">
<code class="descname">replace</code><span class="sig-paren">(</span><em>path</em>, <em>value</em><span class="optional">[</span>, <em>path2</em>, <em>value2...</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.replace" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Replace values stored in the input JSON string using the given path/value pairs. The <code class="docutils literal"><span class="pre">replace</span></code> function returns a <strong>new</strong> JSON string formed by updating the input JSON with the given path/value pairs.</p>
<p>If the path does not exist, it will <strong>not</strong> be created.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jrepl">SQLite documentation</a>.</p>
</dd></dl>

<dl class="method">
<dt id="JSONField.remove">
<code class="descname">remove</code><span class="sig-paren">(</span><em>*paths</em><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.remove" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Remove values referenced by the given path(s). The <code class="docutils literal"><span class="pre">remove</span></code> function returns a <strong>new</strong> JSON string formed by removing the specified paths from the input JSON string.</p>
<p>The process for removing fields from a JSON column is similar to the way you <a class="reference internal" href="#JSONField.set" title="JSONField.set"><code class="xref py py-meth docutils literal"><span class="pre">set()</span></code></a> them. For a code example, see <a class="reference internal" href="#updating-json"><span class="std std-ref">updating JSON data</span></a>.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jrm">SQLite documentation</a>.</p>
</dd></dl>

<dl class="method">
<dt id="JSONField.json_type">
<code class="descname">json_type</code><span class="sig-paren">(</span><span class="optional">[</span><em>path=None</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.json_type" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return a string indicating the type of object stored in the field. You can optionally supply a path to specify a sub-item. The types of objects are:</p>
<ul class="simple">
<li>object</li>
<li>array</li>
<li>integer</li>
<li>real</li>
<li>true</li>
<li>false</li>
<li>text</li>
<li>null  &lt;– the string 「null」 means an actual NULL value</li>
<li>NULL  &lt;– an actual NULL value means the path was not found</li>
</ul>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jtype">SQLite documentation</a>.</p>
</dd></dl>

<dl class="method">
<dt id="JSONField.children">
<code class="descname">children</code><span class="sig-paren">(</span><span class="optional">[</span><em>path=None</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.children" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>The <code class="docutils literal"><span class="pre">children</span></code> function corresponds to <code class="docutils literal"><span class="pre">json_each</span></code>, a table-valued function that walks the JSON value provided and returns the immediate children of the top-level array or object. If a path is specified, then that path is treated as the top-most element.</p>
<p>The rows returned by calls to <code class="docutils literal"><span class="pre">children()</span></code> have the following attributes:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">key</span></code>: the key of the current element relative to its parent.</li>
<li><code class="docutils literal"><span class="pre">value</span></code>: the value of the current element.</li>
<li><code class="docutils literal"><span class="pre">type</span></code>: one of the data-types (see <a class="reference internal" href="#JSONField.json_type" title="JSONField.json_type"><code class="xref py py-meth docutils literal"><span class="pre">json_type()</span></code></a>).</li>
<li><code class="docutils literal"><span class="pre">atom</span></code>: the scalar value for primitive types, <code class="docutils literal"><span class="pre">NULL</span></code> for arrays and objects.</li>
<li><code class="docutils literal"><span class="pre">id</span></code>: a unique ID referencing the current node in the tree.</li>
<li><code class="docutils literal"><span class="pre">parent</span></code>: the ID of the containing node.</li>
<li><code class="docutils literal"><span class="pre">fullkey</span></code>: the full path describing the current element.</li>
<li><code class="docutils literal"><span class="pre">path</span></code>: the path to the container of the current row.</li>
</ul>
<p>For examples, see <a class="reference external" href="http://charlesleifer.com/blog/using-the-sqlite-json1-and-fts5-extensions-with-python/">my blog post on JSON1</a>.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jeach">SQLite documentation</a>.</p>
</dd></dl>

<dl class="method">
<dt id="JSONField.tree">
<code class="descname">tree</code><span class="sig-paren">(</span><span class="optional">[</span><em>path=None</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONField.tree" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>The <code class="docutils literal"><span class="pre">tree</span></code> function corresponds to <code class="docutils literal"><span class="pre">json_tree</span></code>, a table-valued function that walks the JSON value provided and recursively returns all descendants of the given root node. If a path is specified, then that path is treated as the root node element.</p>
<p>The rows returned by calls to <code class="docutils literal"><span class="pre">tree()</span></code> have the same attributes as rows returned by calls to <a class="reference internal" href="#JSONField.children" title="JSONField.children"><code class="xref py py-meth docutils literal"><span class="pre">children()</span></code></a>.</p>
<p>For examples, see <a class="reference external" href="http://charlesleifer.com/blog/using-the-sqlite-json1-and-fts5-extensions-with-python/">my blog post on JSON1</a>.</p>
<p><a class="reference external" href="https://www.sqlite.org/json1.html#jtree">SQLite documentation</a>.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="PrimaryKeyAutoIncrementField">
<em class="property">class </em><code class="descname">PrimaryKeyAutoIncrementField</code><a class="headerlink" href="#PrimaryKeyAutoIncrementField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="api.html#PrimaryKeyField" title="PrimaryKeyField"><code class="xref py py-class docutils literal"><span class="pre">PrimaryKeyField</span></code></a> that uses a monotonically-increasing value for the primary key. This differs from the default SQLite primary key, which simply uses the 「max + 1」 approach to determining the next ID.</p>
</dd></dl>

<dl class="class">
<dt id="RowIDField">
<em class="property">class </em><code class="descname">RowIDField</code><a class="headerlink" href="#RowIDField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="api.html#PrimaryKeyField" title="PrimaryKeyField"><code class="xref py py-class docutils literal"><span class="pre">PrimaryKeyField</span></code></a> that provides access to the underlying <code class="docutils literal"><span class="pre">rowid</span></code> field used internally by SQLite.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">When added to a Model, this field will act as the primary key. However, this field will not be included by default when selecting rows from the table.</p>
</div>
</dd></dl>

<dl class="class">
<dt id="DocIDField">
<em class="property">class </em><code class="descname">DocIDField</code><a class="headerlink" href="#DocIDField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="api.html#PrimaryKeyField" title="PrimaryKeyField"><code class="xref py py-class docutils literal"><span class="pre">PrimaryKeyField</span></code></a> that provides access to the underlying <code class="docutils literal"><span class="pre">docid</span></code> field used internally by SQLite’s FTS3/4 virtual tables.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">This field should not be created manually, as it is only needed on <code class="docutils literal"><span class="pre">FTSModel</span></code> classes, which include it already.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="match">
<code class="descname">match</code><span class="sig-paren">(</span><em>lhs</em>, <em>rhs</em><span class="sig-paren">)</span><a class="headerlink" href="#match" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Generate a SQLite <cite>MATCH</cite> expression for use in full-text searches.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Document</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">match</span><span class="p">(</span><span class="n">Document</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;search term&#39;</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="FTS5Model">
<em class="property">class </em><code class="descname">FTS5Model</code><a class="headerlink" href="#FTS5Model" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Model class that should be used to implement virtual tables using the FTS5 extension. Documentation on the FTS5 extension <a class="reference external" href="http://sqlite.org/fts5.html">can be found here</a>. This extension behaves very similarly to the FTS3 and FTS4 extensions, and the <code class="docutils literal"><span class="pre">FTS5Model</span></code> supports many of the same APIs as <a class="reference internal" href="#FTSModel" title="FTSModel"><code class="xref py py-class docutils literal"><span class="pre">FTSModel</span></code></a>.</p>
<p>The <code class="docutils literal"><span class="pre">FTS5</span></code> extension is more strict in enforcing that no column define any type or constraints. For this reason, only <a class="reference internal" href="#SearchField" title="SearchField"><code class="xref py py-class docutils literal"><span class="pre">SearchField</span></code></a> objects can be used with <code class="docutils literal"><span class="pre">FTS5Model</span></code> implementations.</p>
<p>Additionally, <code class="docutils literal"><span class="pre">FTS5</span></code> comes with a built-in implementation of the BM25 ranking function. Therefore, the <code class="docutils literal"><span class="pre">search</span></code> and <code class="docutils literal"><span class="pre">search_bm25</span></code> methods have been overridden to use the builtin ranking functions rather than user-defined functions.</p>
<dl class="classmethod">
<dt id="FTS5Model.fts5_installed">
<em class="property">classmethod </em><code class="descname">fts5_installed</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#FTS5Model.fts5_installed" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return a boolean indicating whether the FTS5 extension is installed. If it is not installed, an attempt will be made to load the extension.</p>
</dd></dl>

<dl class="classmethod">
<dt id="FTS5Model.search">
<em class="property">classmethod </em><code class="descname">search</code><span class="sig-paren">(</span><em>term</em><span class="optional">[</span>, <em>weights=None</em><span class="optional">[</span>, <em>with_score=False</em><span class="optional">[</span>, <em>score_alias='score'</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTS5Model.search" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Shorthand way of searching for a term and sorting results by the
quality of the match. This is equivalent to the built-in <code class="docutils literal"><span class="pre">rank</span></code> value provided by the <code class="docutils literal"><span class="pre">FTS5</span></code> extension.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>term</strong> (<em>str</em>) – Search term to use.</li>
<li><strong>weights</strong> – A list of weights for the columns, ordered with respect to the column’s position in the table. <strong>Or</strong>, a dictionary keyed by the field or field name and mapped to a value.</li>
<li><strong>with_score</strong> – Whether the score should be returned as part of the <code class="docutils literal"><span class="pre">SELECT</span></code> statement.</li>
<li><strong>score_alias</strong> (<em>str</em>) – Alias to use for the calculated rank score. This is the attribute you will use to access the score if <code class="docutils literal"><span class="pre">with_score=True</span></code>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Simple search.</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;search term&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span>

<span class="c1"># More complete example.</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">DocumentIndex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="s1">&#39;search term&#39;</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
    <span class="n">with_score</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">score_alias</span><span class="o">=</span><span class="s1">&#39;search_score&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">search_score</span>
</pre></div>
</div>
</dd></dl>

<dl class="classmethod">
<dt id="FTS5Model.search_bm25">
<em class="property">classmethod </em><code class="descname">search_bm25</code><span class="sig-paren">(</span><em>term</em><span class="optional">[</span>, <em>weights=None</em><span class="optional">[</span>, <em>with_score=False</em><span class="optional">[</span>, <em>score_alias='score'</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTS5Model.search_bm25" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>With FTS5, the <code class="docutils literal"><span class="pre">search_bm25</span></code> method is the same as the <a class="reference internal" href="#FTS5Model.search" title="FTS5Model.search"><code class="xref py py-meth docutils literal"><span class="pre">FTS5Model.search()</span></code></a> method.</p>
</dd></dl>

<dl class="classmethod">
<dt id="FTS5Model.VocabModel">
<em class="property">classmethod </em><code class="descname">VocabModel</code><span class="sig-paren">(</span><span class="optional">[</span><em>table_type='row'|'col'</em><span class="optional">[</span>, <em>table_name=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#FTS5Model.VocabModel" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table_type</strong> – Either <code class="docutils literal"><span class="pre">'row'</span></code> or <code class="docutils literal"><span class="pre">'col'</span></code>.</li>
<li><strong>table_name</strong> – Name for the vocab table. If not specified, will be 「fts5tablename_v」.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<span class="target" id="sqlite-closure"></span><dl class="function">
<dt id="ClosureTable">
<code class="descname">ClosureTable</code><span class="sig-paren">(</span><em>model_class</em><span class="optional">[</span>, <em>foreign_key=None</em><span class="optional">[</span>, <em>referencing_class=None</em>, <em>referencing_key=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#ClosureTable" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Factory function for creating a model class suitable for working with a <a class="reference external" href="http://www.sqlite.org/cgi/src/artifact/636024302cde41b2bf0c542f81c40c624cfb7012">transitive closure</a> table. Closure tables are <a class="reference internal" href="#VirtualModel" title="VirtualModel"><code class="xref py py-class docutils literal"><span class="pre">VirtualModel</span></code></a> subclasses that work with the transitive closure SQLite extension. These special tables are designed to make it easy to efficiently query heirarchical data. The SQLite extension manages an AVL tree behind-the-scenes, transparently updating the tree when your table changes and making it easy to perform common queries on heirarchical data.</p>
<p>To use the closure table extension in your project, you need:</p>
<ol class="arabic">
<li><p class="first">A copy of the SQLite extension. The source code can be found in the <a class="reference external" href="http://www.sqlite.org/cgi/src/artifact/636024302cde41b2bf0c542f81c40c624cfb7012">SQLite code repository</a> or by cloning <a class="reference external" href="https://gist.github.com/coleifer/7f3593c5c2a645913b92">this gist</a>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://gist.github.com/coleifer/7f3593c5c2a645913b92 closure
<span class="gp">$</span> <span class="nb">cd</span> closure/
</pre></div>
</div>
</li>
<li><p class="first">Compile the extension as a shared library, e.g.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> gcc -g -fPIC -shared closure.c -o closure.so
</pre></div>
</div>
</li>
<li><p class="first">Create a model for your hierarchical data. The only requirement here is that the model has an integer primary key and a self-referential foreign key. Any additional fields are fine.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># Required.</span>

<span class="c1"># Generate a model for the closure virtual table.</span>
<span class="n">CategoryClosure</span> <span class="o">=</span> <span class="n">ClosureTable</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>
</pre></div>
</div>
<p>The self-referentiality can also be achieved via an intermediate table (for a many-to-many relation).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">UserRelations</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">knows</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;_known_by&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">primary_key</span> <span class="o">=</span> <span class="n">CompositeKey</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;knows&#39;</span><span class="p">)</span> <span class="c1"># Alternatively, a unique index on both columns.</span>

<span class="c1"># Generate a model for the closure virtual table, specifying the UserRelations as the referencing table</span>
<span class="n">UserClosure</span> <span class="o">=</span> <span class="n">ClosureTable</span><span class="p">(</span>
    <span class="n">User</span><span class="p">,</span>
    <span class="n">referencing_class</span><span class="o">=</span><span class="n">UserRelations</span><span class="p">,</span>
    <span class="n">foreign_key</span><span class="o">=</span><span class="n">UserRelations</span><span class="o">.</span><span class="n">knows</span><span class="p">,</span>
    <span class="n">referencing_key</span><span class="o">=</span><span class="n">UserRelations</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">In your application code, make sure you load the extension when you instantiate your <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> object. This is done by passing the path to the shared library to the <a class="reference internal" href="#SqliteExtDatabase.load_extension" title="SqliteExtDatabase.load_extension"><code class="xref py py-meth docutils literal"><span class="pre">load_extension()</span></code></a> method.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_database.db&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="s1">&#39;/path/to/closure&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first simple">
<li><strong>model_class</strong> – The model class containing the nodes in the tree.</li>
<li><strong>foreign_key</strong> – The self-referential parent-node field on the model class. If not provided, peewee will introspect the model to find a suitable key.</li>
<li><strong>referencing_class</strong> – The intermediate table for a many-to-many relationship.</li>
<li><strong>referencing_key</strong> – For a many-to-many relationship: the originating side of the relation.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">戻り値:</th><td class="field-body"><p class="first last">Returns a <a class="reference internal" href="#VirtualModel" title="VirtualModel"><code class="xref py py-class docutils literal"><span class="pre">VirtualModel</span></code></a> for working with a closure table.</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">There are two caveats you should be aware of when using the <code class="docutils literal"><span class="pre">transitive_closure</span></code> extension. First, it requires that your <em>source model</em> have an integer primary key. Second, it is strongly recommended that you create an index on the self-referential foreign key.</p>
</div>
<p>Example code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_database.db&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="s1">&#39;/path/to/closure&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">ForiegnKeyField</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># Required.</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="n">CategoryClosure</span> <span class="o">=</span> <span class="n">ClosureTable</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>

<span class="c1"># Create the tables if they do not exist.</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_tables</span><span class="p">([</span><span class="n">Category</span><span class="p">,</span> <span class="n">CategoryClosure</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>It is now possible to perform interesting queries using the data from the closure table:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get all ancestors for a particular node.</span>
<span class="n">laptops</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Laptops&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">Closure</span><span class="o">.</span><span class="n">ancestors</span><span class="p">(</span><span class="n">laptops</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># Computer Hardware</span>
<span class="c1"># Computers</span>
<span class="c1"># Electronics</span>
<span class="c1"># All products</span>

<span class="c1"># Get all descendants for a particular node.</span>
<span class="n">hardware</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Computer Hardware&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">Closure</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">hardware</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># Laptops</span>
<span class="c1"># Desktops</span>
<span class="c1"># Hard-drives</span>
<span class="c1"># Monitors</span>
<span class="c1"># LCD Monitors</span>
<span class="c1"># LED Monitors</span>
</pre></div>
</div>
<p>The <code class="xref py py-class docutils literal"><span class="pre">VirtualTable</span></code> returned by this function contains a handful of interesting methods. The model will be a subclass of <a class="reference internal" href="#BaseClosureTable" title="BaseClosureTable"><code class="xref py py-class docutils literal"><span class="pre">BaseClosureTable</span></code></a>.</p>
<dl class="class">
<dt id="BaseClosureTable">
<em class="property">class </em><code class="descname">BaseClosureTable</code><a class="headerlink" href="#BaseClosureTable" title="この定義へのパーマリンク">¶</a></dt>
<dd><dl class="attribute">
<dt id="BaseClosureTable.id">
<code class="descname">id</code><a class="headerlink" href="#BaseClosureTable.id" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>A field for the primary key of the given node.</p>
</dd></dl>

<dl class="attribute">
<dt id="BaseClosureTable.depth">
<code class="descname">depth</code><a class="headerlink" href="#BaseClosureTable.depth" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>A field representing the relative depth of the given node.</p>
</dd></dl>

<dl class="attribute">
<dt id="BaseClosureTable.root">
<code class="descname">root</code><a class="headerlink" href="#BaseClosureTable.root" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>A field representing the relative root node.</p>
</dd></dl>

<dl class="method">
<dt id="BaseClosureTable.descendants">
<code class="descname">descendants</code><span class="sig-paren">(</span><em>node</em><span class="optional">[</span>, <em>depth=None</em><span class="optional">[</span>, <em>include_node=False</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#BaseClosureTable.descendants" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Retrieve all descendants of the given node. If a depth is specified, only nodes at that depth (relative to the given node) will be returned.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Electronics&#39;</span><span class="p">)</span>

<span class="c1"># Direct child categories.</span>
<span class="n">children</span> <span class="o">=</span> <span class="n">CategoryClosure</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Grand-child categories.</span>
<span class="n">children</span> <span class="o">=</span> <span class="n">CategoryClosure</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Descendants at all depths.</span>
<span class="n">all_descendants</span> <span class="o">=</span> <span class="n">CategoryClosure</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="BaseClosureTable.ancestors">
<code class="descname">ancestors</code><span class="sig-paren">(</span><em>node</em><span class="optional">[</span>, <em>depth=None</em><span class="optional">[</span>, <em>include_node=False</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#BaseClosureTable.ancestors" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Retrieve all ancestors of the given node. If a depth is specified, only nodes at that depth (relative to the given node) will be returned.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Laptops&#39;</span><span class="p">)</span>

<span class="c1"># All ancestors.</span>
<span class="n">all_ancestors</span> <span class="o">=</span> <span class="n">CategoryClosure</span><span class="o">.</span><span class="n">ancestors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="c1"># Grand-parent category.</span>
<span class="n">grandparent</span> <span class="o">=</span> <span class="n">CategoryClosure</span><span class="o">.</span><span class="n">ancestores</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="BaseClosureTable.siblings">
<code class="descname">siblings</code><span class="sig-paren">(</span><em>node</em><span class="optional">[</span>, <em>include_node=False</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#BaseClosureTable.siblings" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Retrieve all nodes that are children of the specified node’s parent.</p>
</dd></dl>

</dd></dl>

<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">For an in-depth discussion of the SQLite transitive closure extension, check out this blog post, <a class="reference external" href="http://charlesleifer.com/blog/querying-tree-structures-in-sqlite-using-python-and-the-transitive-closure-extension/">Querying Tree Structures in SQLite using Python and the Transitive Closure Extension</a>.</p>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="sqliteq">
<span id="id10"></span><h2>SqliteQ<a class="headerlink" href="#sqliteq" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">playhouse.sqliteq</span></code> module provides a subclass of
<a class="reference internal" href="#SqliteExtDatabase" title="SqliteExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteExtDatabase</span></code></a>, that will serialize concurrent writes to a
SQLite database. <code class="xref py py-class docutils literal"><span class="pre">SqliteQueueDatabase</span></code> can be used as a drop-in
replacement for the regular <a class="reference internal" href="api.html#SqliteDatabase" title="SqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteDatabase</span></code></a> if you want simple
<strong>read and write</strong> access to a SQLite database from <strong>multiple threads</strong>.</p>
<p>SQLite only allows one connection to write to the database at any given time.
As a result, if you have a multi-threaded application (like a web-server, for
example) that needs to write to the database, you may see occasional errors
when one or more of the threads attempting to write cannot acquire the lock.</p>
<p><code class="xref py py-class docutils literal"><span class="pre">SqliteQueueDatabase</span></code> is designed to simplify things by sending all
write queries through a single, long-lived connection. The benefit is that you
get the appearance of multiple threads writing to the database without
conflicts or timeouts. The downside, however, is that you cannot issue
write transactions that encompass multiple queries – all writes run in
autocommit mode, essentially.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">The module gets its name from the fact that all write queries get put into
a thread-safe queue. A single worker thread listens to the queue and
executes all queries that are sent to it.</p>
</div>
<div class="section" id="transactions">
<h3>トランザクション<a class="headerlink" href="#transactions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Because all queries are serialized and executed by a single worker thread, it
is possible for transactional SQL from separate threads to be executed
out-of-order. In the example below, the transaction started by thread 「B」 is
rolled back by thread 「A」 (with bad consequences!):</p>
<ul class="simple">
<li>Thread A: UPDATE transplants SET organ=』liver』, …;</li>
<li>Thread B: BEGIN TRANSACTION;</li>
<li>Thread B: UPDATE life_support_system SET timer += 60 …;</li>
<li>Thread A: ROLLBACK; – Oh no….</li>
</ul>
<p>Since there is a potential for queries from separate transactions to be
interleaved, the <code class="xref py py-meth docutils literal"><span class="pre">transaction()</span></code> and
<code class="xref py py-meth docutils literal"><span class="pre">atomic()</span></code> methods are disabled on <code class="xref py py-class docutils literal"><span class="pre">SqliteQueueDatabase</span></code>.</p>
<p>For cases when you wish to temporarily write to the database from a different
thread, you can use the <code class="xref py py-meth docutils literal"><span class="pre">pause()</span></code> and
<code class="xref py py-meth docutils literal"><span class="pre">unpause()</span></code> methods. These methods block the
caller until the writer thread is finished with its current workload. The
writer then disconnects and the caller takes over until <code class="docutils literal"><span class="pre">unpause</span></code> is called.</p>
<p>The <code class="xref py py-meth docutils literal"><span class="pre">stop()</span></code>, <code class="xref py py-meth docutils literal"><span class="pre">start()</span></code>,
and <code class="xref py py-meth docutils literal"><span class="pre">is_stopped()</span></code> methods can also be used to
control the writer thread.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">Take a look at SQLite’s <a class="reference external" href="https://www.sqlite.org/isolation.html">isolation</a>
documentation for more information about how SQLite handles concurrent
connections.</p>
</div>
</div>
<div class="section" id="code-sample">
<h3>Code sample<a class="headerlink" href="#code-sample" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Creating a database instance does not require any special handling. The
<code class="xref py py-class docutils literal"><span class="pre">SqliteQueueDatabase</span></code> accepts some special parameters which you
should be aware of, though. If you are using <a class="reference external" href="http://gevent.org">gevent</a>, you
must specify <code class="docutils literal"><span class="pre">use_gevent=True</span></code> when instantiating your database – this way
Peewee will know to use the appropriate objects for handling queueing, thread
creation, and locking.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.sqliteq</span> <span class="kn">import</span> <span class="n">SqliteQueueDatabase</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteQueueDatabase</span><span class="p">(</span>
    <span class="s1">&#39;my_app.db&#39;</span><span class="p">,</span>
    <span class="n">use_gevent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>  <span class="c1"># Use the standard library &quot;threading&quot; module.</span>
    <span class="n">autostart</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>  <span class="c1"># The worker thread now must be started manually.</span>
    <span class="n">queue_max_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>  <span class="c1"># Max. # of pending writes that can accumulate.</span>
    <span class="n">results_timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>  <span class="c1"># Max. time to wait for query to be executed.</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">autostart=False</span></code>, as in the above example, you will need to call
<code class="xref py py-meth docutils literal"><span class="pre">start()</span></code> to bring up the worker threads that will
do the actual write query execution.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@app.before_first_request</span>
<span class="k">def</span> <span class="nf">_start_worker_threads</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>If you plan on performing SELECT queries or generally wanting to access the
database, you will need to call <a class="reference internal" href="api.html#Database.connect" title="Database.connect"><code class="xref py py-meth docutils literal"><span class="pre">connect()</span></code></a> and
<a class="reference internal" href="api.html#Database.close" title="Database.close"><code class="xref py py-meth docutils literal"><span class="pre">close()</span></code></a> as you would with any other database instance.</p>
<p>When your application is ready to terminate, use the <code class="xref py py-meth docutils literal"><span class="pre">stop()</span></code>
method to shut down the worker thread. If there was a backlog of work, then
this method will block until all pending work is finished (though no new work
is allowed).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">atexit</span>

<span class="nd">@atexit.register</span>
<span class="k">def</span> <span class="nf">_stop_worker_threads</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>Lastly, the <code class="xref py py-meth docutils literal"><span class="pre">is_stopped()</span></code> method can be used to
determine whether the database writer is up and running.</p>
</div>
</div>
<div class="section" id="sqlite-user-defined-functions">
<span id="sqlite-udf"></span><h2>Sqliteユーザー定義関数<a class="headerlink" href="#sqlite-user-defined-functions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">sqlite_udf</span></code> playhouse module contains a number of user-defined functions, aggregates, and table-valued functions, which you may find useful. The functions are grouped in collections and you can register these user-defined extensions individually, by collection, or register everything.</p>
<p>Scalar functions are functions which take a number of parameters and return a single value. For example, converting a string to upper-case, or calculating the MD5 hex digest.</p>
<p>Aggregate functions are like scalar functions that operate on multiple rows of data, producing a single result. For example, calculating the sum of a list of integers, or finding the smallest value in a particular column.</p>
<p>Table-valued functions are simply functions that can return multiple rows of data. For example, a regular-expression search function that returns all the matches in a given string, or a function that accepts two dates and generates all the intervening days.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">To use table-valued functions, you will need to install the <code class="docutils literal"><span class="pre">vtfunc</span></code> module. The <code class="docutils literal"><span class="pre">vtfunc</span></code> module is available <a class="reference external" href="https://github.com/coleifer/sqlite-vtfunc">on GitHub</a> or can be installed using <code class="docutils literal"><span class="pre">pip</span></code>.</p>
</div>
<div class="section" id="functions-listed-by-collection-name">
<h3>Functions, listed by collection name<a class="headerlink" href="#functions-listed-by-collection-name" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Scalar functions are indicated by <code class="docutils literal"><span class="pre">(f)</span></code>, aggregate functions by <code class="docutils literal"><span class="pre">(a)</span></code>, and table-valued functions by <code class="docutils literal"><span class="pre">(t)</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">CONTROL_FLOW</span></code>
* <code class="xref py py-func docutils literal"><span class="pre">if_then_else()</span></code> (f)</li>
<li><code class="docutils literal"><span class="pre">DATE</span></code>
* <code class="xref py py-func docutils literal"><span class="pre">strip_tz()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">human_delta()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">mintdiff()</span></code> (a)
* <code class="xref py py-func docutils literal"><span class="pre">avgtdiff()</span></code> (a)
* <code class="xref py py-func docutils literal"><span class="pre">duration()</span></code> (a)
* <code class="xref py py-func docutils literal"><span class="pre">date_series()</span></code> (t)</li>
<li><code class="docutils literal"><span class="pre">FILE</span></code>
* <code class="xref py py-func docutils literal"><span class="pre">file_ext()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">file_read()</span></code> (f)</li>
<li><code class="docutils literal"><span class="pre">HELPER</span></code>
* <code class="xref py py-func docutils literal"><span class="pre">gzip()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">gunzip()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">hostname()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">toggle()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">setting()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">clear_toggles()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">clear_settings()</span></code> (f)</li>
<li><code class="docutils literal"><span class="pre">MATH</span></code>
* <code class="xref py py-func docutils literal"><span class="pre">randomrange()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">gauss_distribution()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">sqrt()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">tonumber()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">mode()</span></code> (a)
* <code class="xref py py-func docutils literal"><span class="pre">minrange()</span></code> (a)
* <code class="xref py py-func docutils literal"><span class="pre">avgrange()</span></code> (a)
* <code class="xref py py-func docutils literal"><span class="pre">range()</span></code> (a)
* <code class="xref py py-func docutils literal"><span class="pre">median()</span></code> (a) (requires cython)</li>
<li><code class="docutils literal"><span class="pre">STRING</span></code>
* <code class="xref py py-func docutils literal"><span class="pre">substr_count()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">strip_chars()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">md5()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">sha1()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">sha256()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">sha512()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">adler32()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">crc32()</span></code> (f)
* <code class="xref py py-func docutils literal"><span class="pre">damerau_levenshtein_dist()</span></code> (f) (requires cython)
* <code class="xref py py-func docutils literal"><span class="pre">levenshtein_dist()</span></code> (f) (requires cython)
* <code class="xref py py-func docutils literal"><span class="pre">str_dist()</span></code> (f) (requires cython)
* <code class="xref py py-func docutils literal"><span class="pre">regex_search()</span></code> (t)</li>
</ul>
</div>
</div>
<div class="section" id="apsw-an-advanced-sqlite-driver">
<span id="apsw"></span><h2>apsw、高度なsqliteドライバ<a class="headerlink" href="#apsw-an-advanced-sqlite-driver" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">apsw_ext</span></code> module contains a database class suitable for use with
the apsw sqlite driver.</p>
<p>APSW Project page: <a class="reference external" href="https://github.com/rogerbinns/apsw">https://github.com/rogerbinns/apsw</a></p>
<p>APSW is a really neat library that provides a thin wrapper on top of SQLite’s
C interface, making it possible to use all of SQLite’s advanced features.</p>
<p>Here are just a few reasons to use APSW, taken from the documentation:</p>
<ul class="simple">
<li>APSW gives all functionality of SQLite, including virtual tables, virtual
file system, blob i/o, backups and file control.</li>
<li>Connections can be shared across threads without any additional locking.</li>
<li>Transactions are managed explicitly by your code.</li>
<li>APSW can handle nested transactions.</li>
<li>Unicode is handled correctly.</li>
<li>APSW is faster.</li>
</ul>
<p>For more information on the differences between apsw and pysqlite,
check <a class="reference external" href="http://rogerbinns.github.io/apsw/">the apsw docs</a>.</p>
<div class="section" id="how-to-use-the-apswdatabase">
<h3>How to use the APSWDatabase<a class="headerlink" href="#how-to-use-the-apswdatabase" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">apsw_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">APSWDatabase</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">SomeModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="apsw-ext-api-notes">
<h3>apsw_ext API notes<a class="headerlink" href="#apsw-ext-api-notes" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#APSWDatabase" title="APSWDatabase"><code class="xref py py-class docutils literal"><span class="pre">APSWDatabase</span></code></a> extends the <a class="reference internal" href="#SqliteExtDatabase" title="SqliteExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteExtDatabase</span></code></a> and inherits its advanced features.</p>
<dl class="class">
<dt id="APSWDatabase">
<em class="property">class </em><code class="descname">APSWDatabase</code><span class="sig-paren">(</span><em>database</em>, <em>**connect_kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#APSWDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>database</strong> (<em>string</em>) – filename of sqlite database</li>
<li><strong>connect_kwargs</strong> – keyword arguments passed to apsw when opening a connection</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="APSWDatabase.register_module">
<code class="descname">register_module</code><span class="sig-paren">(</span><em>mod_name</em>, <em>mod_inst</em><span class="sig-paren">)</span><a class="headerlink" href="#APSWDatabase.register_module" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Provides a way of globally registering a module.  For more information,
see the <a class="reference external" href="http://rogerbinns.github.io/apsw/vtable.html">documentation on virtual tables</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>mod_name</strong> (<em>string</em>) – name to use for module</li>
<li><strong>mod_inst</strong> (<em>object</em>) – an object implementing the <a class="reference external" href="http://rogerbinns.github.io/apsw/vtable.html#vttable-class">Virtual Table</a> interface</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="APSWDatabase.unregister_module">
<code class="descname">unregister_module</code><span class="sig-paren">(</span><em>mod_name</em><span class="sig-paren">)</span><a class="headerlink" href="#APSWDatabase.unregister_module" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Unregister a module.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>mod_name</strong> (<em>string</em>) – name to use for module</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>Be sure to use the <code class="docutils literal"><span class="pre">Field</span></code> subclasses defined in the <code class="docutils literal"><span class="pre">apsw_ext</span></code>
module, as they will properly handle adapting the data types for storage.</p>
<p class="last">For example, instead of using <code class="docutils literal"><span class="pre">peewee.DateTimeField</span></code>, be sure you are importing
and using <code class="docutils literal"><span class="pre">playhouse.apsw_ext.DateTimeField</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="berkeleydb-backend">
<span id="berkeleydb"></span><h2>BerkeleyDBバックエンド<a class="headerlink" href="#berkeleydb-backend" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>BerkeleyDB provides a <a class="reference external" href="http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/overview/sql-160887.html">SQLite-compatible API</a>. BerkeleyDB’s SQL API has many advantages over SQLite:</p>
<ul class="simple">
<li>Higher transactions-per-second in multi-threaded environments.</li>
<li>Built-in replication and hot backup.</li>
<li>Fewer system calls, less resource utilization.</li>
<li>Multi-version concurrency control.</li>
</ul>
<p>For more details, Oracle has published a short <a class="reference external" href="http://www.oracle.com/technetwork/database/berkeleydb/learnmore/bdbvssqlite-wp-186779.pdf">technical overview</a>.</p>
<p>In order to use peewee with BerkeleyDB, you need to compile BerkeleyDB with the SQL API enabled. Then compile the Python SQLite driver against BerkeleyDB’s sqlite replacement.</p>
<p>Begin by downloading and compiling BerkeleyDB:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">wget http://download.oracle.com/berkeley-db/db-6.0.30.tar.gz</span>
<span class="go">tar xzf db-6.0.30.tar.gz</span>
<span class="go">cd db-6.0.30/build_unix</span>
<span class="go">export CFLAGS=&#39;-DSQLITE_ENABLE_FTS3=1 -DSQLITE_ENABLE_FTS3_PARENTHESIS=1 -DSQLITE_ENABLE_UPDATE_DELETE_LIMIT -DSQLITE_SECURE_DELETE -DSQLITE_SOUNDEX -DSQLITE_ENABLE_RTREE=1 -fPIC&#39;</span>
<span class="go">../dist/configure --enable-static --enable-shared --enable-sql --enable-sql-compat</span>
<span class="go">make</span>
<span class="go">sudo make prefix=/usr/local/ install</span>
</pre></div>
</div>
<p>Then get a copy of the standard library SQLite driver and build it against BerkeleyDB:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">git clone https://github.com/ghaering/pysqlite</span>
<span class="go">cd pysqlite</span>
<span class="go">sed -i &quot;s|#||g&quot; setup.cfg</span>
<span class="go">python setup.py build</span>
<span class="go">sudo python setup.py install</span>
</pre></div>
</div>
<p>You can also find up-to-date <a class="reference external" href="http://charlesleifer.com/blog/building-the-python-sqlite-driver-for-use-with-berkeleydb/">step by step instructions</a> on my blog.</p>
<dl class="class">
<dt id="BerkeleyDatabase">
<em class="property">class </em><code class="descname">BerkeleyDatabase</code><span class="sig-paren">(</span><em>database</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#BerkeleyDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>multiversion</strong> (<em>bool</em>) – Enable multiversion concurrency control. Default is <code class="docutils literal"><span class="pre">False</span></code>.</li>
<li><strong>page_size</strong> (<em>int</em>) – Set the page size <code class="docutils literal"><span class="pre">PRAGMA</span></code>. This option only works on new databases.</li>
<li><strong>cache_size</strong> (<em>int</em>) – Set the cache size <code class="docutils literal"><span class="pre">PRAGMA</span></code>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Subclass of the <a class="reference internal" href="#SqliteExtDatabase" title="SqliteExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteExtDatabase</span></code></a> that supports connecting to BerkeleyDB-backed version of SQLite.</p>
<dl class="classmethod">
<dt id="BerkeleyDatabase.check_pysqlite">
<em class="property">classmethod </em><code class="descname">check_pysqlite</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#BerkeleyDatabase.check_pysqlite" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Check whether <code class="docutils literal"><span class="pre">pysqlite2</span></code> was compiled against the BerkeleyDB SQLite. Returns <code class="docutils literal"><span class="pre">True</span></code> or <code class="docutils literal"><span class="pre">False</span></code>.</p>
</dd></dl>

<dl class="classmethod">
<dt id="BerkeleyDatabase.check_libsqlite">
<em class="property">classmethod </em><code class="descname">check_libsqlite</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#BerkeleyDatabase.check_libsqlite" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Check whether <code class="docutils literal"><span class="pre">libsqlite3</span></code> is the BerkeleyDB SQLite implementation. Returns <code class="docutils literal"><span class="pre">True</span></code> or <code class="docutils literal"><span class="pre">False</span></code>.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="sqlcipher-backend">
<span id="sqlcipher-ext"></span><h2>Sqlcipherバックエンド<a class="headerlink" href="#sqlcipher-backend" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li>Although this extention’s code is short, it has not been properly
peer-reviewed yet and may have introduced vulnerabilities.</li>
<li>The code contains minimum values for <cite>passphrase</cite> length and
<cite>kdf_iter</cite>, as well as a default value for the later.
<strong>Do not</strong> regard these numbers as advice. Consult the docs at
<a class="reference external" href="http://sqlcipher.net/sqlcipher-api/">http://sqlcipher.net/sqlcipher-api/</a> and security experts.</li>
</ul>
<p>Also note that this code relies on <a class="reference external" href="https://pypi.python.org/pypi/pysqlcipher">pysqlcipher</a> and <a class="reference external" href="http://sqlcipher.net">sqlcipher</a>, and
the code there might have vulnerabilities as well, but since these
are widely used crypto modules, we can expect 「short zero days」 there.</p>
<div class="section" id="sqlcipher-ext-api-notes">
<h3>sqlcipher_ext API notes<a class="headerlink" href="#sqlcipher-ext-api-notes" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="SqlCipherDatabase">
<em class="property">class </em><code class="descname">SqlCipherDatabase</code><span class="sig-paren">(</span><em>database</em>, <em>passphrase</em>, <em>kdf_iter=64000</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#SqlCipherDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="api.html#SqliteDatabase" title="SqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteDatabase</span></code></a> that stores the database
encrypted. Instead of the standard <code class="docutils literal"><span class="pre">sqlite3</span></code> backend, it uses <a class="reference external" href="https://pypi.python.org/pypi/pysqlcipher">pysqlcipher</a>:
a python wrapper for <a class="reference external" href="http://sqlcipher.net">sqlcipher</a>, which – in turn – is an encrypted wrapper
around <code class="docutils literal"><span class="pre">sqlite3</span></code>, so the API is <em>identical</em> to <a class="reference internal" href="api.html#SqliteDatabase" title="SqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteDatabase</span></code></a>’s,
except for object construction parameters:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>database</strong> – Path to encrypted database filename to open [or create].</li>
<li><strong>passphrase</strong> – Database encryption passphrase: should be at least 8 character
long (or an error is raised), but it is <em>strongly advised</em> to enforce better
<a class="reference external" href="https://en.wikipedia.org/wiki/Password_strength">passphrase strength</a> criteria in your implementation.</li>
<li><strong>kdf_iter</strong> – [Optional] number of <a class="reference external" href="https://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> iterations.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>If the <code class="docutils literal"><span class="pre">database</span></code> file doesn’t exist, it will be <em>created</em> with
encryption by a key derived from <code class="docutils literal"><span class="pre">passhprase</span></code> with <code class="docutils literal"><span class="pre">kdf_iter</span></code>
<a class="reference external" href="https://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> iterations.</li>
<li>When trying to open an existing database, <code class="docutils literal"><span class="pre">passhprase</span></code> and <code class="docutils literal"><span class="pre">kdf_iter</span></code>
should be <em>identical</em> to the ones used when it was created.</li>
</ul>
</dd></dl>

<p>Notes:</p>
<blockquote>
<div><ul>
<li><p class="first">[Hopefully] there’s no way to tell whether the passphrase is wrong
or the file is corrupt.
In both cases – <em>the first time we try to acces the database</em> – a
<code class="xref py py-class docutils literal"><span class="pre">DatabaseError</span></code> error is raised,
with the <em>exact</em> message: <code class="docutils literal"><span class="pre">&quot;file</span> <span class="pre">is</span> <span class="pre">encrypted</span> <span class="pre">or</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">a</span> <span class="pre">database&quot;</span></code>.</p>
<p>As mentioned above, this only happens when you <em>access</em> the databse,
so if you need to know <em>right away</em> whether the passphrase was correct,
you can trigger this check by calling [e.g.]
<a class="reference internal" href="api.html#Database.get_tables" title="Database.get_tables"><code class="xref py py-meth docutils literal"><span class="pre">get_tables()</span></code></a> (see example below).</p>
</li>
<li><p class="first">Most applications can expect failed attempts to open the database
(common case: prompting the user for <code class="docutils literal"><span class="pre">passphrase</span></code>), so
the database can’t be hardwired into the <code class="xref py py-class docutils literal"><span class="pre">Meta</span></code> of
model classes. To defer initialization, pass <cite>None</cite> in to the
database.</p>
</li>
</ul>
</div></blockquote>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">SqlCipherDatabase</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parent for all app&#39;s models&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="c1"># We won&#39;t have a valid db until user enters passhrase.</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="c1"># Derive our model subclasses</span>
<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">right_passphrase</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">right_passphrase</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="s1">&#39;testsqlcipher.db&#39;</span><span class="p">,</span>
        <span class="n">passphrase</span><span class="o">=</span><span class="n">get_passphrase_from_user</span><span class="p">())</span>

    <span class="k">try</span><span class="p">:</span>  <span class="c1"># Actually execute a query against the db to test passphrase.</span>
        <span class="n">db</span><span class="o">.</span><span class="n">get_tables</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="c1"># We only allow a specific [somewhat cryptic] error message.</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;file is encrypted or is not a database&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tell_user_the_passphrase_was_wrong</span><span class="p">()</span>
            <span class="n">db</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>  <span class="c1"># Reset the db.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The password was correct.</span>
        <span class="n">right_passphrase</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>See also: a slightly more elaborate <a class="reference external" href="https://gist.github.com/thedod/11048875#file-testpeeweesqlcipher-py">example</a>.</p>
</div>
</div>
<div class="section" id="postgresql-extensions">
<span id="postgres-ext"></span><h2>PostgreSQLの拡張機能<a class="headerlink" href="#postgresql-extensions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The postgresql extensions module provides a number of 「postgres-only」 functions,
currently:</p>
<ul class="simple">
<li><a class="reference internal" href="#hstore"><span class="std std-ref">hstore support</span></a></li>
<li><a class="reference internal" href="#pgjson"><span class="std std-ref">json support</span></a>, including <code class="docutils literal"><span class="pre">jsonb</span></code> for Postgres 9.4.</li>
<li><a class="reference internal" href="#server-side-cursors"><span class="std std-ref">server-side cursors</span></a></li>
<li><a class="reference internal" href="#pg-fts"><span class="std std-ref">full-text search</span></a></li>
<li><a class="reference internal" href="#ArrayField" title="ArrayField"><code class="xref py py-class docutils literal"><span class="pre">ArrayField</span></code></a> field type, for storing arrays.</li>
<li><a class="reference internal" href="#HStoreField" title="HStoreField"><code class="xref py py-class docutils literal"><span class="pre">HStoreField</span></code></a> field type, for storing key/value pairs.</li>
<li><a class="reference internal" href="#IntervalField" title="IntervalField"><code class="xref py py-class docutils literal"><span class="pre">IntervalField</span></code></a> field type, for storing <code class="docutils literal"><span class="pre">timedelta</span></code> objects.</li>
<li><a class="reference internal" href="#JSONField" title="JSONField"><code class="xref py py-class docutils literal"><span class="pre">JSONField</span></code></a> field type, for storing JSON data.</li>
<li><a class="reference internal" href="#BinaryJSONField" title="BinaryJSONField"><code class="xref py py-class docutils literal"><span class="pre">BinaryJSONField</span></code></a> field type for the <code class="docutils literal"><span class="pre">jsonb</span></code> JSON data type.</li>
<li><a class="reference internal" href="#TSVectorField" title="TSVectorField"><code class="xref py py-class docutils literal"><span class="pre">TSVectorField</span></code></a> field type, for storing full-text search data.</li>
<li><code class="xref py py-class docutils literal"><span class="pre">DateTimeTZ</span></code> field type, a timezone-aware datetime field.</li>
</ul>
<p>In the future I would like to add support for more of postgresql’s features.
If there is a particular feature you would like to see added, please
<a class="reference external" href="https://github.com/coleifer/peewee/issues">open a Github issue</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">In order to start using the features described below, you will need to use the extension <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a> class instead of <a class="reference internal" href="api.html#PostgresqlDatabase" title="PostgresqlDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlDatabase</span></code></a>.</p>
</div>
<p>The code below will assume you are using the following database and base model:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.postgres_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">ext_db</span> <span class="o">=</span> <span class="n">PostgresqlExtDatabase</span><span class="p">(</span><span class="s1">&#39;peewee_test&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseExtModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">ext_db</span>
</pre></div>
</div>
<div class="section" id="hstore-support">
<span id="hstore"></span><h3>hstore support<a class="headerlink" href="#hstore-support" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="http://www.postgresql.org/docs/current/static/hstore.html">Postgresql hstore</a> is
an embedded key/value store.  With hstore, you can store arbitrary key/value pairs
in your database alongside structured relational data.</p>
<p>Currently the <code class="docutils literal"><span class="pre">postgres_ext</span></code> module supports the following operations:</p>
<ul class="simple">
<li>Store and retrieve arbitrary dictionaries</li>
<li>Filter by key(s) or partial dictionary</li>
<li>Update/add one or more keys to an existing dictionary</li>
<li>Delete one or more keys from an existing dictionary</li>
<li>Select keys, values, or zip keys and values</li>
<li>Retrieve a slice of keys/values</li>
<li>Test for the existence of a key</li>
<li>Test that a key has a non-NULL value</li>
</ul>
</div>
<div class="section" id="using-hstore">
<h3>Using hstore<a class="headerlink" href="#using-hstore" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>To start with, you will need to import the custom database class and the hstore
functions from <code class="docutils literal"><span class="pre">playhouse.postgres_ext</span></code> (see above code snippet).  Then, it is
as simple as adding a <a class="reference internal" href="#HStoreField" title="HStoreField"><code class="xref py py-class docutils literal"><span class="pre">HStoreField</span></code></a> to your model:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">House</span><span class="p">(</span><span class="n">BaseExtModel</span><span class="p">):</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">HStoreField</span><span class="p">()</span>
</pre></div>
</div>
<p>You can now store arbitrary key/value pairs on <code class="docutils literal"><span class="pre">House</span></code> instances:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s1">&#39;123 Main St&#39;</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;garage&#39;</span><span class="p">:</span> <span class="s1">&#39;2 cars&#39;</span><span class="p">,</span> <span class="s1">&#39;bath&#39;</span><span class="p">:</span> <span class="s1">&#39;2 bath&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h_from_db</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">h</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h_from_db</span><span class="o">.</span><span class="n">features</span>
<span class="go">{&#39;bath&#39;: &#39;2 bath&#39;, &#39;garage&#39;: &#39;2 cars&#39;}</span>
</pre></div>
</div>
<p>You can filter by keys or partial dictionary:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">))</span> <span class="c1"># &lt;-- all houses w/garage key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;garage&#39;</span><span class="p">,</span> <span class="s1">&#39;bath&#39;</span><span class="p">]))</span> <span class="c1"># &lt;-- all houses w/garage &amp; bath</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">contains</span><span class="p">({</span><span class="s1">&#39;garage&#39;</span><span class="p">:</span> <span class="s1">&#39;2 cars&#39;</span><span class="p">}))</span> <span class="c1"># &lt;-- houses w/2-car garage</span>
</pre></div>
</div>
<p>Suppose you want to do an atomic update to the house:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_features</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;bath&#39;</span><span class="p">:</span> <span class="s1">&#39;2.5 bath&#39;</span><span class="p">,</span> <span class="s1">&#39;sqft&#39;</span><span class="p">:</span> <span class="s1">&#39;1100&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">new_features</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">h</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">h</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span><span class="o">.</span><span class="n">features</span>
<span class="go">{&#39;bath&#39;: &#39;2.5 bath&#39;, &#39;garage&#39;: &#39;2 cars&#39;, &#39;sqft&#39;: &#39;1100&#39;}</span>
</pre></div>
</div>
<p>Or, alternatively an atomic delete:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;bath&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">h</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">h</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h</span><span class="o">.</span><span class="n">features</span>
<span class="go">{&#39;garage&#39;: &#39;2 cars&#39;, &#39;sqft&#39;: &#39;1100&#39;}</span>
</pre></div>
</div>
<p>Multiple keys can be deleted at the same time:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">,</span> <span class="s1">&#39;sqft&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>You can select just keys, just values, or zip the two:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">keys</span>

<span class="go">123 Main St [u&#39;bath&#39;, u&#39;garage&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;vals&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">vals</span>

<span class="go">123 Main St [u&#39;2 bath&#39;, u&#39;2 cars&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;mtx&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">mtx</span>

<span class="go">123 Main St [[u&#39;bath&#39;, u&#39;2 bath&#39;], [u&#39;garage&#39;, u&#39;2 cars&#39;]]</span>
</pre></div>
</div>
<p>You can retrieve a slice of data, for example, all the garage data:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;garage_data&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">garage_data</span>

<span class="go">123 Main St {&#39;garage&#39;: &#39;2 cars&#39;}</span>
</pre></div>
</div>
<p>You can check for the existence of a key and filter rows accordingly:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;has_garage&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">has_garage</span>

<span class="go">123 Main St True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;garage&#39;</span><span class="p">]</span> <span class="c1"># &lt;-- just houses w/garage data</span>

<span class="go">123 Main St 2 cars</span>
</pre></div>
</div>
</div>
<div class="section" id="interval-support">
<h3>Interval support<a class="headerlink" href="#interval-support" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Postgres supports durations through the <code class="docutils literal"><span class="pre">INTERVAL</span></code> data-type (<a class="reference external" href="https://www.postgresql.org/docs/current/static/datatype-datetime.html">docs</a>).</p>
<dl class="class">
<dt id="IntervalField">
<em class="property">class </em><code class="descname">IntervalField</code><span class="sig-paren">(</span><span class="optional">[</span><em>null=False</em><span class="optional">[</span>, <em>...</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#IntervalField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Field class capable of storing Python <code class="docutils literal"><span class="pre">datetime.timedelta</span></code> instances.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">playhouse.postgres_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">PostgresqlExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_db&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">IntervalField</span><span class="p">()</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_long_meetings</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="json-support">
<span id="pgjson"></span><h3>JSON Support<a class="headerlink" href="#json-support" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>peewee has basic support for Postgres』 native JSON data type, in the form of
<a class="reference internal" href="#JSONField" title="JSONField"><code class="xref py py-class docutils literal"><span class="pre">JSONField</span></code></a>. As of version 2.4.7, peewee also supports the Postgres 9.4 binary json <code class="docutils literal"><span class="pre">jsonb</span></code> type, via <a class="reference internal" href="#BinaryJSONField" title="BinaryJSONField"><code class="xref py py-class docutils literal"><span class="pre">BinaryJSONField</span></code></a>.</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p>Postgres supports a JSON data type natively as of 9.2 (full support in 9.3). In
order to use this functionality you must be using the correct version of Postgres
with <cite>psycopg2</cite> version 2.5 or greater.</p>
<p class="last">To use <a class="reference internal" href="#BinaryJSONField" title="BinaryJSONField"><code class="xref py py-class docutils literal"><span class="pre">BinaryJSONField</span></code></a>, which has many performance and querying advantages, you must have Postgres 9.4 or later.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">You must be sure your database is an instance of <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a>
in order to use the <cite>JSONField</cite>.</p>
</div>
<p>Here is an example of how you might declare a model with a JSON field:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">from</span> <span class="nn">playhouse.postgres_ext</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">PostgresqlExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>  <span class="c1"># note</span>

<span class="k">class</span> <span class="nc">APIResponse</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

<span class="n">APIResponse</span><span class="o">.</span><span class="n">create_table</span><span class="p">()</span>

<span class="c1"># Store a JSON response.</span>
<span class="n">offense</span> <span class="o">=</span> <span class="n">APIResponse</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;http://wtf.charlesleifer.com/api/offense/&#39;</span><span class="p">)</span>
<span class="n">booking</span> <span class="o">=</span> <span class="n">APIResponse</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;http://wtf.charlesleifer.com/api/booking/&#39;</span><span class="p">)</span>

<span class="c1"># Query a JSON data structure using a nested key lookup:</span>
<span class="n">offense_responses</span> <span class="o">=</span> <span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
  <span class="n">APIResponse</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;offense&#39;</span><span class="p">)</span>

<span class="c1"># Retrieve a sub-key for each APIResponse. By calling .as_json(), the</span>
<span class="c1"># data at the sub-key will be returned as Python objects (dicts, lists,</span>
<span class="c1"># etc) instead of serialized JSON.</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">APIResponse</span>
     <span class="o">.</span><span class="n">select</span><span class="p">(</span>
       <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;booking&#39;</span><span class="p">][</span><span class="s1">&#39;person&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_json</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">))</span>
     <span class="o">.</span><span class="n">where</span><span class="p">(</span>
       <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;booking&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">result</span><span class="o">.</span><span class="n">person</span><span class="p">[</span><span class="s1">&#39;dob&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="#BinaryJSONField" title="BinaryJSONField"><code class="xref py py-class docutils literal"><span class="pre">BinaryJSONField</span></code></a> works the same and supports the same operations as the regular <a class="reference internal" href="#JSONField" title="JSONField"><code class="xref py py-class docutils literal"><span class="pre">JSONField</span></code></a>, but provides several additional operations for testing <em>containment</em>. Using the binary json field, you can test whether your JSON data contains other partial JSON structures (<a class="reference internal" href="#BinaryJSONField.contains" title="BinaryJSONField.contains"><code class="xref py py-meth docutils literal"><span class="pre">contains()</span></code></a>, <a class="reference internal" href="#BinaryJSONField.contains_any" title="BinaryJSONField.contains_any"><code class="xref py py-meth docutils literal"><span class="pre">contains_any()</span></code></a>, <a class="reference internal" href="#BinaryJSONField.contains_all" title="BinaryJSONField.contains_all"><code class="xref py py-meth docutils literal"><span class="pre">contains_all()</span></code></a>), or whether it is a subset of a larger JSON document (<a class="reference internal" href="#BinaryJSONField.contained_by" title="BinaryJSONField.contained_by"><code class="xref py py-meth docutils literal"><span class="pre">contained_by()</span></code></a>).</p>
<p>For more examples, see the <a class="reference internal" href="#JSONField" title="JSONField"><code class="xref py py-class docutils literal"><span class="pre">JSONField</span></code></a> and <a class="reference internal" href="#BinaryJSONField" title="BinaryJSONField"><code class="xref py py-class docutils literal"><span class="pre">BinaryJSONField</span></code></a> API documents below.</p>
</div>
<div class="section" id="server-side-cursors">
<span id="id11"></span><h3>Server-side cursors<a class="headerlink" href="#server-side-cursors" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>When psycopg2 executes a query, normally all results are fetched and returned to
the client by the backend.  This can cause your application to use a lot of memory
when making large queries.  Using server-side cursors, results are returned a
little at a time (by default 2000 records).  For the definitive reference, please see the <a class="reference external" href="http://initd.org/psycopg/docs/usage.html#server-side-cursors">psycopg2 documentation</a>.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">To use server-side (or named) cursors, you must be using <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a>.</p>
</div>
<p>To execute a query using a server-side cursor, simply wrap your select query
using the <a class="reference internal" href="#ServerSide" title="ServerSide"><code class="xref py py-func docutils literal"><span class="pre">ServerSide()</span></code></a> helper:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">large_query</span> <span class="o">=</span> <span class="n">PageView</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>  <span class="c1"># Build query normally.</span>

<span class="c1"># Iterate over large query inside a transaction.</span>
<span class="k">for</span> <span class="n">page_view</span> <span class="ow">in</span> <span class="n">ServerSide</span><span class="p">(</span><span class="n">large_query</span><span class="p">):</span>
    <span class="c1"># do some interesting analysis here.</span>
    <span class="k">pass</span>

<span class="c1"># Server-side resources are released.</span>
</pre></div>
</div>
<p>If you would like all <code class="docutils literal"><span class="pre">SELECT</span></code> queries to automatically use a server-side
cursor, you can specify this when creating your <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">postgres_ext</span> <span class="kn">import</span> <span class="n">PostgresqlExtDatabase</span>

<span class="n">ss_db</span> <span class="o">=</span> <span class="n">PostgresqlExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_db&#39;</span><span class="p">,</span> <span class="n">server_side_cursors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>Server-side cursors live only as long as the transaction, so for this reason
peewee will not automatically call <code class="docutils literal"><span class="pre">commit()</span></code> after executing a <code class="docutils literal"><span class="pre">SELECT</span></code>
query.  If you do not <code class="docutils literal"><span class="pre">commit</span></code> after you are done iterating, you will not
release the server-side resources until the connection is closed (or the
transaction is committed later).  Furthermore, since peewee will by default
cache rows returned by the cursor, you should always call <code class="docutils literal"><span class="pre">.iterator()</span></code>
when iterating over a large query.</p>
<p class="last">If you are using the <a class="reference internal" href="#ServerSide" title="ServerSide"><code class="xref py py-func docutils literal"><span class="pre">ServerSide()</span></code></a> helper, the transaction and
call to <code class="docutils literal"><span class="pre">iterator()</span></code> will be handled transparently.</p>
</div>
</div>
<div class="section" id="full-text-search">
<span id="pg-fts"></span><h3>Full-text search<a class="headerlink" href="#full-text-search" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Postgresql provides <a class="reference external" href="http://www.postgresql.org/docs/9.3/static/textsearch.html">sophisticated full-text search</a> using special data-types (<code class="docutils literal"><span class="pre">tsvector</span></code> and <code class="docutils literal"><span class="pre">tsquery</span></code>). Documents should be stored or converted to the <code class="docutils literal"><span class="pre">tsvector</span></code> type, and search queries should be converted to <code class="docutils literal"><span class="pre">tsquery</span></code>.</p>
<p>For simple cases, you can simply use the <a class="reference internal" href="#Match" title="Match"><code class="xref py py-func docutils literal"><span class="pre">Match()</span></code></a> function, which will automatically perform the appropriate conversions, and requires no schema changes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">blog_search</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Blog</span><span class="o">.</span><span class="n">STATUS_PUBLISHED</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="n">Match</span><span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="#Match" title="Match"><code class="xref py py-func docutils literal"><span class="pre">Match()</span></code></a> function will automatically convert the left-hand operand to a <code class="docutils literal"><span class="pre">tsvector</span></code>, and the right-hand operand to a <code class="docutils literal"><span class="pre">tsquery</span></code>. For better performance, it is recommended you create a <code class="docutils literal"><span class="pre">GIN</span></code> index on the column you plan to search:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">blog_full_text_search</span> <span class="k">ON</span> <span class="n">blog</span> <span class="k">USING</span> <span class="n">gin</span><span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="n">content</span><span class="p">));</span>
</pre></div>
</div>
<p>Alternatively, you can use the <a class="reference internal" href="#TSVectorField" title="TSVectorField"><code class="xref py py-class docutils literal"><span class="pre">TSVectorField</span></code></a> to maintain a dedicated column for storing <code class="docutils literal"><span class="pre">tsvector</span></code> data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">search_content</span> <span class="o">=</span> <span class="n">TSVectorField</span><span class="p">()</span>
</pre></div>
</div>
<p>You will need to explicitly convert the incoming text data to <code class="docutils literal"><span class="pre">tsvector</span></code> when inserting or updating the <code class="docutils literal"><span class="pre">search_content</span></code> field:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;Excellent blog post about peewee ORM.&#39;</span>
<span class="n">blog_entry</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
    <span class="n">search_content</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">to_tsvector</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">If you are using the <a class="reference internal" href="#TSVectorField" title="TSVectorField"><code class="xref py py-class docutils literal"><span class="pre">TSVectorField</span></code></a>, it will automatically be created with a GIN index.</p>
</div>
</div>
<div class="section" id="postgres-ext-api-notes">
<h3>postgres_ext API notes<a class="headerlink" href="#postgres-ext-api-notes" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="PostgresqlExtDatabase">
<em class="property">class </em><code class="descname">PostgresqlExtDatabase</code><span class="sig-paren">(</span><em>database</em><span class="optional">[</span>, <em>server_side_cursors=False</em><span class="optional">[</span>, <em>register_hstore=True</em><span class="optional">[</span>, <em>...</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#PostgresqlExtDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Identical to <a class="reference internal" href="api.html#PostgresqlDatabase" title="PostgresqlDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlDatabase</span></code></a> but required in order to support:</p>
<ul class="simple">
<li><a class="reference internal" href="#server-side-cursors"><span class="std std-ref">Server-side cursors</span></a></li>
<li><a class="reference internal" href="#ArrayField" title="ArrayField"><code class="xref py py-class docutils literal"><span class="pre">ArrayField</span></code></a></li>
<li><a class="reference internal" href="#DateTimeTZField" title="DateTimeTZField"><code class="xref py py-class docutils literal"><span class="pre">DateTimeTZField</span></code></a></li>
<li><a class="reference internal" href="#JSONField" title="JSONField"><code class="xref py py-class docutils literal"><span class="pre">JSONField</span></code></a></li>
<li><a class="reference internal" href="#BinaryJSONField" title="BinaryJSONField"><code class="xref py py-class docutils literal"><span class="pre">BinaryJSONField</span></code></a></li>
<li><a class="reference internal" href="#HStoreField" title="HStoreField"><code class="xref py py-class docutils literal"><span class="pre">HStoreField</span></code></a></li>
<li><a class="reference internal" href="#TSVectorField" title="TSVectorField"><code class="xref py py-class docutils literal"><span class="pre">TSVectorField</span></code></a></li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>database</strong> (<em>str</em>) – Name of database to connect to.</li>
<li><strong>server_side_cursors</strong> (<em>bool</em>) – Whether <code class="docutils literal"><span class="pre">SELECT</span></code> queries should utilize
server-side cursors.</li>
<li><strong>register_hstore</strong> (<em>bool</em>) – Register the HStore extension with the connection.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>If using <code class="docutils literal"><span class="pre">server_side_cursors</span></code>, also be sure to wrap your queries with
<a class="reference internal" href="#ServerSide" title="ServerSide"><code class="xref py py-func docutils literal"><span class="pre">ServerSide()</span></code></a>.</p>
<p>If you do not wish to use the HStore extension, you can specify <code class="docutils literal"><span class="pre">register_hstore=False</span></code>.</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">The <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a> by default will attempt to register the <code class="docutils literal"><span class="pre">HSTORE</span></code> extension. Most distributions and recent versions include this, but in some cases the extension may not be available. If you <strong>do not</strong> plan to use the <a class="reference internal" href="#hstore"><span class="std std-ref">HStore features of peewee</span></a>, you can pass <code class="docutils literal"><span class="pre">register_hstore=False</span></code> when initializing your <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a>.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="ServerSide">
<code class="descname">ServerSide</code><span class="sig-paren">(</span><em>select_query</em><span class="sig-paren">)</span><a class="headerlink" href="#ServerSide" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Wrap the given select query in a transaction, and call it’s <a class="reference internal" href="api.html#SelectQuery.iterator" title="SelectQuery.iterator"><code class="xref py py-meth docutils literal"><span class="pre">iterator()</span></code></a>
method to avoid caching row instances.  In order for the server-side resources
to be released, be sure to exhaust the generator (iterate over all the rows).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>select_query</strong> – a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> instance.</td>
</tr>
<tr class="field-even field"><th class="field-name">戻り値の型:</th><td class="field-body"><code class="docutils literal"><span class="pre">generator</span></code></td>
</tr>
</tbody>
</table>
<p>Usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">large_query</span> <span class="o">=</span> <span class="n">PageView</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="k">for</span> <span class="n">page_view</span> <span class="ow">in</span> <span class="n">ServerSide</span><span class="p">(</span><span class="n">large_query</span><span class="p">):</span>
    <span class="c1"># Do something interesting.</span>
    <span class="k">pass</span>

<span class="c1"># At this point server side resources are released.</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="pgarrays"></span><dl class="class">
<dt id="ArrayField">
<em class="property">class </em><code class="descname">ArrayField</code><span class="sig-paren">(</span><span class="optional">[</span><em>field_class=IntegerField</em><span class="optional">[</span>, <em>dimensions=1</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#ArrayField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Field capable of storing arrays of the provided <cite>field_class</cite>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>field_class</strong> – a subclass of <code class="xref py py-class docutils literal"><span class="pre">Field</span></code>, e.g. <a class="reference internal" href="api.html#IntegerField" title="IntegerField"><code class="xref py py-class docutils literal"><span class="pre">IntegerField</span></code></a>.</li>
<li><strong>dimensions</strong> (<em>int</em>) – dimensions of array.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>You can store and retrieve lists (or lists-of-lists):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BlogPost</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">ArrayField</span><span class="p">(</span><span class="n">CharField</span><span class="p">)</span>


<span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;awesome&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Additionally, you can use the <code class="docutils literal"><span class="pre">__getitem__</span></code> API to query values or slices
in the database:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get the first tag on a given blog post.</span>
<span class="n">first_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogPost</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">BlogPost</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;first_tag&#39;</span><span class="p">))</span>
             <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BlogPost</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
             <span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
             <span class="o">.</span><span class="n">get</span><span class="p">())</span>

<span class="c1"># first_tag = {&#39;first_tag&#39;: &#39;foo&#39;}</span>
</pre></div>
</div>
<p>Get a slice of values:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get the first two tags.</span>
<span class="n">two_tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">BlogPost</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">BlogPost</span><span class="o">.</span><span class="n">tags</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;two&#39;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">get</span><span class="p">())</span>
<span class="c1"># two_tags = {&#39;two&#39;: [&#39;foo&#39;, &#39;bar&#39;]}</span>
</pre></div>
</div>
<dl class="method">
<dt id="ArrayField.contains">
<code class="descname">contains</code><span class="sig-paren">(</span><em>*items</em><span class="sig-paren">)</span><a class="headerlink" href="#ArrayField.contains" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>items</strong> – One or more items that must be in the given array field.</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get all blog posts that are tagged with both &quot;python&quot; and &quot;django&quot;.</span>
<span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="s1">&#39;django&#39;</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="ArrayField.contains_any">
<code class="descname">contains_any</code><span class="sig-paren">(</span><em>*items</em><span class="sig-paren">)</span><a class="headerlink" href="#ArrayField.contains_any" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>items</strong> – One or more items to search for in the given array field.</td>
</tr>
</tbody>
</table>
<p>Like <a class="reference internal" href="#ArrayField.contains" title="ArrayField.contains"><code class="xref py py-meth docutils literal"><span class="pre">contains()</span></code></a>, except will match rows where the
array contains <em>any</em> of the given items.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get all blog posts that are tagged with &quot;flask&quot; and/or &quot;django&quot;.</span>
<span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">contains_any</span><span class="p">(</span><span class="s1">&#39;flask&#39;</span><span class="p">,</span> <span class="s1">&#39;django&#39;</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="DateTimeTZField">
<em class="property">class </em><code class="descname">DateTimeTZField</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#DateTimeTZField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>A timezone-aware subclass of <a class="reference internal" href="api.html#DateTimeField" title="DateTimeField"><code class="xref py py-class docutils literal"><span class="pre">DateTimeField</span></code></a>.</p>
</dd></dl>

<dl class="class">
<dt id="HStoreField">
<em class="property">class </em><code class="descname">HStoreField</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>A field for storing and retrieving arbitrary key/value pairs.  For details
on usage, see <a class="reference internal" href="#hstore"><span class="std std-ref">hstore support</span></a>.</p>
<dl class="method">
<dt id="HStoreField.keys">
<code class="descname">keys</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.keys" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Returns the keys for a given row.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">keys</span>

<span class="go">123 Main St [u&#39;bath&#39;, u&#39;garage&#39;]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.values">
<code class="descname">values</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.values" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return the values for a given row.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;vals&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">vals</span>

<span class="go">123 Main St [u&#39;2 bath&#39;, u&#39;2 cars&#39;]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.items">
<code class="descname">items</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.items" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Like python’s <code class="docutils literal"><span class="pre">dict</span></code>, return the keys and values in a list-of-lists:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;mtx&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">mtx</span>

<span class="go">123 Main St [[u&#39;bath&#39;, u&#39;2 bath&#39;], [u&#39;garage&#39;, u&#39;2 cars&#39;]]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.slice">
<code class="descname">slice</code><span class="sig-paren">(</span><em>*args</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.slice" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return a slice of data given a list of keys.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;garage_data&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">garage_data</span>

<span class="go">123 Main St {&#39;garage&#39;: &#39;2 cars&#39;}</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.exists">
<code class="descname">exists</code><span class="sig-paren">(</span><em>key</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.exists" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Query for whether the given key exists.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;has_garage&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">has_garage</span>

<span class="go">123 Main St True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;garage&#39;</span><span class="p">]</span> <span class="c1"># &lt;-- just houses w/garage data</span>

<span class="go">123 Main St 2 cars</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.defined">
<code class="descname">defined</code><span class="sig-paren">(</span><em>key</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.defined" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Query for whether the given key has a value associated with it.</p>
</dd></dl>

<dl class="method">
<dt id="HStoreField.update">
<code class="descname">update</code><span class="sig-paren">(</span><em>**data</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.update" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Perform an atomic update to the keys/values for a given row or rows.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">House</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">sqft</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">year_built</span><span class="o">=</span><span class="mi">2012</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.delete">
<code class="descname">delete</code><span class="sig-paren">(</span><em>*keys</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.delete" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Delete the provided keys for a given row or rows.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">We will use an <code class="docutils literal"><span class="pre">UPDATE</span></code> query.</p>
</div>
<div class="highlight-pycon"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">House</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s1">&#39;sqft&#39;</span><span class="p">,</span> <span class="s1">&#39;year_built&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">House</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.contains">
<code class="descname">contains</code><span class="sig-paren">(</span><em>value</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.contains" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>value</strong> – Either a <code class="docutils literal"><span class="pre">dict</span></code>, a <code class="docutils literal"><span class="pre">list</span></code> of keys, or a single key.</td>
</tr>
</tbody>
</table>
<p>Query rows for the existence of either:</p>
<ul class="simple">
<li>a partial dictionary.</li>
<li>a list of keys.</li>
<li>a single key.</li>
</ul>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">features</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;garage&#39;</span><span class="p">))</span> <span class="c1"># &lt;-- all houses w/garage key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;garage&#39;</span><span class="p">,</span> <span class="s1">&#39;bath&#39;</span><span class="p">]))</span> <span class="c1"># &lt;-- all houses w/garage &amp; bath</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">House</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">contains</span><span class="p">({</span><span class="s1">&#39;garage&#39;</span><span class="p">:</span> <span class="s1">&#39;2 cars&#39;</span><span class="p">}))</span> <span class="c1"># &lt;-- houses w/2-car garage</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="HStoreField.contains_any">
<code class="descname">contains_any</code><span class="sig-paren">(</span><em>*keys</em><span class="sig-paren">)</span><a class="headerlink" href="#HStoreField.contains_any" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>keys</strong> – One or more keys to search for.</td>
</tr>
</tbody>
</table>
<p>Query rows for the existince of <em>any</em> key.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt>
<em class="property">class </em><code class="descname">JSONField</code><span class="sig-paren">(</span><em>dumps=None</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span></dt>
<dd><p>Field class suitable for storing and querying arbitrary JSON.  When using
this on a model, set the field’s value to a Python object (either a <code class="docutils literal"><span class="pre">dict</span></code>
or a <code class="docutils literal"><span class="pre">list</span></code>).  When you retrieve your value from the database it will be
returned as a Python data structure.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>dumps</strong> – The default is to call json.dumps() or the dumps function. You can override this method to create a customized JSON wrapper.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">You must be using Postgres 9.2 / psycopg2 2.5 or greater.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">If you are using Postgres 9.4, strongly consider using the <a class="reference internal" href="#BinaryJSONField" title="BinaryJSONField"><code class="xref py py-class docutils literal"><span class="pre">BinaryJSONField</span></code></a> instead as it offers better performance and more powerful querying options.</p>
</div>
<p>Example model declaration:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">PostgresqlExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_db&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">APIResponse</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>
</pre></div>
</div>
<p>Example of storing JSON data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://foo.com/api/resource/&#39;</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">APIResponse</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">resp</span><span class="p">)</span>

<span class="n">APIResponse</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://foo.com/baz/&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>To query, use Python’s <code class="docutils literal"><span class="pre">[]</span></code> operators to specify nested key or array lookups:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">APIResponse</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;key1&#39;</span><span class="p">][</span><span class="s1">&#39;nested-key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;some-value&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To illustrate the use of the <code class="docutils literal"><span class="pre">[]</span></code> operators, imagine we have the following data stored in an <code class="docutils literal"><span class="pre">APIResponse</span></code>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;foo&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;bar&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;i1&quot;</span><span class="p">,</span> <span class="s2">&quot;i2&quot;</span><span class="p">,</span> <span class="s2">&quot;i3&quot;</span><span class="p">],</span>
    <span class="s2">&quot;baz&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;huey&quot;</span><span class="o">:</span> <span class="s2">&quot;mickey&quot;</span><span class="p">,</span>
      <span class="s2">&quot;peewee&quot;</span><span class="o">:</span> <span class="s2">&quot;nugget&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here are the results of a few queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">expression</span><span class="p">):</span>
    <span class="c1"># Helper function to just retrieve the results of a</span>
    <span class="c1"># particular expression.</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">APIResponse</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;my_data&#39;</span><span class="p">))</span>
             <span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
             <span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">query</span><span class="p">[</span><span class="s1">&#39;my_data&#39;</span><span class="p">]</span>

<span class="c1"># Accessing the foo -&gt; bar subkey will return a JSON</span>
<span class="c1"># representation of the list.</span>
<span class="n">get_data</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">])</span>
<span class="c1"># &#39;[&quot;i1&quot;, &quot;i2&quot;, &quot;i3&quot;]&#39;</span>

<span class="c1"># In order to retrieve this list as a Python list,</span>
<span class="c1"># we will call .as_json() on the expression.</span>
<span class="n">get_data</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_json</span><span class="p">())</span>
<span class="c1"># [&#39;i1&#39;, &#39;i2&#39;, &#39;i3&#39;]</span>

<span class="c1"># Similarly, accessing the foo -&gt; baz subkey will</span>
<span class="c1"># return a JSON representation of the dictionary.</span>
<span class="n">get_data</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;baz&#39;</span><span class="p">])</span>
<span class="c1"># &#39;{&quot;huey&quot;: &quot;mickey&quot;, &quot;peewee&quot;: &quot;nugget&quot;}&#39;</span>

<span class="c1"># Again, calling .as_json() will return an actual</span>
<span class="c1"># python dictionary.</span>
<span class="n">get_data</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;baz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_json</span><span class="p">())</span>
<span class="c1"># {&#39;huey&#39;: &#39;mickey&#39;, &#39;peewee&#39;: &#39;nugget&#39;}</span>

<span class="c1"># When dealing with simple values, either way works as</span>
<span class="c1"># you expect.</span>
<span class="n">get_data</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># &#39;i1&#39;</span>

<span class="c1"># Calling .as_json() when the result is a simple value</span>
<span class="c1"># will return the same thing as the previous example.</span>
<span class="n">get_data</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_json</span><span class="p">())</span>
<span class="c1"># &#39;i1&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="BinaryJSONField">
<em class="property">class </em><code class="descname">BinaryJSONField</code><span class="sig-paren">(</span><em>dumps=None</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#BinaryJSONField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Store and query arbitrary JSON documents. Data should be stored using normal Python <code class="docutils literal"><span class="pre">dict</span></code> and <code class="docutils literal"><span class="pre">list</span></code> objects, and when data is returned from the database, it will be returned using <code class="docutils literal"><span class="pre">dict</span></code> and <code class="docutils literal"><span class="pre">list</span></code> as well.</p>
<p>For examples of basic query operations, see the above code samples for <a class="reference internal" href="#JSONField" title="JSONField"><code class="xref py py-class docutils literal"><span class="pre">JSONField</span></code></a>. The example queries below will use the same <code class="docutils literal"><span class="pre">APIResponse</span></code> model described above.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>dumps</strong> – The default is to call json.dumps() or the dumps function. You can override this method to create a customized JSON wrapper.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">You must be using Postgres 9.4 / psycopg2 2.5 or newer. If you are using Postgres 9.2 or 9.3, you can use the regular <a class="reference internal" href="#JSONField" title="JSONField"><code class="xref py py-class docutils literal"><span class="pre">JSONField</span></code></a> instead.</p>
</div>
<dl class="method">
<dt id="BinaryJSONField.contains">
<code class="descname">contains</code><span class="sig-paren">(</span><em>other</em><span class="sig-paren">)</span><a class="headerlink" href="#BinaryJSONField.contains" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Test whether the given JSON data contains the given JSON fragment or key.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">search_fragment</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i2&#39;</span><span class="p">]}</span>
<span class="p">}</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">APIResponse</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">search_fragment</span><span class="p">)))</span>

<span class="c1"># If we&#39;re searching for a list, the list items do not need to</span>
<span class="c1"># be ordered in a particular way:</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">APIResponse</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">contains</span><span class="p">({</span>
             <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">]}})))</span>
</pre></div>
</div>
<p>We can pass in simple keys as well. To find APIResponses that contain the key <code class="docutils literal"><span class="pre">foo</span></code> at the top-level:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>We can also search sub-keys using square-brackets:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">([</span><span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;i1&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="BinaryJSONField.contains_any">
<code class="descname">contains_any</code><span class="sig-paren">(</span><em>*items</em><span class="sig-paren">)</span><a class="headerlink" href="#BinaryJSONField.contains_any" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Search for the presence of one or more of the given items.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">contains_any</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;nugget&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Like <a class="reference internal" href="#BinaryJSONField.contains" title="BinaryJSONField.contains"><code class="xref py py-meth docutils literal"><span class="pre">contains()</span></code></a>, we can also search sub-keys:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">contains_any</span><span class="p">(</span><span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="BinaryJSONField.contains_all">
<code class="descname">contains_all</code><span class="sig-paren">(</span><em>*items</em><span class="sig-paren">)</span><a class="headerlink" href="#BinaryJSONField.contains_all" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Search for the presence of all of the given items.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">contains_all</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Like <a class="reference internal" href="#BinaryJSONField.contains_any" title="BinaryJSONField.contains_any"><code class="xref py py-meth docutils literal"><span class="pre">contains_any()</span></code></a>, we can also search sub-keys:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">][</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">contains_all</span><span class="p">(</span><span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;i3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="BinaryJSONField.contained_by">
<code class="descname">contained_by</code><span class="sig-paren">(</span><em>other</em><span class="sig-paren">)</span><a class="headerlink" href="#BinaryJSONField.contained_by" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Test whether the given JSON document is contained by (is a subset of) the given JSON document. This method is the inverse of <a class="reference internal" href="#BinaryJSONField.contains" title="BinaryJSONField.contains"><code class="xref py py-meth docutils literal"><span class="pre">contains()</span></code></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">big_doc</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;i3&#39;</span><span class="p">],</span>
        <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;huey&#39;</span><span class="p">:</span> <span class="s1">&#39;mickey&#39;</span><span class="p">,</span>
            <span class="s1">&#39;peewee&#39;</span><span class="p">:</span> <span class="s1">&#39;nugget&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">&#39;other_key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nugget&#39;</span><span class="p">,</span> <span class="s1">&#39;bear&#39;</span><span class="p">,</span> <span class="s1">&#39;kitten&#39;</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">APIResponse</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">APIResponse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">contained_by</span><span class="p">(</span><span class="n">big_doc</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="Match">
<code class="descname">Match</code><span class="sig-paren">(</span><em>field</em>, <em>query</em><span class="sig-paren">)</span><a class="headerlink" href="#Match" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Generate a full-text search expression, automatically converting the left-hand operand to a <code class="docutils literal"><span class="pre">tsvector</span></code>, and the right-hand operand to a <code class="docutils literal"><span class="pre">tsquery</span></code>.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">blog_search</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Blog</span><span class="o">.</span><span class="n">STATUS_PUBLISHED</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="n">Match</span><span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="TSVectorField">
<em class="property">class </em><code class="descname">TSVectorField</code><a class="headerlink" href="#TSVectorField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Field type suitable for storing <code class="docutils literal"><span class="pre">tsvector</span></code> data. This field will automatically be created with a <code class="docutils literal"><span class="pre">GIN</span></code> index for improved search performance.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<blockquote>
<div>Data stored in this field will still need to be manually converted to the <code class="docutils literal"><span class="pre">tsvector</span></code> type.</div></blockquote>
<p>Example usage:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">search_content</span> <span class="o">=</span> <span class="n">TSVectorField</span><span class="p">()</span>

<span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;this is a sample blog entry.&#39;</span>
<span class="n">blog_entry</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
    <span class="n">search_content</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">to_tsvector</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>  <span class="c1"># Note `to_tsvector()`.</span>
</pre></div>
</div>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="dataset">
<span id="id12"></span><h2>データセット<a class="headerlink" href="#dataset" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <em>dataset</em> module contains a high-level API for working with databases modeled after the popular <a class="reference external" href="https://dataset.readthedocs.io/en/latest/index.html">project of the same name</a>. The aims of the <em>dataset</em> module are to provide:</p>
<ul class="simple">
<li>A simplified API for working with relational data, along the lines of working with JSON.</li>
<li>An easy way to export relational data as JSON or CSV.</li>
<li>An easy way to import JSON or CSV data into a relational database.</li>
</ul>
<p>A minimal data-loading script might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.dataset</span> <span class="kn">import</span> <span class="n">DataSet</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">DataSet</span><span class="p">(</span><span class="s1">&#39;sqlite:///:memory:&#39;</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;sometable&#39;</span><span class="p">]</span>
<span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Huey&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Mickey&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="s1">&#39;male&#39;</span><span class="p">)</span>

<span class="n">huey</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Huey&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">huey</span>
<span class="c1"># {&#39;age&#39;: 3, &#39;gender&#39;: None, &#39;id&#39;: 1, &#39;name&#39;: &#39;Huey&#39;}</span>

<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">obj</span>
<span class="c1"># {&#39;age&#39;: 3, &#39;gender&#39;: None, &#39;id&#39;: 1, &#39;name&#39;: &#39;Huey&#39;}</span>
<span class="c1"># {&#39;age&#39;: 5, &#39;gender&#39;: &#39;male&#39;, &#39;id&#39;: 2, &#39;name&#39;: &#39;Mickey&#39;}</span>
</pre></div>
</div>
<p>You can export or import data using <a class="reference internal" href="#DataSet.freeze" title="DataSet.freeze"><code class="xref py py-meth docutils literal"><span class="pre">freeze()</span></code></a> and <a class="reference internal" href="#DataSet.thaw" title="DataSet.thaw"><code class="xref py py-meth docutils literal"><span class="pre">thaw()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Export table content to the `users.json` file.</span>
<span class="n">db</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;users.json&#39;</span><span class="p">)</span>

<span class="c1"># Import data from a CSV file into a new table. Columns will be automatically</span>
<span class="c1"># created for each field in the CSV file.</span>
<span class="n">new_table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span>
<span class="n">new_table</span><span class="o">.</span><span class="n">thaw</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;monthly_stats.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="getting-started">
<h3>Getting started<a class="headerlink" href="#getting-started" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#DataSet" title="DataSet"><code class="xref py py-class docutils literal"><span class="pre">DataSet</span></code></a> objects are initialized by passing in a database URL of the format <code class="docutils literal"><span class="pre">dialect://user:password&#64;host/dbname</span></code>. See the <a class="reference internal" href="#db-url"><span class="std std-ref">データベースのURL</span></a> section for examples of connecting to various databases.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create an in-memory SQLite database.</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">DataSet</span><span class="p">(</span><span class="s1">&#39;sqlite:///:memory:&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="storing-data">
<h3>データの保存<a class="headerlink" href="#storing-data" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>To store data, we must first obtain a reference to a table. If the table does not exist, it will be created automatically:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get a table reference, creating the table if it does not exist.</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>We can now <a class="reference internal" href="#Table.insert" title="Table.insert"><code class="xref py py-meth docutils literal"><span class="pre">insert()</span></code></a> new rows into the table. If the columns do not exist, they will be created automatically:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Huey&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Mickey&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="s1">&#39;male&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To update existing entries in the table, pass in a dictionary containing the new values and filter conditions. The list of columns to use as filters is specified in the <em>columns</em> argument. If no filter columns are specified, then all rows will be updated.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Update the gender for &quot;Huey&quot;.</span>
<span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Huey&#39;</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

<span class="c1"># Update all records. If the column does not exist, it will be created.</span>
<span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">&#39;peewee&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="importing-data">
<h3>Importing data<a class="headerlink" href="#importing-data" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>To import data from an external source, such as a JSON or CSV file, you can use the <a class="reference internal" href="#Table.thaw" title="Table.thaw"><code class="xref py py-meth docutils literal"><span class="pre">thaw()</span></code></a> method. By default, new columns will be created for any attributes encountered. If you wish to only populate columns that are already defined on a table, you can pass in <code class="docutils literal"><span class="pre">strict=True</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Load data from a JSON file containing a list of objects.</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;stock_prices&#39;</span><span class="p">]</span>
<span class="n">table</span><span class="o">.</span><span class="n">thaw</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;stocks.json&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># Might print...</span>
<span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="s1">&#39;GOOG&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">703</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">109</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}]</span>
</pre></div>
</div>
</div>
<div class="section" id="using-transactions">
<h3>Using transactions<a class="headerlink" href="#using-transactions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>DataSet supports nesting transactions using a simple context manager.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
<span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>
    <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Charlie&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">nested_txn</span><span class="p">:</span>
        <span class="c1"># Set Charlie&#39;s favorite ORM to Django.</span>
        <span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Charlie&#39;</span><span class="p">,</span> <span class="n">favorite_orm</span><span class="o">=</span><span class="s1">&#39;django&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

        <span class="c1"># jk/lol</span>
        <span class="n">nested_txn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="inspecting-the-database">
<h3>Inspecting the database<a class="headerlink" href="#inspecting-the-database" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>You can use the <code class="xref py py-meth docutils literal"><span class="pre">tables()</span></code> method to list the tables in the current database:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">db</span><span class="o">.</span><span class="n">tables</span>
<span class="go">[&#39;sometable&#39;, &#39;user&#39;]</span>
</pre></div>
</div>
<p>And for a given table, you can print the columns:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span>
<span class="go">[&#39;id&#39;, &#39;age&#39;, &#39;name&#39;, &#39;gender&#39;, &#39;favorite_orm&#39;]</span>
</pre></div>
</div>
<p>We can also find out how many rows are in a table:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>
<span class="go">3</span>
</pre></div>
</div>
</div>
<div class="section" id="reading-data">
<h3>Reading data<a class="headerlink" href="#reading-data" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>To retrieve all rows, you can use the <a class="reference internal" href="#Table.all" title="Table.all"><code class="xref py py-meth docutils literal"><span class="pre">all()</span></code></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Retrieve all the users.</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># We can iterate over all rows without calling `.all()`</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]:</span>
    <span class="k">print</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Specific objects can be retrieved using <a class="reference internal" href="#Table.find" title="Table.find"><code class="xref py py-meth docutils literal"><span class="pre">find()</span></code></a> and <a class="reference internal" href="#Table.find_one" title="Table.find_one"><code class="xref py py-meth docutils literal"><span class="pre">find_one()</span></code></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Find all the users who like peewee.</span>
<span class="n">peewee_users</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">&#39;peewee&#39;</span><span class="p">)</span>

<span class="c1"># Find Huey.</span>
<span class="n">huey</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Huey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="exporting-data">
<h3>Exporting data<a class="headerlink" href="#exporting-data" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>To export data, use the <a class="reference internal" href="#DataSet.freeze" title="DataSet.freeze"><code class="xref py py-meth docutils literal"><span class="pre">freeze()</span></code></a> method, passing in the query you wish to export:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">peewee_users</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">&#39;peewee&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">peewee_users</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;peewee_users.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="api">
<h3>API<a class="headerlink" href="#api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="DataSet">
<em class="property">class </em><code class="descname">DataSet</code><span class="sig-paren">(</span><em>url</em><span class="sig-paren">)</span><a class="headerlink" href="#DataSet" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>The <em>DataSet</em> class provides a high-level API for working with relational databases.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>url</strong> (<em>str</em>) – A database URL. See <a class="reference internal" href="#db-url"><span class="std std-ref">データベースのURL</span></a> for examples.</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="DataSet.tables">
<code class="descname">tables</code><a class="headerlink" href="#DataSet.tables" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return a list of tables stored in the database. This list is computed dynamically each time it is accessed.</p>
</dd></dl>

<dl class="method">
<dt id="DataSet.__getitem__">
<code class="descname">__getitem__</code><span class="sig-paren">(</span><em>table_name</em><span class="sig-paren">)</span><a class="headerlink" href="#DataSet.__getitem__" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Provide a <a class="reference internal" href="#Table" title="Table"><code class="xref py py-class docutils literal"><span class="pre">Table</span></code></a> reference to the specified table. If the table does not exist, it will be created.</p>
</dd></dl>

<dl class="method">
<dt id="DataSet.query">
<code class="descname">query</code><span class="sig-paren">(</span><em>sql</em><span class="optional">[</span>, <em>params=None</em><span class="optional">[</span>, <em>commit=True</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#DataSet.query" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first simple">
<li><strong>sql</strong> (<em>str</em>) – A SQL query.</li>
<li><strong>params</strong> (<em>list</em>) – Optional parameters for the query.</li>
<li><strong>commit</strong> (<em>bool</em>) – Whether the query should be committed upon execution.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">戻り値:</th><td class="field-body"><p class="first last">A database cursor.</p>
</td>
</tr>
</tbody>
</table>
<p>Execute the provided query against the database.</p>
</dd></dl>

<dl class="method">
<dt id="DataSet.transaction">
<code class="descname">transaction</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#DataSet.transaction" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Create a context manager representing a new transaction (or savepoint).</p>
</dd></dl>

<dl class="method">
<dt id="DataSet.freeze">
<code class="descname">freeze</code><span class="sig-paren">(</span><em>query</em><span class="optional">[</span>, <em>format='csv'</em><span class="optional">[</span>, <em>filename=None</em><span class="optional">[</span>, <em>file_obj=None</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#DataSet.freeze" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>query</strong> – A <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>, generated using <a class="reference internal" href="#Table.all" title="Table.all"><code class="xref py py-meth docutils literal"><span class="pre">all()</span></code></a> or <cite>~Table.find</cite>.</li>
<li><strong>format</strong> – Output format. By default, <em>csv</em> and <em>json</em> are supported.</li>
<li><strong>filename</strong> – Filename to write output to.</li>
<li><strong>file_obj</strong> – File-like object to write output to.</li>
<li><strong>kwargs</strong> – Arbitrary parameters for export-specific functionality.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="DataSet.thaw">
<code class="descname">thaw</code><span class="sig-paren">(</span><em>table</em><span class="optional">[</span>, <em>format='csv'</em><span class="optional">[</span>, <em>filename=None</em><span class="optional">[</span>, <em>file_obj=None</em><span class="optional">[</span>, <em>strict=False</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#DataSet.thaw" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<em>str</em>) – The name of the table to load data into.</li>
<li><strong>format</strong> – Input format. By default, <em>csv</em> and <em>json</em> are supported.</li>
<li><strong>filename</strong> – Filename to read data from.</li>
<li><strong>file_obj</strong> – File-like object to read data from.</li>
<li><strong>strict</strong> (<em>bool</em>) – Whether to store values for columns that do not already exist on the table.</li>
<li><strong>kwargs</strong> – Arbitrary parameters for import-specific functionality.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="DataSet.connect">
<code class="descname">connect</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#DataSet.connect" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Open a connection to the underlying database. If a connection is not opened explicitly, one will be opened the first time a query is executed.</p>
</dd></dl>

<dl class="method">
<dt id="DataSet.close">
<code class="descname">close</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#DataSet.close" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Close the connection to the underlying database.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="Table">
<em class="property">class </em><code class="descname">Table</code><span class="sig-paren">(</span><em>dataset</em>, <em>name</em>, <em>model_class</em><span class="sig-paren">)</span><a class="headerlink" href="#Table" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>The <em>Table</em> class provides a high-level API for working with rows in a given table.</p>
<dl class="attribute">
<dt id="Table.columns">
<code class="descname">columns</code><a class="headerlink" href="#Table.columns" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return a list of columns in the given table.</p>
</dd></dl>

<dl class="attribute">
<dt id="Table.model_class">
<code class="descname">model_class</code><a class="headerlink" href="#Table.model_class" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>A dynamically-created <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> class.</p>
</dd></dl>

<dl class="method">
<dt id="Table.create_index">
<code class="descname">create_index</code><span class="sig-paren">(</span><em>columns</em><span class="optional">[</span>, <em>unique=False</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#Table.create_index" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Create an index on the given columns:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create a unique index on the `username` column.</span>
<span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Table.insert">
<code class="descname">insert</code><span class="sig-paren">(</span><em>**data</em><span class="sig-paren">)</span><a class="headerlink" href="#Table.insert" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Insert the given data dictionary into the table, creating new columns as needed.</p>
</dd></dl>

<dl class="method">
<dt id="Table.update">
<code class="descname">update</code><span class="sig-paren">(</span><em>columns=None</em>, <em>conjunction=None</em>, <em>**data</em><span class="sig-paren">)</span><a class="headerlink" href="#Table.update" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Update the table using the provided data. If one or more columns are specified in the <em>columns</em> parameter, then those columns』 values in the <em>data</em> dictionary will be used to determine which rows to update.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Update all rows.</span>
<span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">&#39;peewee&#39;</span><span class="p">)</span>

<span class="c1"># Only update Huey&#39;s record, setting his age to 3.</span>
<span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Huey&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Table.find">
<code class="descname">find</code><span class="sig-paren">(</span><em>**query</em><span class="sig-paren">)</span><a class="headerlink" href="#Table.find" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Query the table for rows matching the specified equality conditions. If no query is specified, then all rows are returned.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">peewee_users</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">&#39;peewee&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Table.find_one">
<code class="descname">find_one</code><span class="sig-paren">(</span><em>**query</em><span class="sig-paren">)</span><a class="headerlink" href="#Table.find_one" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return a single row matching the specified equality conditions. If no matching row is found then <code class="docutils literal"><span class="pre">None</span></code> will be returned.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">huey</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Huey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Table.all">
<code class="descname">all</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#Table.all" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return all rows in the given table.</p>
</dd></dl>

<dl class="method">
<dt id="Table.delete">
<code class="descname">delete</code><span class="sig-paren">(</span><em>**query</em><span class="sig-paren">)</span><a class="headerlink" href="#Table.delete" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Delete all rows matching the given equality conditions. If no query is provided, then all rows will be deleted.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Adios, Django!</span>
<span class="n">db</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">favorite_orm</span><span class="o">=</span><span class="s1">&#39;Django&#39;</span><span class="p">)</span>

<span class="c1"># Delete all the secret messages.</span>
<span class="n">db</span><span class="p">[</span><span class="s1">&#39;secret_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Table.freeze">
<code class="descname">freeze</code><span class="sig-paren">(</span><span class="optional">[</span><em>format='csv'</em><span class="optional">[</span>, <em>filename=None</em><span class="optional">[</span>, <em>file_obj=None</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#Table.freeze" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>format</strong> – Output format. By default, <em>csv</em> and <em>json</em> are supported.</li>
<li><strong>filename</strong> – Filename to write output to.</li>
<li><strong>file_obj</strong> – File-like object to write output to.</li>
<li><strong>kwargs</strong> – Arbitrary parameters for export-specific functionality.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Table.thaw">
<code class="descname">thaw</code><span class="sig-paren">(</span><span class="optional">[</span><em>format='csv'</em><span class="optional">[</span>, <em>filename=None</em><span class="optional">[</span>, <em>file_obj=None</em><span class="optional">[</span>, <em>strict=False</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#Table.thaw" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>format</strong> – Input format. By default, <em>csv</em> and <em>json</em> are supported.</li>
<li><strong>filename</strong> – Filename to read data from.</li>
<li><strong>file_obj</strong> – File-like object to read data from.</li>
<li><strong>strict</strong> (<em>bool</em>) – Whether to store values for columns that do not already exist on the table.</li>
<li><strong>kwargs</strong> – Arbitrary parameters for import-specific functionality.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
</div>
<div class="section" id="django-integration">
<span id="djpeewee"></span><h2>Djangoの統合<a class="headerlink" href="#django-integration" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The Django ORM provides a very high-level abstraction over SQL and as a consequence is in some ways
<a class="reference external" href="http://charlesleifer.com/blog/shortcomings-in-the-django-orm-and-a-look-at-peewee-a-lightweight-alternative/">limited in terms of flexibility or expressiveness</a>. I
wrote a <a class="reference external" href="http://charlesleifer.com/blog/the-search-for-the-missing-link-what-lies-between-sql-and-django-s-orm-/">blog post</a>
describing my search for a 「missing link」 between Django’s ORM and the SQL it
generates, concluding that no such layer exists.  The <code class="docutils literal"><span class="pre">djpeewee</span></code> module attempts
to provide an easy-to-use, structured layer for generating SQL queries for use
with Django’s ORM.</p>
<p>A couple use-cases might be:</p>
<ul class="simple">
<li>Joining on fields that are not related by foreign key (for example UUID fields).</li>
<li>Performing aggregate queries on calculated values.</li>
<li>Features that Django does not support such as <code class="docutils literal"><span class="pre">CASE</span></code> statements.</li>
<li>Utilizing SQL functions that Django does not support, such as <code class="docutils literal"><span class="pre">SUBSTR</span></code>.</li>
<li>Replacing nearly-identical SQL queries with reusable, composable data-structures.</li>
</ul>
<p>Below is an example of how you might use this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Django model.</span>
<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

<span class="c1"># Suppose we want to find all events that are longer than an hour.  Django</span>
<span class="c1"># does not support this, but we can use peewee.</span>
<span class="kn">from</span> <span class="nn">playhouse.djpeewee</span> <span class="kn">import</span> <span class="n">translate</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">Event</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">Event</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span>
             <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">P</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

<span class="c1"># Now feed our peewee query into Django&#39;s `raw()` method:</span>
<span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
<span class="n">Event</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="foreign-keys-and-many-to-many-relationships">
<h3>Foreign keys and Many-to-many relationships<a class="headerlink" href="#foreign-keys-and-many-to-many-relationships" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>The <a class="reference internal" href="#translate" title="translate"><code class="xref py py-func docutils literal"><span class="pre">translate()</span></code></a> function will recursively traverse the graph of models
and return a dictionary populated with everything it finds.  Back-references are
not searched by default, but can be included by specifying <code class="docutils literal"><span class="pre">backrefs=True</span></code>.</p>
<p>例:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">playhouse.djpeewee</span> <span class="kn">import</span> <span class="n">translate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">translate</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Group</span><span class="p">)</span>
<span class="go">{&#39;ContentType&#39;: peewee.ContentType,</span>
<span class="go"> &#39;Group&#39;: peewee.Group,</span>
<span class="go"> &#39;Group_permissions&#39;: peewee.Group_permissions,</span>
<span class="go"> &#39;Permission&#39;: peewee.Permission,</span>
<span class="go"> &#39;User&#39;: peewee.User,</span>
<span class="go"> &#39;User_groups&#39;: peewee.User_groups,</span>
<span class="go"> &#39;User_user_permissions&#39;: peewee.User_user_permissions}</span>
</pre></div>
</div>
<p>As you can see in the example above, although only <cite>User</cite> and <cite>Group</cite> were passed
in to <a class="reference internal" href="#translate" title="translate"><code class="xref py py-func docutils literal"><span class="pre">translate()</span></code></a>, several other models which are related by foreign key
were also created. Additionally, the many-to-many 「through」 tables were created
as separate models since peewee does not abstract away these types of relationships.</p>
<p>Using the above models it is possible to construct joins.  The following example
will get all users who belong to a group that starts with the letter 「A」:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">P</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Group</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">User_groups</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">Group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">sql</span>  <span class="c1"># formatted for legibility</span>
<span class="go">SELECT t1.&quot;id&quot;, t1.&quot;password&quot;, ...</span>
<span class="go">FROM &quot;auth_user&quot; AS t1</span>
<span class="go">INNER JOIN &quot;auth_user_groups&quot; AS t2 ON (t1.&quot;id&quot; = t2.&quot;user_id&quot;)</span>
<span class="go">INNER JOIN &quot;auth_group&quot; AS t3 ON (t2.&quot;group_id&quot; = t3.&quot;id&quot;)</span>
<span class="go">WHERE (Lower(Substr(t3.&quot;name&quot;, %s, %s)) = %s)</span>
</pre></div>
</div>
</div>
<div class="section" id="djpeewee-api">
<h3>djpeewee API<a class="headerlink" href="#djpeewee-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="function">
<dt id="translate">
<code class="descname">translate</code><span class="sig-paren">(</span><em>*models</em>, <em>**options</em><span class="sig-paren">)</span><a class="headerlink" href="#translate" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Translate the given Django models into roughly equivalent peewee models
suitable for use constructing queries. Foreign keys and many-to-many relationships
will be followed and models generated, although back references are not traversed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first simple">
<li><strong>models</strong> – One or more Django model classes.</li>
<li><strong>options</strong> – A dictionary of options, see note below.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">戻り値:</th><td class="field-body"><p class="first last">A dict-like object containing the generated models, but which supports
dotted-name style lookups.</p>
</td>
</tr>
</tbody>
</table>
<p>The following are valid options:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">recurse</span></code>: Follow foreign keys and many to many (default: <code class="docutils literal"><span class="pre">True</span></code>).</li>
<li><code class="docutils literal"><span class="pre">max_depth</span></code>: Maximum depth to recurse (default: <code class="docutils literal"><span class="pre">None</span></code>, unlimited).</li>
<li><code class="docutils literal"><span class="pre">backrefs</span></code>: Follow backrefs (default: <code class="docutils literal"><span class="pre">False</span></code>).</li>
<li><code class="docutils literal"><span class="pre">exclude</span></code>: A list of models to exclude.</li>
</ul>
</dd></dl>

</div>
</div>
<div class="section" id="fields">
<span id="extra-fields"></span><h2>フィールド<a class="headerlink" href="#fields" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>This module also contains several field classes that implement additional logic like encryption and compression. There is also a <a class="reference internal" href="#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a> that makes it easy to work with simple many-to-many relationships.</p>
<p>These fields can be found in the <code class="docutils literal"><span class="pre">playhouse.fields</span></code> module.</p>
<dl class="class">
<dt id="ManyToManyField">
<em class="property">class </em><code class="descname">ManyToManyField</code><span class="sig-paren">(</span><em>rel_model</em><span class="optional">[</span>, <em>related_name=None</em><span class="optional">[</span>, <em>through_model=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#ManyToManyField" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>rel_model</strong> – <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> class.</li>
<li><strong>related_name</strong> (<em>str</em>) – Name for the automatically-created backref. If not
provided, the pluralized version of the model will be used.</li>
<li><strong>through_model</strong> – <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> to use for the intermediary table. If
not provided, a simple through table will be automatically created.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The <a class="reference internal" href="#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a> provides a simple interface for working with many-to-many relationships, inspired by Django. A many-to-many relationship is typically implemented by creating a junction table with foreign keys to the two models being related. For instance, if you were building a syllabus manager for college students, the relationship between students and courses would be many-to-many. Here is the schema using standard APIs:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Course</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">StudentCourse</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">student</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Course</span><span class="p">)</span>
</pre></div>
</div>
<p>To query the courses for a particular student, you would join through the junction table:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># List the courses that &quot;Huey&quot; is enrolled in:</span>
<span class="n">courses</span> <span class="o">=</span> <span class="p">(</span><span class="n">Course</span>
           <span class="o">.</span><span class="n">select</span><span class="p">()</span>
           <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">StudentCourse</span><span class="p">)</span>
           <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
           <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Huey&#39;</span><span class="p">))</span>
<span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">courses</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">course</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a> is designed to simplify this use-case by providing a <em>field-like</em> API for querying and modifying data in the junction table. Here is how our code looks using <a class="reference internal" href="#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Course</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">students</span> <span class="o">=</span> <span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Student</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;courses&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">It does not matter from Peewee’s perspective which model the <a class="reference internal" href="#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a> goes on, since the back-reference is just the mirror image. In order to write valid Python, though, you will need to add the <code class="docutils literal"><span class="pre">ManyToManyField</span></code> on the second model so that the name of the first model is in the scope.</p>
</div>
<p>We still need a junction table to store the relationships between students and courses. This model can be accessed by calling the <a class="reference internal" href="#ManyToManyField.get_through_model" title="ManyToManyField.get_through_model"><code class="xref py py-meth docutils literal"><span class="pre">get_through_model()</span></code></a> method. This is useful when creating tables.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create tables for the students, courses, and relationships between</span>
<span class="c1"># the two.</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_tables</span><span class="p">([</span>
    <span class="n">Student</span><span class="p">,</span>
    <span class="n">Course</span><span class="p">,</span>
    <span class="n">Course</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">get_through_model</span><span class="p">()])</span>
</pre></div>
</div>
<p>When accessed from a model instance, the <a class="reference internal" href="#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a> exposes a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> representing the set of related objects. Let’s use the interactive shell to see how all this works:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span> <span class="o">=</span> <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;huey&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="p">]</span>
<span class="go">[&#39;English 101&#39;, &#39;CS 101&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">engl_101</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;English 101&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">student</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">engl_101</span><span class="o">.</span><span class="n">students</span><span class="p">]</span>
<span class="go">[&#39;Huey&#39;, &#39;Mickey&#39;, &#39;Zaizee&#39;]</span>
</pre></div>
</div>
<p>To add new relationships between objects, you can either assign the objects directly to the <code class="docutils literal"><span class="pre">ManyToManyField</span></code> attribute, or call the <a class="reference internal" href="#ManyToManyField.add" title="ManyToManyField.add"><code class="xref py py-meth docutils literal"><span class="pre">add()</span></code></a> method. The difference between the two is that simply assigning will clear out any existing relationships, whereas <code class="docutils literal"><span class="pre">add()</span></code> can preserve existing relationships.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">courses</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">course</span><span class="o">.</span><span class="n">name</span>
<span class="go">English 101</span>
<span class="go">English 151</span>
<span class="go">English 201</span>
<span class="go">English 221</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cs_101</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CS 101&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cs_151</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CS 151&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">cs_101</span><span class="p">,</span> <span class="n">cs_151</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
<span class="go">[&#39;CS 101&#39;, &#39;CS151&#39;, &#39;English 101&#39;, &#39;English 151&#39;, &#39;English 201&#39;,</span>
<span class="go"> &#39;English 221&#39;]</span>
</pre></div>
</div>
<p>This is quite a few courses, so let’s remove the 200-level english courses. To remove objects, use the <a class="reference internal" href="#ManyToManyField.remove" title="ManyToManyField.remove"><code class="xref py py-meth docutils literal"><span class="pre">remove()</span></code></a> method.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">))</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
<span class="go">[&#39;CS 101&#39;, &#39;CS151&#39;, &#39;English 101&#39;, &#39;English 151&#39;]</span>
</pre></div>
</div>
<p>To remove all relationships from a collection, you can use the <code class="xref py py-meth docutils literal"><span class="pre">clear()</span></code> method. Let’s say that English 101 is canceled, so we need to remove all the students from it:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">engl_101</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;English 101&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">engl_101</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">For an overview of implementing many-to-many relationships using standard Peewee APIs, check out the <a class="reference internal" href="querying.html#manytomany"><span class="std std-ref">多対多の実装</span></a> section. For all but the most simple cases, you will be better off implementing many-to-many using the standard APIs.</p>
</div>
<dl class="method">
<dt id="ManyToManyField.add">
<code class="descname">add</code><span class="sig-paren">(</span><em>value</em><span class="optional">[</span>, <em>clear_existing=True</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#ManyToManyField.add" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>value</strong> – Either a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> instance, a list of model instances, or a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>.</li>
<li><strong>clear_existing</strong> (<em>bool</em>) – Whether to remove existing relationships first.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Associate <code class="docutils literal"><span class="pre">value</span></code> with the current instance. You can pass in a single model instance, a list of model instances, or even a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>.</p>
<p>Example code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Huey needs to enroll in a bunch of courses, including all</span>
<span class="c1"># the English classes, and a couple Comp-Sci classes.</span>
<span class="n">huey</span> <span class="o">=</span> <span class="n">Student</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Huey&#39;</span><span class="p">)</span>

<span class="c1"># We can add all the objects represented by a query.</span>
<span class="n">english_courses</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">))</span>
<span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">english_courses</span><span class="p">)</span>

<span class="c1"># We can also add lists of individual objects.</span>
<span class="n">cs101</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CS 101&#39;</span><span class="p">)</span>
<span class="n">cs151</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CS 151&#39;</span><span class="p">)</span>
<span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">cs101</span><span class="p">,</span> <span class="n">cs151</span><span class="p">])</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="ManyToManyField.remove">
<code class="descname">remove</code><span class="sig-paren">(</span><em>value</em><span class="sig-paren">)</span><a class="headerlink" href="#ManyToManyField.remove" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>value</strong> – Either a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> instance, a list of model instances, or a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>.</td>
</tr>
</tbody>
</table>
<p>Disassociate <code class="docutils literal"><span class="pre">value</span></code> from the current instance. Like <a class="reference internal" href="#ManyToManyField.add" title="ManyToManyField.add"><code class="xref py py-meth docutils literal"><span class="pre">add()</span></code></a>, you can pass in a model instance, a list of model instances, or even a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>.</p>
<p>Example code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Huey is currently enrolled in a lot of english classes</span>
<span class="c1"># as well as some Comp-Sci. He is changing majors, so we</span>
<span class="c1"># will remove all his courses.</span>
<span class="n">english_courses</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">Course</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">))</span>
<span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">english_courses</span><span class="p">)</span>

<span class="c1"># Remove the two Comp-Sci classes Huey is enrolled in.</span>
<span class="n">cs101</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CS 101&#39;</span><span class="p">)</span>
<span class="n">cs151</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;CS 151&#39;</span><span class="p">)</span>
<span class="n">huey</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">remove</span><span class="p">([</span><span class="n">cs101</span><span class="p">,</span> <span class="n">cs151</span><span class="p">])</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="ManyToManyField.clear">
<code class="descname">clear</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#ManyToManyField.clear" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Remove all associated objects.</p>
<p>Example code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># English 101 is canceled this semester, so remove all</span>
<span class="c1"># the enrollments.</span>
<span class="n">english_101</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Course</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;English 101&#39;</span><span class="p">)</span>
<span class="n">english_101</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="ManyToManyField.get_through_model">
<code class="descname">get_through_model</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#ManyToManyField.get_through_model" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return the <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> representing the many-to-many junction table. This can be specified manually when the field is being instantiated using the <code class="docutils literal"><span class="pre">through_model</span></code> parameter. If a <code class="docutils literal"><span class="pre">through_model</span></code> is not specified, one will automatically be created.</p>
<p>When creating tables for an application that uses <a class="reference internal" href="#ManyToManyField" title="ManyToManyField"><code class="xref py py-class docutils literal"><span class="pre">ManyToManyField</span></code></a>, <strong>you must create the through table expicitly</strong>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get a reference to the automatically-created through table.</span>
<span class="n">StudentCourseThrough</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">students</span><span class="o">.</span><span class="n">get_through_model</span><span class="p">()</span>

<span class="c1"># Create tables for our two models as well as the through model.</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_tables</span><span class="p">([</span>
    <span class="n">Student</span><span class="p">,</span>
    <span class="n">Course</span><span class="p">,</span>
    <span class="n">StudentCourseThrough</span><span class="p">])</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="DeferredThroughModel">
<em class="property">class </em><code class="descname">DeferredThroughModel</code><a class="headerlink" href="#DeferredThroughModel" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>In some instances, you may need to obtain a reference to a through model before that model is actually defined. In order to avoid weird circular logic, you can use the <code class="docutils literal"><span class="pre">DeferredThroughModel</span></code> as a placeholder, then 「fill it in」 when you’re ready.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="n">NoteThroughDeferred</span> <span class="o">=</span> <span class="n">DeferredThroughModel</span><span class="p">()</span>  <span class="c1"># Create placeholder.</span>

<span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">ManyToManyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">through_model</span><span class="o">=</span><span class="n">NoteThroughDeferred</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NoteThrough</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">Note</span><span class="p">)</span>
    <span class="n">sort_order</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Now that all the models are defined, we can replace the placeholder</span>
<span class="c1"># with the actual through model implementation.</span>
<span class="n">NoteThroughDeferred</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">NoteThrough</span><span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="DeferredThroughModel.set_model">
<code class="descname">set_model</code><span class="sig-paren">(</span><em>model_class</em><span class="sig-paren">)</span><a class="headerlink" href="#DeferredThroughModel.set_model" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Initialize the deferred placeholder with the appropriate model class.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="CompressedField">
<em class="property">class </em><code class="descname">CompressedField</code><span class="sig-paren">(</span><span class="optional">[</span><em>compression_level=6</em><span class="optional">[</span>, <em>algorithm='zlib'</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#CompressedField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">CompressedField</span></code> stores compressed data using the specified algorithm. This field extends <a class="reference internal" href="api.html#BlobField" title="BlobField"><code class="xref py py-class docutils literal"><span class="pre">BlobField</span></code></a>, transparently storing a compressed representation of the data in the database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>compression_level</strong> (<em>int</em>) – A value from 0 to 9.</li>
<li><strong>algorithm</strong> (<em>str</em>) – Either <code class="docutils literal"><span class="pre">'zlib'</span></code> or <code class="docutils literal"><span class="pre">'bz2'</span></code>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="PasswordField">
<em class="property">class </em><code class="descname">PasswordField</code><span class="sig-paren">(</span><span class="optional">[</span><em>iterations=12</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#PasswordField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">PasswordField</span></code> stores a password hash and lets you verify it. The password is hashed when it is saved to the database and after reading it from the database you can call <code class="docutils literal"><span class="pre">check_password</span> <span class="pre">(password)</span> <span class="pre">-&gt;</span> <span class="pre">bool</span></code> on it.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>iterations</strong> (<em>int</em>) – Indicates the work factor, it does 2^n iterations.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">This field requires <a class="reference external" href="https://github.com/pyca/bcrypt/">bcrypt</a>, which can be installed by running <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">bcrypt</span></code>.</p>
</div>
</dd></dl>

<dl class="class">
<dt id="PickledField">
<em class="property">class </em><code class="descname">PickledField</code><span class="sig-paren">(</span><span class="optional">[</span><em>**kwargs</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#PickledField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>A field capable of storing arbitrary Python objects.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">If the <code class="docutils literal"><span class="pre">cPickle</span></code> module is available, it will be used.</p>
</div>
</dd></dl>

</div>
<div class="section" id="generic-foreign-keys">
<span id="gfk"></span><h2>一般的な外部キー<a class="headerlink" href="#generic-foreign-keys" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">gfk</span></code> module provides a Generic ForeignKey (GFK), similar to Django.  A GFK
is composed of two columns: an object ID and an object type identifier.  The
object types are collected in a global registry (<code class="docutils literal"><span class="pre">all_models</span></code>).</p>
<p>How a <a class="reference internal" href="#GFKField" title="GFKField"><code class="xref py py-class docutils literal"><span class="pre">GFKField</span></code></a> is resolved:</p>
<ol class="arabic simple">
<li>Look up the object type in the global registry (returns a model class)</li>
<li>Look up the model instance by object ID</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">In order to use Generic ForeignKeys, your application’s models <em>must</em>
subclass <code class="docutils literal"><span class="pre">playhouse.gfk.Model</span></code>.  This ensures that the model class will
be added to the global registry.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">GFKs themselves are not actually a field and will not add a column
to your table.</p>
</div>
<p>Like regular ForeignKeys, GFKs support a 「back-reference」 via the <a class="reference internal" href="#ReverseGFK" title="ReverseGFK"><code class="xref py py-class docutils literal"><span class="pre">ReverseGFK</span></code></a>
descriptor.</p>
<div class="section" id="how-to-use-gfks">
<h3>How to use GFKs<a class="headerlink" href="#how-to-use-gfks" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li>Be sure your model subclasses <code class="docutils literal"><span class="pre">playhouse.gfk.Model</span></code></li>
<li>Add a <a class="reference internal" href="api.html#CharField" title="CharField"><code class="xref py py-class docutils literal"><span class="pre">CharField</span></code></a> to store the <code class="docutils literal"><span class="pre">object_type</span></code></li>
<li>Add a field to store the <code class="docutils literal"><span class="pre">object_id</span></code> (usually a <a class="reference internal" href="api.html#IntegerField" title="IntegerField"><code class="xref py py-class docutils literal"><span class="pre">IntegerField</span></code></a>)</li>
<li>Add a <a class="reference internal" href="#GFKField" title="GFKField"><code class="xref py py-class docutils literal"><span class="pre">GFKField</span></code></a> and instantiate it with the names of the <code class="docutils literal"><span class="pre">object_type</span></code>
and <code class="docutils literal"><span class="pre">object_id</span></code> fields.</li>
<li>(optional) On any other models, add a <a class="reference internal" href="#ReverseGFK" title="ReverseGFK"><code class="xref py py-class docutils literal"><span class="pre">ReverseGFK</span></code></a> descriptor</li>
</ol>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.gfk</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">object_type</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">object_id</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">object</span> <span class="o">=</span> <span class="n">GFKField</span><span class="p">(</span><span class="s1">&#39;object_type&#39;</span><span class="p">,</span> <span class="s1">&#39;object_id&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">ReverseGFK</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="s1">&#39;object_type&#39;</span><span class="p">,</span> <span class="s1">&#39;object_id&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Photo</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">ReverseGFK</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span> <span class="s1">&#39;object_type&#39;</span><span class="p">,</span> <span class="s1">&#39;object_id&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>How you use these is pretty straightforward hopefully:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;awesome post&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;awesome&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;whiny post&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;whiny&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="n">b2</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">tags</span> <span class="c1"># &lt;-- a select query</span>
<span class="go">&lt;class &#39;__main__.Tag&#39;&gt; SELECT t1.&quot;id&quot;, t1.&quot;tag&quot;, t1.&quot;object_type&quot;, t1.&quot;object_id&quot; FROM &quot;tag&quot; AS t1 WHERE ((t1.&quot;object_type&quot; = ?) AND (t1.&quot;object_id&quot; = ?)) [u&#39;blog&#39;, 1]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
<span class="go">[u&#39;awesome&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b2</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
<span class="go">[u&#39;whiny&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Photo</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;picture of cat&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">object</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;kitties&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">object</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;cats&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
<span class="go">[u&#39;kitties&#39;, u&#39;cats&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Blog</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
<span class="go">[u&#39;awesome&#39;, u&#39;whiny&#39;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Tag</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;awesome&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span><span class="o">.</span><span class="n">object</span>
<span class="go">&lt;__main__.Blog at 0x268f450&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">name</span>
<span class="go">u&#39;awesome post&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="gfk-api">
<h3>GFK API<a class="headerlink" href="#gfk-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="GFKField">
<em class="property">class </em><code class="descname">GFKField</code><span class="sig-paren">(</span><span class="optional">[</span><em>model_type_field='object_type'</em><span class="optional">[</span>, <em>model_id_field='object_id'</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#GFKField" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Provide a clean API for storing 「generic」 foreign keys.  Generic foreign keys
are comprised of an object type, which maps to a model class, and an object id,
which maps to the primary key of the related model class.</p>
<p>Setting the GFKField on a model will automatically populate the <code class="docutils literal"><span class="pre">model_type_field</span></code>
and <code class="docutils literal"><span class="pre">model_id_field</span></code>.  Similarly, getting the GFKField on a model instance
will 「resolve」 the two fields, first looking up the model class, then looking
up the instance by ID.</p>
</dd></dl>

<dl class="class">
<dt id="ReverseGFK">
<em class="property">class </em><code class="descname">ReverseGFK</code><span class="sig-paren">(</span><em>model</em><span class="optional">[</span>, <em>model_type_field='object_type'</em><span class="optional">[</span>, <em>model_id_field='object_id'</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#ReverseGFK" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Back-reference support for <a class="reference internal" href="#GFKField" title="GFKField"><code class="xref py py-class docutils literal"><span class="pre">GFKField</span></code></a>.</p>
</dd></dl>

</div>
</div>
<div class="section" id="hybrid-attributes">
<span id="hybrid"></span><h2>ハイブリッド属性<a class="headerlink" href="#hybrid-attributes" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Hybrid attributes encapsulate functionality that operates at both the Python <em>and</em> SQL levels. The idea for hybrid attributes comes from a feature of the <a class="reference external" href="http://docs.sqlalchemy.org/en/improve_toc/orm/extensions/hybrid.html">same name in SQLAlchemy</a>. Consider the following example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Interval</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="nd">@hybrid_method</span>
    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">point</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">point</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>hybrid attribute</em> gets its name from the fact that the <code class="docutils literal"><span class="pre">length</span></code> attribute will behave differently depending on whether it is accessed via the <code class="docutils literal"><span class="pre">Interval</span></code> class or an <code class="docutils literal"><span class="pre">Interval</span></code> instance.</p>
<p>If accessed via an instance, then it behaves just as you would expect.</p>
<p>If accessed via the <code class="docutils literal"><span class="pre">Interval.length</span></code> class attribute, however, the length calculation will be expressed as a SQL expression. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Interval</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>This query will be equivalent to the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;interval&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span> <span class="o">-</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">hybrid</span></code> module also contains a decorator for implementing hybrid methods which can accept parameters. As with hybrid properties, when accessed via a model instance, then the function executes normally as-written. When the hybrid method is called on the class, however, it will generate a SQL expression.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Interval</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>This query is equivalent to the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;interval&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>There is an additional API for situations where the python implementation differs slightly from the SQL implementation. Let’s add a <code class="docutils literal"><span class="pre">radius</span></code> method to the <code class="docutils literal"><span class="pre">Interval</span></code> model. Because this method calculates an absolute value, we will use the Python <code class="docutils literal"><span class="pre">abs()</span></code> function for the instance portion and the <code class="docutils literal"><span class="pre">fn.ABS()</span></code> SQL function for the class portion.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Interval</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="nd">@radius.expression</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">ABS</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
<p>What is neat is that both the <code class="docutils literal"><span class="pre">radius</span></code> implementations refer to the <code class="docutils literal"><span class="pre">length</span></code> hybrid attribute! When accessed via an <code class="docutils literal"><span class="pre">Interval</span></code> instance, the radius calculation will be executed in Python. When invoked via an <code class="docutils literal"><span class="pre">Interval</span></code> class, we will get the appropriate SQL.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Interval</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">radius</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>This query is equivalent to the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;interval&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="k">abs</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span> <span class="o">-</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Pretty neat, right? Thanks for the cool idea, SQLAlchemy!</p>
<div class="section" id="hybrid-api">
<h3>Hybrid API<a class="headerlink" href="#hybrid-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="hybrid_method">
<em class="property">class </em><code class="descname">hybrid_method</code><span class="sig-paren">(</span><em>func</em><span class="optional">[</span>, <em>expr=None</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#hybrid_method" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Method decorator that allows the definition of a Python object method with both instance-level and class-level behavior.</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Interval</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>

    <span class="nd">@hybrid_method</span>
    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">point</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">point</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
<p>When called with an <code class="docutils literal"><span class="pre">Interval</span></code> instance, the <code class="docutils literal"><span class="pre">contains</span></code> method will behave as you would expect. When called as a classmethod, though, a SQL expression will be generated:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Interval</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>Would generate the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;interval&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span><span class="p">))</span>
</pre></div>
</div>
<dl class="method">
<dt id="hybrid_method.expression">
<code class="descname">expression</code><span class="sig-paren">(</span><em>expr</em><span class="sig-paren">)</span><a class="headerlink" href="#hybrid_method.expression" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Method decorator for specifying the SQL-expression producing method.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="hybrid_property">
<em class="property">class </em><code class="descname">hybrid_property</code><span class="sig-paren">(</span><em>fget</em><span class="optional">[</span>, <em>fset=None</em><span class="optional">[</span>, <em>fdel=None</em><span class="optional">[</span>, <em>expr=None</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#hybrid_property" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Method decorator that allows the definition of a Python object property with both instance-level and class-level behavior.</p>
<p>Examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Interval</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="nd">@radius.expression</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">ABS</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
<p>When accessed on an <code class="docutils literal"><span class="pre">Interval</span></code> instance, the <code class="docutils literal"><span class="pre">length</span></code> and <code class="docutils literal"><span class="pre">radius</span></code> properties will behave as you would expect. When accessed as class attributes, though, a SQL expression will be generated instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Interval</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span>
             <span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span>
             <span class="p">(</span><span class="n">Interval</span><span class="o">.</span><span class="n">radius</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
<p>Would generate the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">,</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;interval&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="p">(</span>
    <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span> <span class="o">-</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="k">AND</span>
    <span class="p">((</span><span class="k">abs</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;end&quot;</span> <span class="o">-</span> <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;start&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="key-value-store">
<span id="kv"></span><h2>キーバリューストア<a class="headerlink" href="#key-value-store" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Provides a simple key/value store, using a dictionary API.  By default the
the <a class="reference internal" href="#KeyStore" title="KeyStore"><code class="xref py py-class docutils literal"><span class="pre">KeyStore</span></code></a> will use an in-memory sqlite database, but any database
will work.</p>
<p>To start using the key-store, create an instance and pass it a field to use
for the values.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="p">(</span><span class="n">TextField</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
<span class="go">&#39;A&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>To store arbitrary python objects, use the <a class="reference internal" href="#PickledKeyStore" title="PickledKeyStore"><code class="xref py py-class docutils literal"><span class="pre">PickledKeyStore</span></code></a>, which
stores values in a pickled <a class="reference internal" href="api.html#BlobField" title="BlobField"><code class="xref py py-class docutils literal"><span class="pre">BlobField</span></code></a>.</p>
<p class="last">If your objects are JSON-serializable, you can also use the <a class="reference internal" href="#JSONKeyStore" title="JSONKeyStore"><code class="xref py py-class docutils literal"><span class="pre">JSONKeyStore</span></code></a>, which stores the values as JSON-encoded strings.</p>
</div>
<p>Using the <a class="reference internal" href="#KeyStore" title="KeyStore"><code class="xref py py-class docutils literal"><span class="pre">KeyStore</span></code></a> it is possible to use 「expressions」 to retrieve
values from the dictionary.  For instance, imagine you want to get all keys
which contain a certain substring:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">keys_matching_substr</span> <span class="o">=</span> <span class="n">kv</span><span class="p">[</span><span class="n">kv</span><span class="o">.</span><span class="n">key</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">ubstr%&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">keys_start_with_a</span> <span class="o">=</span> <span class="n">kv</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">kv</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="keystore-api">
<h3>KeyStore API<a class="headerlink" href="#keystore-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="KeyStore">
<em class="property">class </em><code class="descname">KeyStore</code><span class="sig-paren">(</span><em>value_field</em><span class="optional">[</span>, <em>ordered=False</em><span class="optional">[</span>, <em>database=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#KeyStore" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Lightweight dictionary interface to a model containing a key and value.
Implements common dictionary methods, such as <code class="docutils literal"><span class="pre">__getitem__</span></code>, <code class="docutils literal"><span class="pre">__setitem__</span></code>,
<code class="docutils literal"><span class="pre">get</span></code>, <code class="docutils literal"><span class="pre">pop</span></code>, <code class="docutils literal"><span class="pre">items</span></code>, <code class="docutils literal"><span class="pre">keys</span></code>, and <code class="docutils literal"><span class="pre">values</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>value_field</strong> (<em>Field</em>) – Field instance to use as value field, e.g. an
instance of <a class="reference internal" href="api.html#TextField" title="TextField"><code class="xref py py-class docutils literal"><span class="pre">TextField</span></code></a>.</li>
<li><strong>ordered</strong> (<em>boolean</em>) – Whether the keys should be returned in sorted order</li>
<li><strong>database</strong> (<a class="reference internal" href="api.html#Database" title="Database"><em>Database</em></a>) – <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> class to use for the storage
backend.  If none is supplied, an in-memory Sqlite DB will be used.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>例:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">playhouse.kv</span> <span class="kn">import</span> <span class="n">KeyStore</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="p">(</span><span class="n">TextField</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kv</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>
<span class="go">a foo</span>

<span class="gp">&gt;&gt;&gt; </span><span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">kv</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">kv</span>
<span class="go">False</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="JSONKeyStore">
<em class="property">class </em><code class="descname">JSONKeyStore</code><span class="sig-paren">(</span><span class="optional">[</span><em>ordered=False</em><span class="optional">[</span>, <em>database=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#JSONKeyStore" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Identical to the <a class="reference internal" href="#KeyStore" title="KeyStore"><code class="xref py py-class docutils literal"><span class="pre">KeyStore</span></code></a> except the values are stored as JSON-encoded strings, so you can store complex data-types like dictionaries and lists.</p>
<p>例:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">playhouse.kv</span> <span class="kn">import</span> <span class="n">JSONKeyStore</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jkv</span> <span class="o">=</span> <span class="n">JSONKeyStore</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jkv</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">jkv</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">jkv</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="go">[(u&#39;a&#39;, &#39;A&#39;), (u&#39;b&#39;, [1, 2, 3])]</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="PickledKeyStore">
<em class="property">class </em><code class="descname">PickledKeyStore</code><span class="sig-paren">(</span><span class="optional">[</span><em>ordered=False</em><span class="optional">[</span>, <em>database=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#PickledKeyStore" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Identical to the <a class="reference internal" href="#KeyStore" title="KeyStore"><code class="xref py py-class docutils literal"><span class="pre">KeyStore</span></code></a> except <em>anything</em> can be stored as
a value in the dictionary.  The storage for the value will be a pickled
<a class="reference internal" href="api.html#BlobField" title="BlobField"><code class="xref py py-class docutils literal"><span class="pre">BlobField</span></code></a>.</p>
<p>例:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">playhouse.kv</span> <span class="kn">import</span> <span class="n">PickledKeyStore</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pkv</span> <span class="o">=</span> <span class="n">PickledKeyStore</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pkv</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pkv</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">pkv</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="go">[(u&#39;a&#39;, &#39;A&#39;), (u&#39;b&#39;, 1.0)]</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="shortcuts">
<span id="id13"></span><h2>ショートカット<a class="headerlink" href="#shortcuts" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>This module contains helper functions for expressing things that would otherwise be somewhat verbose or cumbersome using peewee’s APIs. There are also helpers for serializing models to dictionaries and vice-versa.</p>
<dl class="function">
<dt id="case">
<code class="descname">case</code><span class="sig-paren">(</span><em>predicate</em>, <em>expression_tuples</em>, <em>default=None</em><span class="sig-paren">)</span><a class="headerlink" href="#case" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>predicate</strong> – A SQL expression or can be <code class="docutils literal"><span class="pre">None</span></code>.</li>
<li><strong>expression_tuples</strong> – An iterable containing one or more 2-tuples
comprised of an expression and return value.</li>
<li><strong>default</strong> – default if none of the cases match.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Example SQL case statements:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- case with predicate --</span>
<span class="k">SELECT</span> <span class="ss">&quot;username&quot;</span><span class="p">,</span>
  <span class="k">CASE</span> <span class="ss">&quot;user_id&quot;</span>
    <span class="k">WHEN</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="ss">&quot;one&quot;</span>
    <span class="k">WHEN</span> <span class="mi">2</span> <span class="k">THEN</span> <span class="ss">&quot;two&quot;</span>
    <span class="k">ELSE</span> <span class="ss">&quot;?&quot;</span>
  <span class="k">END</span>
<span class="k">FROM</span> <span class="ss">&quot;users&quot;</span><span class="p">;</span>

<span class="c1">-- case with no predicate (inline expressions) --</span>
<span class="k">SELECT</span> <span class="ss">&quot;username&quot;</span><span class="p">,</span>
  <span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="ss">&quot;one&quot;</span>
    <span class="k">WHEN</span> <span class="ss">&quot;user_id&quot;</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">THEN</span> <span class="ss">&quot;two&quot;</span>
    <span class="k">ELSE</span> <span class="ss">&quot;?&quot;</span>
  <span class="k">END</span>
<span class="k">FROM</span> <span class="ss">&quot;users&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Equivalent function invocations:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">case</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="p">(</span>
  <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;one&quot;</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">)),</span> <span class="s2">&quot;?&quot;</span><span class="p">))</span>

<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">case</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">(</span>
  <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;one&quot;</span><span class="p">),</span>  <span class="c1"># note the double equals</span>
  <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">)),</span> <span class="s2">&quot;?&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>You can specify a value for the CASE expression using the <code class="docutils literal"><span class="pre">alias()</span></code>
method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">case</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="p">(</span>
  <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;one&quot;</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">)),</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;id_string&quot;</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="cast">
<code class="descname">cast</code><span class="sig-paren">(</span><em>node</em>, <em>as_type</em><span class="sig-paren">)</span><a class="headerlink" href="#cast" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first simple">
<li><strong>node</strong> – A peewee <a class="reference internal" href="api.html#Node" title="Node"><code class="xref py py-class docutils literal"><span class="pre">Node</span></code></a>, for instance a <code class="xref py py-class docutils literal"><span class="pre">Field</span></code> or an <code class="xref py py-class docutils literal"><span class="pre">Expression</span></code>.</li>
<li><strong>as_type</strong> (<em>str</em>) – The type name to cast to, e.g. <code class="docutils literal"><span class="pre">'int'</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">戻り値:</th><td class="field-body"><p class="first last">a function call to cast the node as the given type.</p>
</td>
</tr>
</tbody>
</table>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Find all data points whose numbers are palindromes. We do this by</span>
<span class="c1"># casting the number to string, reversing it, then casting the reversed</span>
<span class="c1"># string back to an integer.</span>
<span class="n">reverse_val</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">REVERSE</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">DataPoint</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">)),</span> <span class="s1">&#39;int&#39;</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">DataPoint</span>
         <span class="o">.</span><span class="n">select</span><span class="p">()</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DataPoint</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">reverse_val</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="model_to_dict">
<code class="descname">model_to_dict</code><span class="sig-paren">(</span><em>model</em><span class="optional">[</span>, <em>recurse=True</em><span class="optional">[</span>, <em>backrefs=False</em><span class="optional">[</span>, <em>only=None</em><span class="optional">[</span>, <em>exclude=None</em><span class="optional">[</span>, <em>extra_attrs=None</em><span class="optional">[</span>, <em>fields_from_query=None</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#model_to_dict" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Convert a model instance (and optionally any related instances) to
a dictionary.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>recurse</strong> (<em>bool</em>) – Whether foreign-keys should be recursed.</li>
<li><strong>backrefs</strong> (<em>bool</em>) – Whether lists of related objects should be recursed.</li>
<li><strong>only</strong> – A list (or set) of field instances which should be included in the result dictionary.</li>
<li><strong>exclude</strong> – A list (or set) of field instances which should be excluded from the result dictionary.</li>
<li><strong>extra_attrs</strong> – A list of attribute or method names on the instance which should be included in the dictionary.</li>
<li><strong>fields_from_query</strong> (<a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><em>SelectQuery</em></a>) – The <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> that created this model instance. Only the fields and values explicitly selected by the query will be serialized.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;charlie&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="go">{&#39;id&#39;: 1, &#39;username&#39;: &#39;charlie&#39;}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">backrefs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="go">{&#39;id&#39;: 1, &#39;tweets&#39;: [], &#39;username&#39;: &#39;charlie&#39;}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;tweet-1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t2</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;tweet-2&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">backrefs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="go">{</span>
<span class="go">  &#39;id&#39;: 1,</span>
<span class="go">  &#39;tweets&#39;: [</span>
<span class="go">    {&#39;id&#39;: 1, &#39;message&#39;: &#39;tweet-1&#39;},</span>
<span class="go">    {&#39;id&#39;: 2, &#39;message&#39;: &#39;tweet-2&#39;},</span>
<span class="go">  ],</span>
<span class="go">  &#39;username&#39;: &#39;charlie&#39;</span>
<span class="go">}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="go">{</span>
<span class="go">  &#39;id&#39;: 1,</span>
<span class="go">  &#39;message&#39;: &#39;tweet-1&#39;,</span>
<span class="go">  &#39;user&#39;: {</span>
<span class="go">    &#39;id&#39;: 1,</span>
<span class="go">    &#39;username&#39;: &#39;charlie&#39;</span>
<span class="go">  }</span>
<span class="go">}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">model_to_dict</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="go">{&#39;id&#39;: 1, &#39;message&#39;: &#39;tweet-2&#39;, &#39;user&#39;: 1}</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="dict_to_model">
<code class="descname">dict_to_model</code><span class="sig-paren">(</span><em>model_class</em>, <em>data</em><span class="optional">[</span>, <em>ignore_unknown=False</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#dict_to_model" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Convert a dictionary of data to a model instance, creating related
instances where appropriate.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>model_class</strong> (<a class="reference internal" href="api.html#Model" title="Model"><em>Model</em></a>) – The model class to construct.</li>
<li><strong>data</strong> (<em>dict</em>) – A dictionary of data. Foreign keys can be included as nested dictionaries, and back-references as lists of dictionaries.</li>
<li><strong>ignore_unknown</strong> (<em>bool</em>) – Whether to allow unrecognized (non-field) attributes.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;charlie&#39;</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">dict_to_model</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">user_data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span>
<span class="go">&lt;__main__.User at 0x7fea8fa4d490&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
<span class="go">&#39;charlie&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">note_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;note text&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user_data</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">note</span> <span class="o">=</span> <span class="n">dict_to_model</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">note_data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">note</span><span class="o">.</span><span class="n">text</span>
<span class="go">&#39;note text&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">note</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
<span class="go">&#39;charlie&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">user_with_notes</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;charlie&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;note-1&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;note-2&#39;</span><span class="p">}]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">dict_to_model</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">user_with_notes</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<span class="go">&#39;note-1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span>
<span class="go">&#39;charlie&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="RetryOperationalError">
<em class="property">class </em><code class="descname">RetryOperationalError</code><a class="headerlink" href="#RetryOperationalError" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>When mixed-in with a vendor-specific <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> subclass, this class overrides the <a class="reference internal" href="api.html#Database.execute_sql" title="Database.execute_sql"><code class="xref py py-meth docutils literal"><span class="pre">execute_sql()</span></code></a> method to automatically reconnect and retry queries that fail due to an <code class="docutils literal"><span class="pre">OperationalError</span></code>. The query that failed will be retried only once, and if it fails twice an exception will be raised.</p>
<p>Usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">playhouse.shortcuts</span> <span class="kn">import</span> <span class="n">RetryOperationalError</span>


<span class="k">class</span> <span class="nc">MyRetryDB</span><span class="p">(</span><span class="n">RetryOperationalError</span><span class="p">,</span> <span class="n">MySQLDatabase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">db</span> <span class="o">=</span> <span class="n">MyRetryDB</span><span class="p">(</span><span class="s1">&#39;my_app&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="signal-support">
<span id="signals"></span><h2>シグナルサポート<a class="headerlink" href="#signal-support" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Models with hooks for signals (a-la django) are provided in <code class="docutils literal"><span class="pre">playhouse.signals</span></code>. To use the signals, you will need all of your project’s models to be a subclass of <code class="docutils literal"><span class="pre">playhouse.signals.Model</span></code>, which overrides the necessary methods to provide support for the various signals.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.signals</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">post_save</span>


<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>

<span class="nd">@post_save</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">MyModel</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">on_save_handler</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">):</span>
    <span class="n">put_data_in_cache</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p>For what I hope are obvious reasons, Peewee signals do not work when you use the <a class="reference internal" href="api.html#Model.insert" title="Model.insert"><code class="xref py py-meth docutils literal"><span class="pre">Model.insert()</span></code></a>, <a class="reference internal" href="api.html#Model.update" title="Model.update"><code class="xref py py-meth docutils literal"><span class="pre">Model.update()</span></code></a>, or <a class="reference internal" href="api.html#Model.delete" title="Model.delete"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete()</span></code></a> methods. These methods generate queries that execute beyond the scope of the ORM, and the ORM does not know about which model instances might or might not be affected when the query executes.</p>
<p class="last">Signals work by hooking into the higher-level peewee APIs like <a class="reference internal" href="api.html#Model.save" title="Model.save"><code class="xref py py-meth docutils literal"><span class="pre">Model.save()</span></code></a> and <a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete_instance()</span></code></a>, where the affected model instance is known ahead of time.</p>
</div>
<p>The following signals are provided:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">pre_save</span></code></dt>
<dd>Called immediately before an object is saved to the database.  Provides an
additional keyword argument <code class="docutils literal"><span class="pre">created</span></code>, indicating whether the model is being
saved for the first time or updated.</dd>
<dt><code class="docutils literal"><span class="pre">post_save</span></code></dt>
<dd>Called immediately after an object is saved to the database.  Provides an
additional keyword argument <code class="docutils literal"><span class="pre">created</span></code>, indicating whether the model is being
saved for the first time or updated.</dd>
<dt><code class="docutils literal"><span class="pre">pre_delete</span></code></dt>
<dd>Called immediately before an object is deleted from the database when <a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete_instance()</span></code></a>
is used.</dd>
<dt><code class="docutils literal"><span class="pre">post_delete</span></code></dt>
<dd>Called immediately after an object is deleted from the database when <a class="reference internal" href="api.html#Model.delete_instance" title="Model.delete_instance"><code class="xref py py-meth docutils literal"><span class="pre">Model.delete_instance()</span></code></a>
is used.</dd>
<dt><code class="docutils literal"><span class="pre">pre_init</span></code></dt>
<dd>Called when a model class is first instantiated</dd>
<dt><code class="docutils literal"><span class="pre">post_init</span></code></dt>
<dd>Called after a model class has been instantiated and the fields have been populated,
for example when being selected as part of a database query.</dd>
</dl>
<div class="section" id="connecting-handlers">
<h3>Connecting handlers<a class="headerlink" href="#connecting-handlers" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Whenever a signal is dispatched, it will call any handlers that have been registered.
This allows totally separate code to respond to events like model save and delete.</p>
<p>The <a class="reference internal" href="#Signal" title="Signal"><code class="xref py py-class docutils literal"><span class="pre">Signal</span></code></a> class provides a <a class="reference internal" href="#Signal.connect" title="Signal.connect"><code class="xref py py-meth docutils literal"><span class="pre">connect()</span></code></a> method, which takes
a callback function and two optional parameters for 「sender」 and 「name」.  If specified,
the 「sender」 parameter should be a single model class and allows your callback to only
receive signals from that one model class.  The 「name」 parameter is used as a convenient alias
in the event you wish to unregister your signal handler.</p>
<p>Example usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.signals</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">post_save_handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> was just saved&#39;</span> <span class="o">%</span> <span class="n">instance</span>

<span class="c1"># our handler will only be called when we save instances of SomeModel</span>
<span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">post_save_handler</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">SomeModel</span><span class="p">)</span>
</pre></div>
</div>
<p>All signal handlers accept as their first two arguments <code class="docutils literal"><span class="pre">sender</span></code> and <code class="docutils literal"><span class="pre">instance</span></code>,
where <code class="docutils literal"><span class="pre">sender</span></code> is the model class and <code class="docutils literal"><span class="pre">instance</span></code> is the actual model being acted
upon.</p>
<p>If you’d like, you can also use a decorator to connect signal handlers.  This is
functionally equivalent to the above example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@post_save</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">SomeModel</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_save_handler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> was just saved&#39;</span> <span class="o">%</span> <span class="n">instance</span>
</pre></div>
</div>
</div>
<div class="section" id="signal-api">
<h3>Signal API<a class="headerlink" href="#signal-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="Signal">
<em class="property">class </em><code class="descname">Signal</code><a class="headerlink" href="#Signal" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Stores a list of receivers (callbacks) and calls them when the 「send」 method is invoked.</p>
<dl class="method">
<dt id="Signal.connect">
<code class="descname">connect</code><span class="sig-paren">(</span><em>receiver</em><span class="optional">[</span>, <em>sender=None</em><span class="optional">[</span>, <em>name=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#Signal.connect" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Add the receiver to the internal list of receivers, which will be called
whenever the signal is sent.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>receiver</strong> (<em>callable</em>) – a callable that takes at least two parameters,
a 「sender」, which is the Model subclass that triggered the signal, and
an 「instance」, which is the actual model instance.</li>
<li><strong>sender</strong> (<a class="reference internal" href="api.html#Model" title="Model"><em>Model</em></a>) – if specified, only instances of this model class will
trigger the receiver callback.</li>
<li><strong>name</strong> (<em>string</em>) – a short alias</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">project.handlers</span> <span class="kn">import</span> <span class="n">cache_buster</span>

<span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">cache_buster</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;project.cache_buster&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Signal.disconnect">
<code class="descname">disconnect</code><span class="sig-paren">(</span><span class="optional">[</span><em>receiver=None</em><span class="optional">[</span>, <em>name=None</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#Signal.disconnect" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Disconnect the given receiver (or the receiver with the given name alias)
so that it no longer is called.  Either the receiver or the name must be
provided.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>receiver</strong> (<em>callable</em>) – the callback to disconnect</li>
<li><strong>name</strong> (<em>string</em>) – a short alias</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">post_save</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;project.cache_buster&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Signal.send">
<code class="descname">send</code><span class="sig-paren">(</span><em>instance</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#Signal.send" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Iterates over the receivers and will call them in the order in which
they were connected.  If the receiver specified a sender, it will only
be called if the instance is an instance of the sender.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>instance</strong> – a model instance</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
</div>
<div class="section" id="pwiz-a-model-generator">
<span id="pwiz"></span><h2>pwiz、モデルジェネレータ<a class="headerlink" href="#pwiz-a-model-generator" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal"><span class="pre">pwiz</span></code> is a little script that ships with peewee and is capable of introspecting
an existing database and generating model code suitable for interacting with the
underlying data.  If you have a database already, pwiz can give you a nice boost
by generating skeleton code with correct column affinities and foreign keys.</p>
<p>If you install peewee using <code class="docutils literal"><span class="pre">setup.py</span> <span class="pre">install</span></code>, pwiz will be installed as a 「script」
and you can just run:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">python -m pwiz -e postgresql -u postgres my_postgres_db</span>
</pre></div>
</div>
<p>This will print a bunch of models to standard output.  So you can do this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">python -m pwiz -e postgresql my_postgres_db &gt; mymodels.py</span>
<span class="go">python # &lt;-- fire up an interactive shell</span>
</pre></div>
</div>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mymodels</span> <span class="kn">import</span> <span class="n">Blog</span><span class="p">,</span> <span class="n">Entry</span><span class="p">,</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">Whatever</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="p">[</span><span class="n">blog</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">blog</span> <span class="ow">in</span> <span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()]</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="33%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Meaning</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>-h</td>
<td>show help</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>-e</td>
<td>database backend</td>
<td>-e mysql</td>
</tr>
<tr class="row-even"><td>-H</td>
<td>host to connect to</td>
<td>-H remote.db.server</td>
</tr>
<tr class="row-odd"><td>-p</td>
<td>port to connect on</td>
<td>-p 9001</td>
</tr>
<tr class="row-even"><td>-u</td>
<td>database user</td>
<td>-u postgres</td>
</tr>
<tr class="row-odd"><td>-P</td>
<td>database password</td>
<td>-P secret</td>
</tr>
<tr class="row-even"><td>-s</td>
<td>postgres schema</td>
<td>-s public</td>
</tr>
</tbody>
</table>
<p>The following are valid parameters for the engine:</p>
<ul class="simple">
<li>sqlite</li>
<li>mysql</li>
<li>postgresql</li>
</ul>
</div>
<div class="section" id="schema-migrations">
<span id="migrate"></span><h2>スキーママイグレーション<a class="headerlink" href="#schema-migrations" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Peewee now supports schema migrations, with well-tested support for Postgresql,
SQLite and MySQL. Unlike other schema migration tools, peewee’s migrations
do not handle introspection and database 「versioning」. Rather, peewee provides a number of
helper functions for generating and running schema-altering statements. This engine provides
the basis on which a more sophisticated tool could some day be built.</p>
<p>Migrations can be written as simple python scripts and executed from the command-line. Since
the migrations only depend on your applications <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> object, it should be
easy to manage changing your model definitions and maintaining a set of migration scripts without
introducing dependencies.</p>
<div class="section" id="example-usage">
<h3>Example usage<a class="headerlink" href="#example-usage" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Begin by importing the helpers from the <cite>migrate</cite> module:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.migrate</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Instantiate a <code class="docutils literal"><span class="pre">migrator</span></code>. The <a class="reference internal" href="#SchemaMigrator" title="SchemaMigrator"><code class="xref py py-class docutils literal"><span class="pre">SchemaMigrator</span></code></a> class is responsible for
generating schema altering operations, which can then be run sequentially by the
<code class="xref py py-func docutils literal"><span class="pre">migrate()</span></code> helper.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Postgres example:</span>
<span class="n">my_db</span> <span class="o">=</span> <span class="n">PostgresqlDatabase</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">migrator</span> <span class="o">=</span> <span class="n">PostgresqlMigrator</span><span class="p">(</span><span class="n">my_db</span><span class="p">)</span>

<span class="c1"># SQLite example:</span>
<span class="n">my_db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">&#39;my_database.db&#39;</span><span class="p">)</span>
<span class="n">migrator</span> <span class="o">=</span> <span class="n">SqliteMigrator</span><span class="p">(</span><span class="n">my_db</span><span class="p">)</span>
</pre></div>
</div>
<p>Use <code class="xref py py-func docutils literal"><span class="pre">migrate()</span></code> to execute one or more operations:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">title_field</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">status_field</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">migrate</span><span class="p">(</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;some_table&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">title_field</span><span class="p">),</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;some_table&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">status_field</span><span class="p">),</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;some_table&#39;</span><span class="p">,</span> <span class="s1">&#39;old_column&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p>Migrations are not run inside a transaction. If you wish the migration to run
in a transaction you will need to wrap the call to <cite>migrate</cite> in a transaction
block, e.g.</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">my_db</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
    <span class="n">migrate</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="supported-operations">
<h3>Supported Operations<a class="headerlink" href="#supported-operations" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Add new field(s) to an existing model:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create your field instances. For non-null fields you must specify a</span>
<span class="c1"># default value.</span>
<span class="n">pubdate_field</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">comment_field</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># Run the migration, specifying the database table, field name and field.</span>
<span class="n">migrate</span><span class="p">(</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;comment_tbl&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_date&#39;</span><span class="p">,</span> <span class="n">pubdate_field</span><span class="p">),</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;comment_tbl&#39;</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">comment_field</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Renaming a field:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Specify the table, original name of the column, and its new name.</span>
<span class="n">migrate</span><span class="p">(</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_date&#39;</span><span class="p">,</span> <span class="s1">&#39;publish_date&#39;</span><span class="p">),</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;mod_date&#39;</span><span class="p">,</span> <span class="s1">&#39;modified_date&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Dropping a field:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">migrate</span><span class="p">(</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;some_old_field&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Making a field nullable or not nullable:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Note that when making a field not null that field must not have any</span>
<span class="c1"># NULL values present.</span>
<span class="n">migrate</span><span class="p">(</span>
    <span class="c1"># Make `pub_date` allow NULL values.</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">drop_not_null</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_date&#39;</span><span class="p">),</span>

    <span class="c1"># Prevent `modified_date` from containing NULL values.</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_not_null</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;modified_date&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Renaming a table:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">migrate</span><span class="p">(</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;stories_tbl&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Adding an index:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Specify the table, column names, and whether the index should be</span>
<span class="c1"># UNIQUE or not.</span>
<span class="n">migrate</span><span class="p">(</span>
    <span class="c1"># Create an index on the `pub_date` column.</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;pub_date&#39;</span><span class="p">,),</span> <span class="bp">False</span><span class="p">),</span>

    <span class="c1"># Create a multi-column index on the `pub_date` and `status` fields.</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;pub_date&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">),</span> <span class="bp">False</span><span class="p">),</span>

    <span class="c1"># Create a unique index on the category and title fields.</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">),</span> <span class="bp">True</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Dropping an index:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Specify the index name.</span>
<span class="n">migrate</span><span class="p">(</span><span class="n">migrator</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;story_pub_date_status&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="migrations-api">
<h3>Migrations API<a class="headerlink" href="#migrations-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="function">
<dt>
<code class="descname">migrate</code><span class="sig-paren">(</span><em>*operations</em><span class="sig-paren">)</span></dt>
<dd><p>Execute one or more schema altering operations.</p>
<p>Usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">migrate</span><span class="p">(</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;some_table&#39;</span><span class="p">,</span> <span class="s1">&#39;new_column&#39;</span><span class="p">,</span> <span class="n">CharField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)),</span>
    <span class="n">migrator</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;some_table&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;new_column&#39;</span><span class="p">,)),</span>
<span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="SchemaMigrator">
<em class="property">class </em><code class="descname">SchemaMigrator</code><span class="sig-paren">(</span><em>database</em><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>database</strong> – a <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> instance.</td>
</tr>
</tbody>
</table>
<p>The <a class="reference internal" href="#SchemaMigrator" title="SchemaMigrator"><code class="xref py py-class docutils literal"><span class="pre">SchemaMigrator</span></code></a> is responsible for generating schema-altering
statements.</p>
<dl class="method">
<dt id="SchemaMigrator.add_column">
<code class="descname">add_column</code><span class="sig-paren">(</span><em>table</em>, <em>column_name</em>, <em>field</em><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.add_column" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<em>str</em>) – Name of the table to add column to.</li>
<li><strong>column_name</strong> (<em>str</em>) – Name of the new column.</li>
<li><strong>field</strong> (<em>Field</em>) – A <code class="xref py py-class docutils literal"><span class="pre">Field</span></code> instance.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Add a new column to the provided table. The <code class="docutils literal"><span class="pre">field</span></code> provided will be used
to generate the appropriate column definition.</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">If the field is not nullable it must specify a default value.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">For non-null fields, the field will initially be added as a null field,
then an <code class="docutils literal"><span class="pre">UPDATE</span></code> statement will be executed to populate the column
with the default value. Finally, the column will be marked as not null.</p>
</div>
</dd></dl>

<dl class="method">
<dt id="SchemaMigrator.drop_column">
<code class="descname">drop_column</code><span class="sig-paren">(</span><em>table</em>, <em>column_name</em><span class="optional">[</span>, <em>cascade=True</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.drop_column" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<em>str</em>) – Name of the table to drop column from.</li>
<li><strong>column_name</strong> (<em>str</em>) – Name of the column to drop.</li>
<li><strong>cascade</strong> (<em>bool</em>) – Whether the column should be dropped with <cite>CASCADE</cite>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="SchemaMigrator.rename_column">
<code class="descname">rename_column</code><span class="sig-paren">(</span><em>table</em>, <em>old_name</em>, <em>new_name</em><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.rename_column" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<em>str</em>) – Name of the table containing column to rename.</li>
<li><strong>old_name</strong> (<em>str</em>) – Current name of the column.</li>
<li><strong>new_name</strong> (<em>str</em>) – New name for the column.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="SchemaMigrator.add_not_null">
<code class="descname">add_not_null</code><span class="sig-paren">(</span><em>table</em>, <em>column</em><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.add_not_null" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<em>str</em>) – Name of table containing column.</li>
<li><strong>column</strong> (<em>str</em>) – Name of the column to make not nullable.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="SchemaMigrator.drop_not_null">
<code class="descname">drop_not_null</code><span class="sig-paren">(</span><em>table</em>, <em>column</em><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.drop_not_null" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<em>str</em>) – Name of table containing column.</li>
<li><strong>column</strong> (<em>str</em>) – Name of the column to make nullable.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="SchemaMigrator.rename_table">
<code class="descname">rename_table</code><span class="sig-paren">(</span><em>old_name</em>, <em>new_name</em><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.rename_table" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>old_name</strong> (<em>str</em>) – Current name of the table.</li>
<li><strong>new_name</strong> (<em>str</em>) – New name for the table.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="SchemaMigrator.add_index">
<code class="descname">add_index</code><span class="sig-paren">(</span><em>table</em>, <em>columns</em><span class="optional">[</span>, <em>unique=False</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.add_index" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<em>str</em>) – Name of table on which to create the index.</li>
<li><strong>columns</strong> (<em>list</em>) – List of columns which should be indexed.</li>
<li><strong>unique</strong> (<em>bool</em>) – Whether the new index should specify a unique constraint.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="SchemaMigrator.drop_index">
<code class="descname">drop_index</code><span class="sig-paren">(</span><em>table</em>, <em>index_name</em><span class="sig-paren">)</span><a class="headerlink" href="#SchemaMigrator.drop_index" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>:param str table Name of the table containing the index to be dropped.
:param str index_name: Name of the index to be dropped.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="PostgresqlMigrator">
<em class="property">class </em><code class="descname">PostgresqlMigrator</code><span class="sig-paren">(</span><em>database</em><span class="sig-paren">)</span><a class="headerlink" href="#PostgresqlMigrator" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Generate migrations for Postgresql databases.</p>
</dd></dl>

<dl class="class">
<dt id="SqliteMigrator">
<em class="property">class </em><code class="descname">SqliteMigrator</code><span class="sig-paren">(</span><em>database</em><span class="sig-paren">)</span><a class="headerlink" href="#SqliteMigrator" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Generate migrations for SQLite databases.</p>
</dd></dl>

<dl class="class">
<dt id="MySQLMigrator">
<em class="property">class </em><code class="descname">MySQLMigrator</code><span class="sig-paren">(</span><em>database</em><span class="sig-paren">)</span><a class="headerlink" href="#MySQLMigrator" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Generate migrations for MySQL databases.</p>
</dd></dl>

</div>
</div>
<div class="section" id="reflection">
<span id="id14"></span><h2>リフレクション<a class="headerlink" href="#reflection" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The reflection module contains helpers for introspecting existing databases. This module is used internally by several other modules in the playhouse, including <a class="reference internal" href="#dataset"><span class="std std-ref">データセット</span></a> and <a class="reference internal" href="#pwiz"><span class="std std-ref">pwiz、モデルジェネレータ</span></a>.</p>
<dl class="class">
<dt id="Introspector">
<em class="property">class </em><code class="descname">Introspector</code><span class="sig-paren">(</span><em>metadata</em><span class="optional">[</span>, <em>schema=None</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#Introspector" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Metadata can be extracted from a database by instantiating an <a class="reference internal" href="#Introspector" title="Introspector"><code class="xref py py-class docutils literal"><span class="pre">Introspector</span></code></a>. Rather than instantiating this class directly, it is recommended to use the factory method <a class="reference internal" href="#Introspector.from_database" title="Introspector.from_database"><code class="xref py py-meth docutils literal"><span class="pre">from_database()</span></code></a>.</p>
<dl class="classmethod">
<dt id="Introspector.from_database">
<em class="property">classmethod </em><code class="descname">from_database</code><span class="sig-paren">(</span><em>database</em><span class="optional">[</span>, <em>schema=None</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#Introspector.from_database" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Creates an <a class="reference internal" href="#Introspector" title="Introspector"><code class="xref py py-class docutils literal"><span class="pre">Introspector</span></code></a> instance suitable for use with the given database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>database</strong> – a <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> instance.</li>
<li><strong>schema</strong> (<em>str</em>) – an optional schema (supported by some databases).</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">&#39;my_app.db&#39;</span><span class="p">)</span>
<span class="n">introspector</span> <span class="o">=</span> <span class="n">Introspector</span><span class="o">.</span><span class="n">from_database</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">introspector</span><span class="o">.</span><span class="n">generate_models</span><span class="p">()</span>

<span class="c1"># User and Tweet (assumed to exist in the database) are</span>
<span class="c1"># peewee Model classes generated from the database schema.</span>
<span class="n">User</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
<span class="n">Tweet</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;tweet&#39;</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="Introspector.generate_models">
<code class="descname">generate_models</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#Introspector.generate_models" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Introspect the database, reading in the tables, columns, and foreign key constraints, then generate a dictionary mapping each database table to a dynamically-generated <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> class.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">戻り値:</th><td class="field-body">A dictionary mapping table-names to model classes.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="database-url">
<span id="db-url"></span><h2>データベースのURL<a class="headerlink" href="#database-url" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>This module contains a helper function to generate a database connection from a URL connection string.</p>
<dl class="function">
<dt id="connect">
<code class="descname">connect</code><span class="sig-paren">(</span><em>url</em>, <em>**connect_params</em><span class="sig-paren">)</span><a class="headerlink" href="#connect" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Create a <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> instance from the given connection URL.</p>
<p>Examples:</p>
<ul class="simple">
<li><em>sqlite:///my_database.db</em> will create a <a class="reference internal" href="api.html#SqliteDatabase" title="SqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteDatabase</span></code></a> instance for the file <code class="docutils literal"><span class="pre">my_database.db</span></code> in the current directory.</li>
<li><em>sqlite:///:memory:</em> will create an in-memory <a class="reference internal" href="api.html#SqliteDatabase" title="SqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteDatabase</span></code></a> instance.</li>
<li><em>postgresql://postgres:my_password&#64;localhost:5432/my_database</em> will create a <a class="reference internal" href="api.html#PostgresqlDatabase" title="PostgresqlDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlDatabase</span></code></a> instance. A username and password are provided, as well as the host and port to connect to.</li>
<li><em>mysql://user:passwd&#64;ip:port/my_db</em> will create a <a class="reference internal" href="api.html#MySQLDatabase" title="MySQLDatabase"><code class="xref py py-class docutils literal"><span class="pre">MySQLDatabase</span></code></a> instance for the local MySQL database <em>my_db</em>.</li>
<li><em>mysql+pool://user:passwd&#64;ip:port/my_db?max_connections=20&amp;stale_timeout=300</em> will create a <a class="reference internal" href="#PooledMySQLDatabase" title="PooledMySQLDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledMySQLDatabase</span></code></a> instance for the local MySQL database <em>my_db</em> with max_connections set to 20 and a stale_timeout setting of 300 seconds.</li>
</ul>
<p>Supported schemes:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">apsw</span></code>: <a class="reference internal" href="#APSWDatabase" title="APSWDatabase"><code class="xref py py-class docutils literal"><span class="pre">APSWDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">mysql</span></code>: <a class="reference internal" href="api.html#MySQLDatabase" title="MySQLDatabase"><code class="xref py py-class docutils literal"><span class="pre">MySQLDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">mysql+pool</span></code>: <a class="reference internal" href="#PooledMySQLDatabase" title="PooledMySQLDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledMySQLDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">postgres</span></code>: <a class="reference internal" href="api.html#PostgresqlDatabase" title="PostgresqlDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">postgres+pool</span></code>: <a class="reference internal" href="#PooledPostgresqlDatabase" title="PooledPostgresqlDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledPostgresqlDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">postgresext</span></code>: <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">postgresext+pool</span></code>: <a class="reference internal" href="#PooledPostgresqlExtDatabase" title="PooledPostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledPostgresqlExtDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">sqlite</span></code>: <a class="reference internal" href="api.html#SqliteDatabase" title="SqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">sqliteext</span></code>: <a class="reference internal" href="#SqliteExtDatabase" title="SqliteExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteExtDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">sqlite+pool</span></code>: <a class="reference internal" href="#PooledSqliteDatabase" title="PooledSqliteDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledSqliteDatabase</span></code></a></li>
<li><code class="docutils literal"><span class="pre">sqliteext+pool</span></code>: <a class="reference internal" href="#PooledSqliteExtDatabase" title="PooledSqliteExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledSqliteExtDatabase</span></code></a></li>
</ul>
<p>Usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">playhouse.db_url</span> <span class="kn">import</span> <span class="n">connect</span>

<span class="c1"># Connect to the database URL defined in the environment, falling</span>
<span class="c1"># back to a local Sqlite database if no database URL is specified.</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATABASE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;sqlite:///default.db&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="parse">
<code class="descname">parse</code><span class="sig-paren">(</span><em>url</em><span class="sig-paren">)</span><a class="headerlink" href="#parse" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Parse the information in the given URL into a dictionary containing <code class="docutils literal"><span class="pre">database</span></code>, <code class="docutils literal"><span class="pre">host</span></code>, <code class="docutils literal"><span class="pre">port</span></code>, <code class="docutils literal"><span class="pre">user</span></code> and/or <code class="docutils literal"><span class="pre">password</span></code>. Additional connection arguments can be passed in the URL query string.</p>
<p>If you are using a custom database class, you can use the <code class="docutils literal"><span class="pre">parse()</span></code> function to extract information from a URL which can then be passed in to your database object.</p>
</dd></dl>

<dl class="function">
<dt id="register_database">
<code class="descname">register_database</code><span class="sig-paren">(</span><em>db_class</em>, <em>*names</em><span class="sig-paren">)</span><a class="headerlink" href="#register_database" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>db_class</strong> – A subclass of <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a>.</li>
<li><strong>names</strong> – A list of names to use as the scheme in the URL, e.g. 『sqlite』 or 『firebird』</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Register additional database class under the specified names. This function can be used to extend the <code class="docutils literal"><span class="pre">connect()</span></code> function to support additional schemes. Suppose you have a custom database class for <code class="docutils literal"><span class="pre">Firebird</span></code> named <code class="docutils literal"><span class="pre">FirebirdDatabase</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">playhouse.db_url</span> <span class="kn">import</span> <span class="n">connect</span><span class="p">,</span> <span class="n">register_database</span>

<span class="n">register_database</span><span class="p">(</span><span class="n">FirebirdDatabase</span><span class="p">,</span> <span class="s1">&#39;firebird&#39;</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s1">&#39;firebird://my-firebird-db&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="csv-utils">
<span id="id15"></span><h2>CSV Utils<a class="headerlink" href="#csv-utils" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>This module contains helpers for dumping queries into CSV, and for loading CSV data into a database.  CSV files can be introspected to generate an appropriate model class for working with the data. This makes it really easy to explore the data in a CSV file using Peewee and SQL.</p>
<p>Here is how you would load a CSV file into an in-memory SQLite database.  The call to <a class="reference internal" href="#load_csv" title="load_csv"><code class="xref py py-func docutils literal"><span class="pre">load_csv()</span></code></a> returns a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> instance suitable for working with the CSV data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">playhouse.csv_loader</span> <span class="kn">import</span> <span class="n">load_csv</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>
<span class="n">ZipToTZ</span> <span class="o">=</span> <span class="n">load_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;zip_to_tz.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can run queries using the new model.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="go"># Get the timezone for a zipcode.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">zip</span> <span class="o">==</span> <span class="mi">66047</span><span class="p">)</span><span class="o">.</span><span class="n">timezone</span>
<span class="go">&#39;US/Central&#39;</span>

<span class="go"># Get all the zipcodes for my town.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">zip</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ZipToTZ</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">(</span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">city</span> <span class="o">==</span> <span class="s1">&#39;Lawrence&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ZipToTZ</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;KS&#39;</span><span class="p">))]</span>
<span class="go">[66044, 66045, 66046, 66047, 66049]</span>
</pre></div>
</div>
<p>For more information and examples check out this <a class="reference external" href="http://charlesleifer.com/blog/using-peewee-to-explore-csv-files/">blog post</a>.</p>
<div class="section" id="csv-loader-api">
<h3>CSV Loader API<a class="headerlink" href="#csv-loader-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="function">
<dt id="load_csv">
<code class="descname">load_csv</code><span class="sig-paren">(</span><em>db_or_model</em>, <em>filename</em><span class="optional">[</span>, <em>fields=None</em><span class="optional">[</span>, <em>field_names=None</em><span class="optional">[</span>, <em>has_header=True</em><span class="optional">[</span>, <em>sample_size=10</em><span class="optional">[</span>, <em>converter=None</em><span class="optional">[</span>, <em>db_table=None</em><span class="optional">[</span>, <em>**reader_kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#load_csv" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Load a CSV file into the provided database or model class, returning a
<a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> suitable for working with the CSV data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first simple">
<li><strong>db_or_model</strong> – Either a <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> instance or a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> class.  If a model is not provided, one will be automatically generated for you.</li>
<li><strong>filename</strong> (<em>str</em>) – Path of CSV file to load.</li>
<li><strong>fields</strong> (<em>list</em>) – A list of <code class="xref py py-class docutils literal"><span class="pre">Field</span></code> instances mapping to each column in the CSV.  This allows you to manually specify the column types.  If not provided, and a model is not provided, the field types will be determined automatically.</li>
<li><strong>field_names</strong> (<em>list</em>) – A list of strings to use as field names for each column in the CSV.  If not provided, and a model is not provided, the field names will be determined by looking at the header row of the file.  If no header exists, then the fields will be given generic names.</li>
<li><strong>has_header</strong> (<em>bool</em>) – Whether the first row is a header.</li>
<li><strong>sample_size</strong> (<em>int</em>) – Number of rows to look at when introspecting data types.  If set to <code class="docutils literal"><span class="pre">0</span></code>, then a generic field type will be used for all fields.</li>
<li><strong>converter</strong> (<em>RowConverter</em>) – a <code class="xref py py-class docutils literal"><span class="pre">RowConverter</span></code> instance to use for introspecting the CSV.  If not provided, one will be created.</li>
<li><strong>db_table</strong> (<em>str</em>) – The name of the database table to load data into.  If this value is not provided, it will be determined using the filename of the CSV file.  If a model is provided, this value is ignored.</li>
<li><strong>reader_kwargs</strong> – Arbitrary keyword arguments to pass to the <code class="docutils literal"><span class="pre">csv.reader</span></code> object, such as the dialect, separator, etc.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">戻り値の型:</th><td class="field-body"><p class="first last">A <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> suitable for querying the CSV data.</p>
</td>
</tr>
</tbody>
</table>
<p>Basic example – field names and types will be introspected:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">playhouse.csv_loader</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>
<span class="n">User</span> <span class="o">=</span> <span class="n">load_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;users.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Using a pre-defined model:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ZipToTZ</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">zip</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>

<span class="n">load_csv</span><span class="p">(</span><span class="n">ZipToTZ</span><span class="p">,</span> <span class="s1">&#39;zip_to_tz.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Specifying fields:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">DecimalField</span><span class="p">(),</span> <span class="n">IntegerField</span><span class="p">(),</span> <span class="n">IntegerField</span><span class="p">(),</span> <span class="n">DateField</span><span class="p">()]</span>
<span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;from_acct&#39;</span><span class="p">,</span> <span class="s1">&#39;to_acct&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
<span class="n">Payments</span> <span class="o">=</span> <span class="n">load_csv</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;payments.csv&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">field_names</span><span class="o">=</span><span class="n">field_names</span><span class="p">,</span> <span class="n">has_header</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="dumping-csv">
<h3>Dumping CSV<a class="headerlink" href="#dumping-csv" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="function">
<dt id="dump_csv">
<code class="descname">dump_csv</code><span class="sig-paren">(</span><em>query</em>, <em>file_or_name</em><span class="optional">[</span>, <em>include_header=True</em><span class="optional">[</span>, <em>close_file=True</em><span class="optional">[</span>, <em>append=True</em><span class="optional">[</span>, <em>csv_writer=None</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#dump_csv" title="この定義へのパーマリンク">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>query</strong> – A peewee <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> to dump as CSV.</li>
<li><strong>file_or_name</strong> – Either a filename or a file-like object.</li>
<li><strong>include_header</strong> – Whether to generate a CSV header row consisting of the names of the selected columns.</li>
<li><strong>close_file</strong> – Whether the file should be closed after writing the query data.</li>
<li><strong>append</strong> – Whether new data should be appended to the end of the file.</li>
<li><strong>csv_writer</strong> – A python <code class="docutils literal"><span class="pre">csv.writer</span></code> instance to use.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Example usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;account-export.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Account</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">dump_csv</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="connection-pool">
<span id="pool"></span><h2>コネクションプール<a class="headerlink" href="#connection-pool" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">pool</span></code> module contains a number of <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> classes that provide connection pooling for PostgreSQL and MySQL databases. The pool works by overriding the methods on the <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> class that open and close connections to the backend. The pool can specify a timeout after which connections are recycled, as well as an upper bound on the number of open connections.</p>
<p>In a multi-threaded application, up to <cite>max_connections</cite> will be opened. Each thread (or, if using gevent, greenlet) will have it’s own connection.</p>
<p>In a single-threaded application, only one connection will be created. It will be continually recycled until either it exceeds the stale timeout or is closed explicitly (using <cite>.manual_close()</cite>).</p>
<p><strong>By default, all your application needs to do is ensure that connections are closed when you are finished with them, and they will be returned to the pool</strong>. For web applications, this typically means that at the beginning of a request, you will open a connection, and when you return a response, you will close the connection.</p>
<p>Simple Postgres pool example code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Use the special postgresql extensions.</span>
<span class="kn">from</span> <span class="nn">playhouse.pool</span> <span class="kn">import</span> <span class="n">PooledPostgresqlExtDatabase</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">PooledPostgresqlExtDatabase</span><span class="p">(</span>
    <span class="s1">&#39;my_app&#39;</span><span class="p">,</span>
    <span class="n">max_connections</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">stale_timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 minutes.</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>
</pre></div>
</div>
<p>That’s it! If you would like finer-grained control over the pool of connections, check out the <a class="reference internal" href="database.html#advanced-connection-management"><span class="std std-ref">高度な接続管理</span></a> section.</p>
<div class="section" id="pool-apis">
<h3>Pool APIs<a class="headerlink" href="#pool-apis" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="PooledDatabase">
<em class="property">class </em><code class="descname">PooledDatabase</code><span class="sig-paren">(</span><em>database</em><span class="optional">[</span>, <em>max_connections=20</em><span class="optional">[</span>, <em>stale_timeout=None</em><span class="optional">[</span>, <em>timeout=None</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#PooledDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Mixin class intended to be used with a subclass of <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>database</strong> (<em>str</em>) – The name of the database or database file.</li>
<li><strong>max_connections</strong> (<em>int</em>) – Maximum number of connections. Provide <code class="docutils literal"><span class="pre">None</span></code> for unlimited.</li>
<li><strong>stale_timeout</strong> (<em>int</em>) – Number of seconds to allow connections to be used.</li>
<li><strong>timeout</strong> (<em>int</em>) – Number of seconds block when pool is full. By default peewee does not block when the pool is full but simply throws an exception. To block indefinitely set this value to <code class="docutils literal"><span class="pre">0</span></code>.</li>
<li><strong>kwargs</strong> – Arbitrary keyword arguments passed to database class.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">Connections will not be closed exactly when they exceed their <cite>stale_timeout</cite>. Instead, stale connections are only closed when a new connection is requested.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">If the number of open connections exceeds <cite>max_connections</cite>, a <cite>ValueError</cite> will be raised.</p>
</div>
<dl class="method">
<dt id="PooledDatabase._connect">
<code class="descname">_connect</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#PooledDatabase._connect" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Request a connection from the pool. If there are no available connections a new one will be opened.</p>
</dd></dl>

<dl class="method">
<dt id="PooledDatabase._close">
<code class="descname">_close</code><span class="sig-paren">(</span><em>conn</em><span class="optional">[</span>, <em>close_conn=False</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#PooledDatabase._close" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>By default <cite>conn</cite> will not be closed and instead will be returned to the pool of available connections. If <cite>close_conn=True</cite>, then <cite>conn</cite> will be closed and <em>not</em> be returned to the pool.</p>
</dd></dl>

<dl class="method">
<dt id="PooledDatabase.manual_close">
<code class="descname">manual_close</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PooledDatabase.manual_close" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Close the currently-open connection without returning it to the pool.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="PooledPostgresqlDatabase">
<em class="property">class </em><code class="descname">PooledPostgresqlDatabase</code><a class="headerlink" href="#PooledPostgresqlDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="api.html#PostgresqlDatabase" title="PostgresqlDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlDatabase</span></code></a> that mixes in the <a class="reference internal" href="#PooledDatabase" title="PooledDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledDatabase</span></code></a> helper.</p>
</dd></dl>

<dl class="class">
<dt id="PooledPostgresqlExtDatabase">
<em class="property">class </em><code class="descname">PooledPostgresqlExtDatabase</code><a class="headerlink" href="#PooledPostgresqlExtDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a> that mixes in the <a class="reference internal" href="#PooledDatabase" title="PooledDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledDatabase</span></code></a> helper. The <a class="reference internal" href="#PostgresqlExtDatabase" title="PostgresqlExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlExtDatabase</span></code></a> is a part of the
<a class="reference internal" href="#postgres-ext"><span class="std std-ref">PostgreSQLの拡張機能</span></a> module and provides support for many Postgres-specific
features.</p>
</dd></dl>

<dl class="class">
<dt id="PooledMySQLDatabase">
<em class="property">class </em><code class="descname">PooledMySQLDatabase</code><a class="headerlink" href="#PooledMySQLDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Subclass of <a class="reference internal" href="api.html#MySQLDatabase" title="MySQLDatabase"><code class="xref py py-class docutils literal"><span class="pre">MySQLDatabase</span></code></a> that mixes in the <a class="reference internal" href="#PooledDatabase" title="PooledDatabase"><code class="xref py py-class docutils literal"><span class="pre">PooledDatabase</span></code></a> helper.</p>
</dd></dl>

<dl class="class">
<dt id="PooledSqliteDatabase">
<em class="property">class </em><code class="descname">PooledSqliteDatabase</code><a class="headerlink" href="#PooledSqliteDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Persistent connections for SQLite apps.</p>
</dd></dl>

<dl class="class">
<dt id="PooledSqliteExtDatabase">
<em class="property">class </em><code class="descname">PooledSqliteExtDatabase</code><a class="headerlink" href="#PooledSqliteExtDatabase" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Persistent connections for SQLite apps, using the <a class="reference internal" href="#sqlite-ext"><span class="std std-ref">Sqlite拡張</span></a> advanced database driver <a class="reference internal" href="#SqliteExtDatabase" title="SqliteExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteExtDatabase</span></code></a>.</p>
</dd></dl>

</div>
</div>
<div class="section" id="read-slaves">
<span id="id17"></span><h2>スレーブを読み込む<a class="headerlink" href="#read-slaves" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">read_slave</span></code> module contains a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> subclass that can be used
to automatically execute <code class="docutils literal"><span class="pre">SELECT</span></code> queries against different database(s). This
might be useful if you have your databases in a master / slave configuration.</p>
<dl class="class">
<dt id="ReadSlaveModel">
<em class="property">class </em><code class="descname">ReadSlaveModel</code><a class="headerlink" href="#ReadSlaveModel" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Model subclass that will route <code class="docutils literal"><span class="pre">SELECT</span></code> queries to a different database.</p>
<p>Master and read-slaves are specified using <code class="docutils literal"><span class="pre">Model.Meta</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Declare a master and two read-replicas.</span>
<span class="n">master</span> <span class="o">=</span> <span class="n">PostgresqlDatabase</span><span class="p">(</span><span class="s1">&#39;master&#39;</span><span class="p">)</span>
<span class="n">replica_1</span> <span class="o">=</span> <span class="n">PostgresqlDatabase</span><span class="p">(</span><span class="s1">&#39;replica_1&#39;</span><span class="p">)</span>
<span class="n">replica_2</span> <span class="o">=</span> <span class="n">PostgresqlDatabase</span><span class="p">(</span><span class="s1">&#39;replica_2&#39;</span><span class="p">)</span>

<span class="c1"># Declare a BaseModel, the normal best-practice.</span>
<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">ReadSlaveModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">master</span>
        <span class="n">read_slaves</span> <span class="o">=</span> <span class="p">(</span><span class="n">replica_1</span><span class="p">,</span> <span class="n">replica_2</span><span class="p">)</span>

<span class="c1"># Declare your models.</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
</pre></div>
</div>
<p>When you execute writes (or deletes), they will be executed against the
master database:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;Peewee&#39;</span><span class="p">)</span>  <span class="c1"># Executed against master.</span>
</pre></div>
</div>
<p>When you execute a read query, it will run against one of the replicas:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;Peewee&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p>To force a <code class="docutils literal"><span class="pre">SELECT</span></code> query against the master database, manually create
the <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>.</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="n">SelectQuery</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>  <span class="c1"># master database.</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">Queries will be dispatched among the <code class="docutils literal"><span class="pre">read_slaves</span></code> in round-robin fashion.</p>
</div>
</dd></dl>

</div>
<div class="section" id="test-utils">
<span id="id18"></span><h2>Test Utils<a class="headerlink" href="#test-utils" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Contains utilities helpful when testing peewee projects.</p>
<dl class="class">
<dt id="test_database">
<em class="property">class </em><code class="descname">test_database</code><span class="sig-paren">(</span><em>db</em>, <em>models</em><span class="optional">[</span>, <em>create_tables=True</em><span class="optional">[</span>, <em>fail_silently=False</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#test_database" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Context manager that lets you use a different database with a set of
models.  Models can also be automatically created and dropped.</p>
<p>This context manager helps make it possible to test your peewee models
using a 「test-only」 database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>db</strong> (<a class="reference internal" href="api.html#Database" title="Database"><em>Database</em></a>) – Database to use with the given models</li>
<li><strong>models</strong> – a <code class="docutils literal"><span class="pre">list</span></code> or <code class="docutils literal"><span class="pre">tuple</span></code> of <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> classes to use with the <code class="docutils literal"><span class="pre">db</span></code></li>
<li><strong>create_tables</strong> (<em>boolean</em>) – Whether tables should be automatically created
and dropped.</li>
<li><strong>fail_silently</strong> (<em>boolean</em>) – Whether the table create / drop should fail
silently.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">playhouse.test_utils</span> <span class="kn">import</span> <span class="n">test_database</span>
<span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">my_app.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Tweet</span>

<span class="n">test_db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestUsersTweets</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ... create a bunch of users and tweets</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;user-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_timeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">test_database</span><span class="p">(</span><span class="n">test_db</span><span class="p">,</span> <span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Tweet</span><span class="p">)):</span>
            <span class="c1"># This data will be created in `test_db`</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_test_data</span><span class="p">()</span>

            <span class="c1"># Perform assertions on test data inside ctx manager.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">timeline</span><span class="p">(</span><span class="s1">&#39;user-0&#39;</span><span class="p">)</span> <span class="p">[</span><span class="o">...</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">test_database</span><span class="p">(</span><span class="n">test_db</span><span class="p">,</span> <span class="p">(</span><span class="n">User</span><span class="p">,)):</span>
            <span class="c1"># Test something that just affects user.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_some_user_thing</span><span class="p">()</span>

        <span class="c1"># once we exit the context manager, we&#39;re back to using the normal database</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="count_queries">
<em class="property">class </em><code class="descname">count_queries</code><span class="sig-paren">(</span><span class="optional">[</span><em>only_select=False</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#count_queries" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Context manager that will count the number of queries executed within
the context.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><strong>only_select</strong> (<em>bool</em>) – Only count <em>SELECT</em> queries.</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">count_queries</span><span class="p">()</span> <span class="k">as</span> <span class="n">counter</span><span class="p">:</span>
    <span class="n">huey</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;huey&#39;</span><span class="p">)</span>
    <span class="n">huey_tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span> <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">huey</span><span class="o">.</span><span class="n">tweets</span><span class="p">]</span>

<span class="k">assert</span> <span class="n">counter</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<dl class="attribute">
<dt id="count_queries.count">
<code class="descname">count</code><a class="headerlink" href="#count_queries.count" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>The number of queries executed.</p>
</dd></dl>

<dl class="method">
<dt id="count_queries.get_queries">
<code class="descname">get_queries</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#count_queries.get_queries" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return a list of 2-tuples consisting of the SQL query and a list of
parameters.</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="assert_query_count">
<code class="descname">assert_query_count</code><span class="sig-paren">(</span><em>expected</em><span class="optional">[</span>, <em>only_select=False</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#assert_query_count" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Function or method decorator that will raise an <code class="docutils literal"><span class="pre">AssertionError</span></code> if the
number of queries executed in the decorated function does not equal the
expected number.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestMyApp</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@assert_query_count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_get_popular_blogs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">popular_blogs</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">get_popular</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="p">[</span><span class="n">blog</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">blog</span> <span class="ow">in</span> <span class="n">popular_blogs</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Peewee&#39;s Playhouse!&quot;</span><span class="p">,</span> <span class="s2">&quot;All About Huey&quot;</span><span class="p">,</span> <span class="s2">&quot;Mickey&#39;s Adventures&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>This function can also be used as a context manager:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestMyApp</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_expensive_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">assert_query_count</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">perform_expensive_operation</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="pskel">
<span id="id19"></span><h2>pskel<a class="headerlink" href="#pskel" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>I often find myself writing very small scripts with peewee. <em>pskel</em> will generate the boilerplate code for a basic peewee script.</p>
<p>Usage:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="go">pskel [options] model1 model2 ...</span>
</pre></div>
</div>
<p><em>pskel</em> accepts the following options:</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="19%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">-l,--logging</span></code></td>
<td>False</td>
<td>Log all queries to stdout.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">-e,--engine</span></code></td>
<td>sqlite</td>
<td>Database driver to use.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">-d,--database</span></code></td>
<td><code class="docutils literal"><span class="pre">:memory:</span></code></td>
<td>Database to connect to.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="go">$ pskel -e postgres -d my_database User Tweet</span>
</pre></div>
</div>
<p>This will print the following code to <em>stdout</em> (which you can redirect into a file using <code class="docutils literal"><span class="pre">&gt;</span></code>):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="n">create_model_tables</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">PostgresqlDatabase</span><span class="p">(</span><span class="s1">&#39;my_database&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Tweet</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">create_model_tables</span><span class="p">([</span><span class="n">User</span><span class="p">,</span> <span class="n">Tweet</span><span class="p">],</span> <span class="n">fail_silently</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="flask-utils">
<span id="id20"></span><h2>Flask Utils<a class="headerlink" href="#flask-utils" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">playhouse.flask_utils</span></code> module contains several helpers for integrating peewee with the <a class="reference external" href="http://flask.pocoo.org/">Flask</a> web framework.</p>
<div class="section" id="database-wrapper">
<h3>Database Wrapper<a class="headerlink" href="#database-wrapper" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>The <code class="xref py py-class docutils literal"><span class="pre">FlaskDB</span></code> class is a wrapper for configuring and referencing a
Peewee database from within a Flask application. Don’t let it’s name fool you:
it is <strong>not the same thing as a peewee database</strong>. <code class="docutils literal"><span class="pre">FlaskDB</span></code> is designed to
remove the following boilerplate from your flask app:</p>
<ul class="simple">
<li>Dynamically create a Peewee database instance based on app config data.</li>
<li>Create a base class from which all your application’s models will descend.</li>
<li>Register hooks at the start and end of a request to handle opening and
closing a database connection.</li>
</ul>
<p>Basic usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">playhouse.flask_utils</span> <span class="kn">import</span> <span class="n">FlaskDB</span>

<span class="n">DATABASE</span> <span class="o">=</span> <span class="s1">&#39;postgresql://postgres:password@localhost:5432/my_database&#39;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">db_wrapper</span> <span class="o">=</span> <span class="n">FlaskDB</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db_wrapper</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Tweet</span><span class="p">(</span><span class="n">db_wrapper</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;tweets&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code example will create and instantiate a peewee <a class="reference internal" href="api.html#PostgresqlDatabase" title="PostgresqlDatabase"><code class="xref py py-class docutils literal"><span class="pre">PostgresqlDatabase</span></code></a> specified by the given database URL. Request hooks will be configured to establish a connection when a request is received, and automatically close the connection when the response is sent. Lastly, the <code class="xref py py-class docutils literal"><span class="pre">FlaskDB</span></code> class exposes a <code class="xref py py-attr docutils literal"><span class="pre">FlaskDB.Model</span></code> property which can be used as a base for your application’s models.</p>
<p>Here is how you can access the wrapped Peewee database instance that is
configured for you by the <code class="docutils literal"><span class="pre">FlaskDB</span></code> wrapper:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Obtain a reference to the Peewee database instance.</span>
<span class="n">peewee_db</span> <span class="o">=</span> <span class="n">db_wrapper</span><span class="o">.</span><span class="n">database</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/transfer-funds/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">transfer_funds</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">peewee_db</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
        <span class="c1"># ...</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;transfer-id&#39;</span><span class="p">:</span> <span class="n">xid</span><span class="p">})</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">The actual peewee database can be accessed using the <code class="docutils literal"><span class="pre">FlaskDB.database</span></code> attribute.</p>
</div>
<p>Here is another way to configure a Peewee database using <code class="docutils literal"><span class="pre">FlaskDB</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">db_wrapper</span> <span class="o">=</span> <span class="n">FlaskDB</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;sqlite:///my_app.db&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>While the above examples show using a database URL, for more advanced usages you can specify a dictionary of configuration options, or simply pass in a peewee <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">DATABASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;my_app_db&#39;</span><span class="p">,</span>
    <span class="s1">&#39;engine&#39;</span><span class="p">:</span> <span class="s1">&#39;playhouse.pool.PooledPostgresqlDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
    <span class="s1">&#39;max_connections&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
    <span class="s1">&#39;stale_timeout&#39;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">wrapper</span> <span class="o">=</span> <span class="n">FlaskDB</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">pooled_postgres_db</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">database</span>
</pre></div>
</div>
<p>Using a peewee <a class="reference internal" href="api.html#Database" title="Database"><code class="xref py py-class docutils literal"><span class="pre">Database</span></code></a> object:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">peewee_db</span> <span class="o">=</span> <span class="n">PostgresqlExtDatabase</span><span class="p">(</span><span class="s1">&#39;my_app&#39;</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">db_wrapper</span> <span class="o">=</span> <span class="n">FlaskDB</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">peewee_db</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="database-with-application-factory">
<h3>Database with Application Factory<a class="headerlink" href="#database-with-application-factory" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>If you prefer to use the <a class="reference external" href="http://flask.pocoo.org/docs/0.10/patterns/appfactories/">application factory pattern</a>, the <code class="xref py py-class docutils literal"><span class="pre">FlaskDB</span></code> class implements an <code class="docutils literal"><span class="pre">init_app()</span></code> method.</p>
<p>Using as a factory:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">db_wrapper</span> <span class="o">=</span> <span class="n">FlaskDB</span><span class="p">()</span>

<span class="c1"># Even though the database is not yet initialized, you can still use the</span>
<span class="c1"># `Model` property to create model classes.</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db_wrapper</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATABASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:////home/code/apps/my-database.db&#39;</span>
    <span class="n">db_wrapper</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
</div>
<div class="section" id="query-utilities">
<h3>Query utilities<a class="headerlink" href="#query-utilities" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">flask_utils</span></code> module provides several helpers for managing queries in your web app. Some common patterns include:</p>
<dl class="function">
<dt id="get_object_or_404">
<code class="descname">get_object_or_404</code><span class="sig-paren">(</span><em>query_or_model</em>, <em>*query</em><span class="sig-paren">)</span><a class="headerlink" href="#get_object_or_404" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Retrieve the object matching the given query, or return a 404 not found response. A common use-case might be a detail page for a weblog. You want to either retrieve the post matching the given URL, or return a 404.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>query_or_model</strong> – Either a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> class or a pre-filtered <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a>.</li>
<li><strong>query</strong> – An arbitrarily complex peewee expression.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/blog/&lt;slug&gt;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_detail</span><span class="p">(</span><span class="n">slug</span><span class="p">):</span>
    <span class="n">public_posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">published</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">public_posts</span><span class="p">,</span> <span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">slug</span> <span class="o">==</span> <span class="n">slug</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;post_detail.html&#39;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="object_list">
<code class="descname">object_list</code><span class="sig-paren">(</span><em>template_name</em>, <em>query</em><span class="optional">[</span>, <em>context_variable='object_list'</em><span class="optional">[</span>, <em>paginate_by=20</em><span class="optional">[</span>, <em>page_var='page'</em><span class="optional">[</span>, <em>check_bounds=True</em><span class="optional">[</span>, <em>**kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#object_list" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Retrieve a paginated list of objects specified by the given query. The paginated object list will be dropped into the context using the given <code class="docutils literal"><span class="pre">context_variable</span></code>, as well as metadata about the current page and total number of pages, and finally any arbitrary context data passed as keyword-arguments.</p>
<p>The page is specified using the <code class="docutils literal"><span class="pre">page</span></code> <code class="docutils literal"><span class="pre">GET</span></code> argument, e.g. <code class="docutils literal"><span class="pre">/my-object-list/?page=3</span></code> would return the third page of objects.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>template_name</strong> – The name of the template to render.</li>
<li><strong>query</strong> – A <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> instance to paginate.</li>
<li><strong>context_variable</strong> – The context variable name to use for the paginated object list.</li>
<li><strong>paginate_by</strong> – Number of objects per-page.</li>
<li><strong>page_var</strong> – The name of the <code class="docutils literal"><span class="pre">GET</span></code> argument which contains the page.</li>
<li><strong>check_bounds</strong> – Whether to check that the given page is a valid page. If <code class="docutils literal"><span class="pre">check_bounds</span></code> is <code class="docutils literal"><span class="pre">True</span></code> and an invalid page is specified, then a 404 will be returned.</li>
<li><strong>kwargs</strong> – Arbitrary key/value pairs to pass into the template context.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/blog/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_index</span><span class="p">():</span>
    <span class="n">public_posts</span> <span class="o">=</span> <span class="p">(</span><span class="n">Post</span>
                    <span class="o">.</span><span class="n">select</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">published</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">object_list</span><span class="p">(</span>
        <span class="s1">&#39;post_index.html&#39;</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">public_posts</span><span class="p">,</span>
        <span class="n">context_variable</span><span class="o">=</span><span class="s1">&#39;post_list&#39;</span><span class="p">,</span>
        <span class="n">paginate_by</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>The template will have the following context:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">post_list</span></code>, which contains a list of up to 10 posts.</li>
<li><code class="docutils literal"><span class="pre">page</span></code>, which contains the current page based on the value of the <code class="docutils literal"><span class="pre">page</span></code> <code class="docutils literal"><span class="pre">GET</span></code> parameter.</li>
<li><code class="docutils literal"><span class="pre">pagination</span></code>, a <a class="reference internal" href="#PaginatedQuery" title="PaginatedQuery"><code class="xref py py-class docutils literal"><span class="pre">PaginatedQuery</span></code></a> instance.</li>
</ul>
</dd></dl>

<dl class="class">
<dt id="PaginatedQuery">
<em class="property">class </em><code class="descname">PaginatedQuery</code><span class="sig-paren">(</span><em>query_or_model</em>, <em>paginate_by</em><span class="optional">[</span>, <em>page_var='page'</em><span class="optional">[</span>, <em>check_bounds=False</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#PaginatedQuery" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Helper class to perform pagination based on <code class="docutils literal"><span class="pre">GET</span></code> arguments.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">パラメータ:</th><td class="field-body"><ul class="first last simple">
<li><strong>query_or_model</strong> – Either a <a class="reference internal" href="api.html#Model" title="Model"><code class="xref py py-class docutils literal"><span class="pre">Model</span></code></a> or a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> instance containing the collection of records you wish to paginate.</li>
<li><strong>paginate_by</strong> – Number of objects per-page.</li>
<li><strong>page_var</strong> – The name of the <code class="docutils literal"><span class="pre">GET</span></code> argument which contains the page.</li>
<li><strong>check_bounds</strong> – Whether to check that the given page is a valid page. If <code class="docutils literal"><span class="pre">check_bounds</span></code> is <code class="docutils literal"><span class="pre">True</span></code> and an invalid page is specified, then a 404 will be returned.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="PaginatedQuery.get_page">
<code class="descname">get_page</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PaginatedQuery.get_page" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return the currently selected page, as indicated by the value of the <code class="docutils literal"><span class="pre">page_var</span></code> <code class="docutils literal"><span class="pre">GET</span></code> parameter. If no page is explicitly selected, then this method will return 1, indicating the first page.</p>
</dd></dl>

<dl class="method">
<dt id="PaginatedQuery.get_page_count">
<code class="descname">get_page_count</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PaginatedQuery.get_page_count" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Return the total number of possible pages.</p>
</dd></dl>

<dl class="method">
<dt id="PaginatedQuery.get_object_list">
<code class="descname">get_object_list</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#PaginatedQuery.get_object_list" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Using the value of <a class="reference internal" href="#PaginatedQuery.get_page" title="PaginatedQuery.get_page"><code class="xref py py-meth docutils literal"><span class="pre">get_page()</span></code></a>, return the page of objects requested by the user. The return value is a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><code class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></code></a> with the appropriate <code class="docutils literal"><span class="pre">LIMIT</span></code> and <code class="docutils literal"><span class="pre">OFFSET</span></code> clauses.</p>
<p>If <code class="docutils literal"><span class="pre">check_bounds</span></code> was set to <code class="docutils literal"><span class="pre">True</span></code> and the requested page contains no objects, then a 404 will be raised.</p>
</dd></dl>

</dd></dl>

</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api.html" class="btn btn-neutral float-right" title="APIリファレンス" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="transactions.html" class="btn btn-neutral" title="トランザクション" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright charles leifer.

    </p>
  </div>
 

<div role="contentinfo">
<p>このサイトは<a href="http://a-zumi.net">あずみ.net</a>が翻訳しております。</p>
<p>サイトを利用したことによる直接的、付随的、結果的、間接的、あるいは懲罰的な損害、経費、損失、または
債務について、いかなる責任も負いかねます。</p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.10.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23705195-42"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-23705195-42');
</script>


</body>
</html>