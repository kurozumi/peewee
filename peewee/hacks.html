

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Hacks &mdash; peewee 2.10.2 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/modified_theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="検索" href="../search.html"/>
    <link rel="top" title="peewee 2.10.2 ドキュメント" href="../index.html"/>
        <link rel="prev" title="APIリファレンス" href="api.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> peewee
          

          
          </a>

          
            
            
              <div class="version">
                2.10.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">インストールとテスト</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">クイックスタート</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html">サンプル・アプリケーション</a></li>
<li class="toctree-l1"><a class="reference internal" href="more-resources.html">その他のリソース</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">貢献する</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">データベースの管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">モデルとフィールド</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html">クエリ</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html#query-operators">クエリ演算子</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html#foreign-keys">外部キー</a></li>
<li class="toctree-l1"><a class="reference internal" href="querying.html#performance-techniques">パフォーマンステクニック</a></li>
<li class="toctree-l1"><a class="reference internal" href="transactions.html">トランザクション</a></li>
<li class="toctree-l1"><a class="reference internal" href="playhouse.html">Playhouse。Peeweeへの拡張</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">APIリファレンス</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hacks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#optimistic-locking">Optimistic Locking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#top-object-per-group">Top object per group</a></li>
<li class="toctree-l2"><a class="reference internal" href="#top-n-objects-per-group">Top N objects per group</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#postgres-lateral-joins">Postgres lateral joins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#window-functions">ウィンドウ関数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-methods">Other methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writing-custom-functions-with-sqlite">Writing custom functions with SQLite</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">peewee</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Hacks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div class="note" style="text-align:center">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- kurozumi.github.io/peewee/ 336*280 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:336px;height:280px"
     data-ad-client="ca-pub-6843356127740583"
     data-ad-slot="2268187197"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

<div class="section" id="hacks">
<span id="id1"></span><h1>Hacks<a class="headerlink" href="#hacks" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>Collected hacks using peewee. Have a cool hack you’d like to share? Open <a class="reference external" href="https://github.com/coleifer/peewee/issues/new">an issue on GitHub</a> or <a class="reference external" href="http://charlesleifer.com/contact/">contact me</a>.</p>
<div class="section" id="optimistic-locking">
<span id="id2"></span><h2>Optimistic Locking<a class="headerlink" href="#optimistic-locking" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Optimistic locking is useful in situations where you might ordinarily use a
<em>SELECT FOR UPDATE</em> (or in SQLite, <em>BEGIN IMMEDIATE</em>). For example, you might
fetch a user record from the database, make some modifications, then save the
modified user record. Typically this scenario would require us to lock the user
record for the duration of the transaction, from the moment we select it, to
the moment we save our changes.</p>
<p>In optimistic locking, on the other hand, we do <em>not</em> acquire any lock and
instead rely on an internal <em>version</em> column in the row we’re modifying. At
read time, we see what version the row is currently at, and on save, we ensure
that the update takes place only if the version is the same as the one we
initially read. If the version is higher, then some other process must have
snuck in and changed the row – to save our modified version could result in
the loss of important changes.</p>
<p>It’s quite simple to implement optimistic locking in Peewee, here is a base
class that you can use as a starting point:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">BaseVersionedModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_optimistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="c1"># This is a new record, so the default logic is to perform an</span>
            <span class="c1"># INSERT. Ideally your model would also have a unique</span>
            <span class="c1"># constraint that made it impossible for two INSERTs to happen</span>
            <span class="c1"># at the same time.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># Update any data that has changed and bump the version counter.</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="n">current_version</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty_fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No changes have been made.&#39;</span><span class="p">)</span>

        <span class="n">ModelClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Atomic increment.</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">field_data</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">ModelClass</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">current_version</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">ModelClass</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No rows were updated, indicating another process has saved</span>
            <span class="c1"># a new version. How you handle this situation is up to you,</span>
            <span class="c1"># but for simplicity I&#39;m just raising an exception.</span>
            <span class="k">raise</span> <span class="n">ConflictDetectedException</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Increment local version to match what is now in the db.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Here’s an example of how this works. Let’s assume we have the following model
definition. Note that there’s a unique constraint on the username – this is
important as it provides a way to prevent double-inserts.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseVersionedModel</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">favorite_animal</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
</pre></div>
</div>
<p>例:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;charlie&#39;</span><span class="p">,</span> <span class="n">favorite_animal</span><span class="o">=</span><span class="s1">&#39;cat&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">save_optimistic</span><span class="p">()</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">version</span>
<span class="go">1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">save_optimistic</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;x.py&quot;</span>, line <span class="m">18</span>, in <span class="n">save_optimistic</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No changes have been made.&#39;</span><span class="p">)</span>
<span class="gr">ValueError</span>: <span class="n">No changes have been made.</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">favorite_animal</span> <span class="o">=</span> <span class="s1">&#39;kitten&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">save_optimistic</span><span class="p">()</span>
<span class="go">True</span>

<span class="go"># Simulate a separate thread coming in and updating the model.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;charlie&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">favorite_animal</span> <span class="o">=</span> <span class="s1">&#39;macaw&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">save_optimistic</span><span class="p">()</span>
<span class="go">True</span>

<span class="go"># Now, attempt to change and re-save the original instance:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">favorite_animal</span> <span class="o">=</span> <span class="s1">&#39;little parrot&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">save_optimistic</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;x.py&quot;</span>, line <span class="m">30</span>, in <span class="n">save_optimistic</span>
    <span class="k">raise</span> <span class="n">ConflictDetectedException</span><span class="p">()</span>
<span class="gr">ConflictDetectedException</span>: <span class="n">current version is out of sync</span>
</pre></div>
</div>
</div>
<div class="section" id="top-object-per-group">
<span id="top-item-per-group"></span><h2>Top object per group<a class="headerlink" href="#top-object-per-group" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>These examples describe several ways to query the single top item per group. For a thorough discuss of various techniques, check out my blog post <a class="reference external" href="http://charlesleifer.com/blog/techniques-for-querying-lists-of-objects-and-determining-the-top-related-item/">Querying the top item by group with Peewee ORM</a>. If you are interested in the more general problem of querying the top <em>N</em> items, see the section below <a class="reference internal" href="#top-n-per-group"><span class="std std-ref">Top N objects per group</span></a>.</p>
<p>In these examples we will use the <em>User</em> and <em>Tweet</em> models to find each user and their most-recent tweet.</p>
<p>The most efficient method I found in my testing uses the <code class="docutils literal"><span class="pre">MAX()</span></code> aggregate function.</p>
<p>We will perform the aggregation in a non-correlated subquery, so we can be confident this method will be performant. The idea is that we will select the posts, grouped by their author, whose timestamp is equal to the max observed timestamp for that user.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># When referencing a table multiple times, we&#39;ll call Model.alias() to create</span>
<span class="c1"># a secondary reference to the table.</span>
<span class="n">TweetAlias</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="c1"># Create a subquery that will calculate the maximum Tweet create_date for each</span>
<span class="c1"># user.</span>
<span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span><span class="n">TweetAlias</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">fn</span><span class="o">.</span><span class="n">MAX</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">create_date</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;max_ts&#39;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;tweet_max_subquery&#39;</span><span class="p">))</span>

<span class="c1"># Query for tweets and join using the subquery to match the tweet&#39;s user</span>
<span class="c1"># and create_date.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subquery</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span>
             <span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">create_date</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">max_ts</span><span class="p">)</span> <span class="o">&amp;</span>
             <span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">))))</span>
</pre></div>
</div>
<p>SQLite and MySQL are a bit more lax and permit grouping by a subset of the columns that are selected. This means we can do away with the subquery and express it quite concisely:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
         <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">create_date</span> <span class="o">==</span> <span class="n">fn</span><span class="o">.</span><span class="n">MAX</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">create_date</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="section" id="top-n-objects-per-group">
<span id="top-n-per-group"></span><h2>Top N objects per group<a class="headerlink" href="#top-n-objects-per-group" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>These examples describe several ways to query the top <em>N</em> items per group reasonably efficiently. For a thorough discussion of various techniques, check out my blog post <a class="reference external" href="http://charlesleifer.com/blog/querying-the-top-n-objects-per-group-with-peewee-orm/">Querying the top N objects per group with Peewee ORM</a>.</p>
<p>In these examples we will use the <em>User</em> and <em>Tweet</em> models to find each user and their three most-recent tweets.</p>
<div class="section" id="postgres-lateral-joins">
<h3>Postgres lateral joins<a class="headerlink" href="#postgres-lateral-joins" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="http://blog.heapanalytics.com/postgresqls-powerful-new-join-type-lateral/">Lateral joins</a> are a neat Postgres feature that allow reasonably efficient correlated subqueries. They are often described as SQL <code class="docutils literal"><span class="pre">for</span> <span class="pre">each</span></code> loops.</p>
<p>The desired SQL is:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t2</span><span class="p">.</span><span class="n">username</span> <span class="k">FROM</span> <span class="k">user</span> <span class="k">AS</span> <span class="n">t2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">uq</span>
   <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="k">LATERAL</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="n">t2</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">t2</span><span class="p">.</span><span class="n">create_date</span>
   <span class="k">FROM</span> <span class="n">tweet</span> <span class="k">AS</span> <span class="n">t2</span>
   <span class="k">WHERE</span> <span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">uq</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
   <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t2</span><span class="p">.</span><span class="n">create_date</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">3</span><span class="p">)</span>
  <span class="k">AS</span> <span class="n">pq</span> <span class="k">ON</span> <span class="k">true</span>
</pre></div>
</div>
<p>To accomplish this with peewee we’ll need to express the lateral join as a <code class="xref py py-class docutils literal"><span class="pre">Clause</span></code>, which gives us greater flexibility than the <a class="reference internal" href="api.html#Query.join" title="Query.join"><code class="xref py py-meth docutils literal"><span class="pre">join()</span></code></a> method.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll reference `Tweet` twice, so keep an alias handy.</span>
<span class="n">TweetAlias</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="c1"># The &quot;outer loop&quot; will be iterating over the users whose</span>
<span class="c1"># tweets we are trying to find.</span>
<span class="n">user_query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;uq&#39;</span><span class="p">)</span>

<span class="c1"># The inner loop will select tweets and is correlated to the</span>
<span class="c1"># outer loop via the WHERE clause. Note that we are using a</span>
<span class="c1"># LIMIT clause.</span>
<span class="n">tweet_query</span> <span class="o">=</span> <span class="p">(</span><span class="n">TweetAlias</span>
               <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">TweetAlias</span><span class="o">.</span><span class="n">create_date</span><span class="p">)</span>
               <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user_query</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
               <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">create_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
               <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
               <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;pq&#39;</span><span class="p">))</span>

<span class="c1"># Now we join the outer and inner queries using the LEFT LATERAL</span>
<span class="c1"># JOIN. The join predicate is *ON TRUE*, since we&#39;re effectively</span>
<span class="c1"># joining in the tweet subquery&#39;s WHERE clause.</span>
<span class="n">join_clause</span> <span class="o">=</span> <span class="n">Clause</span><span class="p">(</span>
    <span class="n">user_query</span><span class="p">,</span>
    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;LEFT JOIN LATERAL&#39;</span><span class="p">),</span>
    <span class="n">tweet_query</span><span class="p">,</span>
    <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ON </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

<span class="c1"># Finally, we&#39;ll wrap these up and SELECT from the result.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
         <span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">join_clause</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="window-functions">
<h3>ウィンドウ関数<a class="headerlink" href="#window-functions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="http://www.postgresql.org/docs/9.1/static/tutorial-window.html">Window functions</a>, which are <a class="reference internal" href="querying.html#window-functions"><span class="std std-ref">supported by peewee</span></a>, provide scalable, efficient performance.</p>
<p>The desired SQL is:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">subq</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">subq</span><span class="p">.</span><span class="n">username</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">t2</span><span class="p">.</span><span class="n">message</span><span class="p">,</span>
        <span class="n">t3</span><span class="p">.</span><span class="n">username</span><span class="p">,</span>
        <span class="n">RANK</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span>
            <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">t2</span><span class="p">.</span><span class="n">user_id</span>
            <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t2</span><span class="p">.</span><span class="n">create_date</span> <span class="k">DESC</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">rnk</span>
    <span class="k">FROM</span> <span class="n">tweet</span> <span class="k">AS</span> <span class="n">t2</span>
    <span class="k">INNER</span> <span class="k">JOIN</span> <span class="k">user</span> <span class="k">AS</span> <span class="n">t3</span> <span class="k">ON</span> <span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">t3</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">subq</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">subq</span><span class="p">.</span><span class="n">rnk</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>To accomplish this with peewee, we will wrap the ranked Tweets in an outer query that performs the filtering.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">TweetAlias</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="c1"># The subquery will select the relevant data from the Tweet and</span>
<span class="c1"># User table, as well as ranking the tweets by user from newest</span>
<span class="c1"># to oldest.</span>
<span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span><span class="n">TweetAlias</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">TweetAlias</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="n">fn</span><span class="o">.</span><span class="n">RANK</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
                    <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span><span class="p">],</span>
                    <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">create_date</span><span class="o">.</span><span class="n">desc</span><span class="p">()])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rnk&#39;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;subq&#39;</span><span class="p">))</span>

<span class="c1"># Since we can&#39;t filter on the rank, we are wrapping it in a query</span>
<span class="c1"># and performing the filtering in the outer query.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">subquery</span><span class="p">)</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">subquery</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">rnk</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="other-methods">
<h3>Other methods<a class="headerlink" href="#other-methods" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>If you’re not using Postgres, then unfortunately you’re left with options that exhibit less-than-ideal performance. For a more complete overview of common methods, check out <a class="reference external" href="http://charlesleifer.com/blog/querying-the-top-n-objects-per-group-with-peewee-orm/">this blog post</a>. Below I will summarize the approaches and the corresponding SQL.</p>
<p>Using <code class="docutils literal"><span class="pre">COUNT</span></code>, we can get all tweets where there exist less than <em>N</em> tweets with more recent timestamps:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">TweetAlias</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="c1"># Create a correlated subquery that calculates the number of</span>
<span class="c1"># tweets with a higher (newer) timestamp than the tweet we&#39;re</span>
<span class="c1"># looking at in the outer query.</span>
<span class="n">subquery</span> <span class="o">=</span> <span class="p">(</span><span class="n">TweetAlias</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">create_date</span> <span class="o">&gt;=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create_date</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">)))</span>

<span class="c1"># Wrap the subquery and filter on the count.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">subquery</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>We can achieve similar results by doing a self-join and performing the filtering in the <code class="docutils literal"><span class="pre">HAVING</span></code> clause:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">TweetAlias</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="c1"># Use a self-join and join predicates to count the number of</span>
<span class="c1"># newer tweets.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TweetAlias</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span>
             <span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="o">&amp;</span>
             <span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">create_date</span> <span class="o">&gt;=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">create_date</span><span class="p">)))</span>
         <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
         <span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">COUNT</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>The last example uses a <code class="docutils literal"><span class="pre">LIMIT</span></code> clause in a correlated subquery.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">TweetAlias</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="c1"># The subquery here will calculate, for the user who created the</span>
<span class="c1"># tweet in the outer loop, the three newest tweets. The expression</span>
<span class="c1"># will evaluate to `True` if the outer-loop tweet is in the set of</span>
<span class="c1"># tweets represented by the inner query.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tweet</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
         <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="p">(</span>
             <span class="n">TweetAlias</span>
             <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
             <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
             <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">TweetAlias</span><span class="o">.</span><span class="n">create_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
             <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-custom-functions-with-sqlite">
<h2>Writing custom functions with SQLite<a class="headerlink" href="#writing-custom-functions-with-sqlite" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>SQLite is very easy to extend with custom functions written in Python, that are then callable from your SQL statements. By using the <a class="reference internal" href="playhouse.html#SqliteExtDatabase" title="SqliteExtDatabase"><code class="xref py py-class docutils literal"><span class="pre">SqliteExtDatabase</span></code></a> and the <a class="reference internal" href="playhouse.html#SqliteExtDatabase.func" title="SqliteExtDatabase.func"><code class="xref py py-meth docutils literal"><span class="pre">func()</span></code></a> decorator, you can very easily define your own functions.</p>
<p>Here is an example function that generates a hashed version of a user-supplied password. We can also use this to implement <code class="docutils literal"><span class="pre">login</span></code> functionality for matching a user and password.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">playhouse.sqlite_ext</span> <span class="kn">import</span> <span class="n">SqliteExtDatabase</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteExtDatabase</span><span class="p">(</span><span class="s1">&#39;my-blog.db&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_hexdigest</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">raw_password</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">salt</span> <span class="o">+</span> <span class="n">raw_password</span>
    <span class="k">return</span> <span class="n">sha1</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="nd">@db.func</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">make_password</span><span class="p">(</span><span class="n">raw_password</span><span class="p">):</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">get_hexdigest</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="p">()))[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">hsh</span> <span class="o">=</span> <span class="n">get_hexdigest</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">raw_password</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">$</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">hsh</span><span class="p">)</span>

<span class="nd">@db.func</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="n">raw_password</span><span class="p">,</span> <span class="n">enc_password</span><span class="p">):</span>
    <span class="n">salt</span><span class="p">,</span> <span class="n">hsh</span> <span class="o">=</span> <span class="n">enc_password</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hsh</span> <span class="o">==</span> <span class="n">get_hexdigest</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">raw_password</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is how you can use the function to add a new user, storing a hashed password:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
    <span class="n">username</span><span class="o">=</span><span class="s1">&#39;charlie&#39;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">make_password</span><span class="p">(</span><span class="s1">&#39;testing&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>If we retrieve the user from the database, the password that’s stored is hashed and salted:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;charlie&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
<span class="go">b76fa$88be1adcde66a1ac16054bc17c8a297523170949</span>
</pre></div>
</div>
<p>To implement <code class="docutils literal"><span class="pre">login</span></code>-type functionality, you could write something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">User</span>
                <span class="o">.</span><span class="n">select</span><span class="p">()</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
                <span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="c1"># Incorrect username and/or password.</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="api.html" class="btn btn-neutral" title="APIリファレンス" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright charles leifer.

    </p>
  </div>
 

<div role="contentinfo">
<p>このサイトは<a href="http://a-zumi.net">あずみ.net</a>が翻訳しております。</p>
<p>サイトを利用したことによる直接的、付随的、結果的、間接的、あるいは懲罰的な損害、経費、損失、または
債務について、いかなる責任も負いかねます。</p>
</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.10.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23705195-42"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-23705195-42');
</script>


</body>
</html>